<!DOCTYPE html>
<html lang="es">
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Cesta Control de Stock</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
      /* Ajuste para que las alertas no se vean gigantes */
      .swal2-popup { font-size: 0.9rem !important; }
      /* =========================================
         üé® PALETA DE COLORES CESTA
      ========================================= */
      :root {
          --color-primary: #E06920; 
          --color-primary-hover: #BF5210;
          --bg-light-tone: #f8f9fa;
          --text-dark: #333333;
      }

      body { 
          background-color: var(--bg-light-tone); 
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
          /* Mejora el scroll en m√≥viles */
          overflow-x: hidden; 
          -webkit-overflow-scrolling: touch;
      }

      /* UTILIDADES */
      .bg-brand { background-color: var(--color-primary) !important; }
      .text-brand { color: var(--color-primary) !important; }
      .border-brand { border-color: var(--color-primary) !important; }
      
      .btn-brand { background-color: var(--color-primary); border-color: var(--color-primary); color: white; }
      .btn-brand:hover { background-color: var(--color-primary-hover); border-color: var(--color-primary-hover); color: white; }
      
      .btn-outline-brand { color: var(--color-primary); border-color: var(--color-primary); }
      .btn-outline-brand:hover { background-color: var(--color-primary); color: white; }

      .nav-link-desktop { color: #333; cursor: pointer; padding: 10px 15px; border-radius: 8px; margin-bottom: 2px; text-decoration: none; display: block; transition: all 0.2s; }
      .nav-link-desktop:hover { background-color: #fff4e6; color: var(--color-primary); }
      .nav-link-desktop.active { background-color: var(--color-primary) !important; color: white !important; box-shadow: 0 4px 6px rgba(224, 105, 32, 0.2); }

      .logo-img { height: 40px; width: auto; object-fit: contain; border-radius: 4px; background: white; padding: 2px; }

      /* LAYOUT */
      .sidebar { min-height: 100vh; background-color: #ffffff; border-right: 1px solid #dee2e6; }
      .bottom-nav { background-color: white; border-top: 1px solid #dee2e6; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
      
      /* Estilos Barra M√≥vil */
      .nav-item-mobile { 
          flex: 1; 
          text-align: center; 
          padding: 12px 0; /* M√°s espacio para el dedo */
          color: #adb5bd; 
          cursor: pointer; 
          text-decoration: none; 
          transition: color 0.2s; 
          display: flex;           /* Flexbox para alinear */
          flex-direction: column;  /* Uno encima del otro */
          align-items: center;
          justify-content: center;
      }
      
      .nav-item-mobile i { 
          font-size: 1.6rem; /* Aumentado de tama√±o (antes era aprox 1rem) */
          margin-bottom: 2px;
          line-height: 1;
      }
      
      .nav-item-mobile span {
          font-size: 0.75rem; /* Texto un poco m√°s legible */
          font-weight: 500;
      }

      .nav-item-mobile.active { 
          color: var(--color-primary); 
      }
      /* Efecto de pulsaci√≥n */
      .nav-item-mobile:active i {
          transform: scale(0.9); 
      }

      /* Estilos Men√∫ Lateral M√≥vil (Offcanvas) */
      .offcanvas-body .btn { font-weight: 500; color: #444; transition: background 0.2s; border-color: #eee; }
      .offcanvas-body .btn:active, .offcanvas-body .btn:focus { background-color: #fff4e6; border-color: var(--color-primary); color: var(--color-primary); }

      @media (max-width: 767.98px) { .main-content { padding-bottom: 90px !important; } }

      .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction: column; }
      
      /* ESTILOS ESPECIFICOS PRODUCTO */
      .img-producto-card { height: 180px; width: 100%; background-color: #ffffff; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #f0f0f0; position: relative; }
      .img-producto-card img { width: 100%; height: 100%; object-fit: contain; padding: 15px; }
      .card { transition: transform 0.2s; border: none; }
      .no-hover:hover { transform: none; }

      .login-bg {
          background-color: #f8f9fa;
          /* Usamos tu variable --color-primary con transparencia para los puntos */
          background-image: radial-gradient(rgba(224, 105, 32, 0.2) 1px, transparent 1px);
          background-size: 20px 20px;
      }

      .input-dots::placeholder {
          overflow: hidden;
          white-space: nowrap;
          text-overflow: clip; /* Corta los puntos extra sin poner "..." */
          letter-spacing: 2px; /* Opcional: separa los puntos para llenar m√°s r√°pido */
      }

      .user-icon-brand {
          background-color: var(--color-primary);
          transition: background-color 0.3s ease;
          cursor: default; /* O pointer si planeas hacerlo clicable */
      }

      .user-icon-brand:hover {
          background-color: var(--color-primary-hover);
      }

      /* Estilo Bot√≥n Men√∫ M√≥vil */
      .nav-mobile-btn {
          width: 100%;
          text-align: left;
          background: transparent;
          border: none;
          padding: 15px 20px;
          color: #555;
          font-weight: 500;
          border-left: 4px solid transparent; /* Borde invisible para efecto activo */
          transition: all 0.2s;
          display: flex;
          align-items: center;
      }

      .nav-mobile-btn i {
          font-size: 1.2rem;
          margin-right: 15px;
          color: #adb5bd; /* Gris por defecto */
          transition: color 0.2s;
      }

      /* Estado Activo (Naranja) */
      .nav-mobile-btn.active {
          background-color: #fff4e6; /* Fondo naranja muy suave */
          color: var(--color-primary);
          border-left-color: var(--color-primary); /* Borde naranja a la izquierda */
      }

      .nav-mobile-btn.active i {
          color: var(--color-primary); /* Icono naranja */
      }

      /* =======================================================
         üñ®Ô∏è ESTILOS CR√çTICOS DE IMPRESI√ìN (SOLUCI√ìN DEFINITIVA)
      ======================================================= */
      
      /* 1. REGLA CLAVE: Ocultar el footer SIEMPRE en pantalla normal */
      .report-footer {
          display: none !important;
      }

      /* 2. Reglas que solo aplican al imprimir/PDF */
      @media print {
          /* Ocultar todo lo que no sea el reporte */
          .sidebar, .navbar, .btn, .card-header button, .form-control, .form-select, label, .d-print-none {
              display: none !important;
          }
          
          /* Expandir el contenido al 100% del papel */
          main, .container-fluid, .card, .card-body {
              margin: 0 !important;
              padding: 0 !important;
              width: 100% !important;
              max-width: 100% !important;
              box-shadow: none !important;
              border: none !important;
              background-color: white !important;
          }

          /* Footer de Reporte: FORZAR APARICI√ìN AL IMPRIMIR */
          .report-footer {
              display: block !important; /* <--- Esto revive el footer */
              position: fixed;
              bottom: 0;
              left: 0;
              width: 100%;
              text-align: center;
              padding: 10px;
              background: white;
              border-top: 1px solid #ddd;
              z-index: 9999;
          }
          
          /* Ajuste de Tabla para papel */
          table { font-size: 10pt; width: 100%; }
          th { background-color: #f8f9fa !important; color: black !important; -webkit-print-color-adjust: exact; }
      }

</style>
</head>
<body>
    <div id="app" class="d-flex h-100 flex-column">
          <div v-if="!usuarioLogueado" class="position-fixed top-0 start-0 w-100 h-100 login-bg d-flex align-items-center justify-content-center" style="z-index: 9999;">  
            <div class="card border-0 shadow-lg" style="width: 100%; max-width: 400px; border-top: 5px solid var(--color-primary);">
                <div class="card-body p-5">

                    <div class="text-center mb-4">                       
                        <h4 class="fw-bold text-dark mb-1"><img src="https://drive.google.com/thumbnail?id=15DzlDGz-7Wr1Z0kLAHqBuKSX6QIyvuBf&sz=w900" alt="CESTA Logo" class="logo-img"> Bienvenido</h4>
                        <p class="text-muted small">Ingresa tus credenciales para acceder</p>
                    </div>

                    <form @submit.prevent="iniciarSesion">
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-secondary">Usuario</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="bi bi-person text-brand"></i></span>
                                <input type="text" class="form-control border-start-0 ps-0 bg-light" v-model="loginData.usuario" placeholder="" required>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold small text-secondary">Contrase√±a</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="bi bi-lock text-brand"></i></span>
                                <input type="password" class="form-control border-start-0 ps-0 bg-light" v-model="loginData.password" placeholder="" required>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-brand btn-lg shadow-sm fw-bold">
                                Iniciar Sesi√≥n
                            </button>
                        </div>
                    </form>

                    <div class="mt-4 text-center border-top pt-3">
                        <small class="text-muted d-block" style="font-size: 0.75rem;">
                            ¬© 2024 Cesta ERP ‚Ä¢ Control de Stock
                        </small>
                    </div>
                </div>
            </div>
        </div>

      <div class="modal fade" id="modalDetalle" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Detalle de la Operaci√≥n</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <table class="table table-striped mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">Producto</th>
                            <th class="text-center">Cant.</th>
                            <th class="text-end">Precio</th>
                            <th class="text-end pe-3">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="it in itemsDetalle" :key="it.producto">
                            <td class="ps-3">{{ it.producto }}</td>
                            <td class="text-center">{{ it.cantidad }}</td>
                            <td class="text-end">{{ formatoMoneda(it.precio) }}</td>
                            <td class="text-end pe-3 fw-bold">{{ formatoMoneda(it.subtotal) }}</td>
                        </tr>
                        
                        <tr v-if="itemsDetalle.length === 0">
                            <td colspan="4" class="text-center py-4 text-muted">
                                <i class="bi bi-info-circle me-1"></i> No hay items para mostrar o est√° cargando...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer bg-light py-1">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>
      </div>
      <div v-if="cargando" class="loading-overlay">
        <div class="spinner-border text-brand mb-2" role="status" style="width: 3rem; height: 3rem;"></div>
        <div class="text-muted fw-bold">Procesando...</div>
      </div>

      <nav class="navbar navbar-dark bg-brand shadow sticky-top z-3">
        <div class="container-fluid">
          
          <div class="d-flex align-items-center" 
               style="cursor: pointer;" 
               @click="vistaActual = 'dashboard'; cargarDashboard()">
               
              <img src="https://drive.google.com/thumbnail?id=15DzlDGz-7Wr1Z0kLAHqBuKSX6QIyvuBf&sz=w900" alt="CESTA Logo" class="logo-img me-2"> <span class="fw-bold text-white fs-5">CESTA Control de Stock</span>
          </div>

        </div>
      </nav>

      <div class="container-fluid">
        <div class="row">         
          <div class="col-md-2 sidebar p-3 d-none d-md-block shadow-sm z-2 d-flex flex-column justify-content-between" style="min-height: 100vh;">
            <div>
                <a class="nav-link-desktop mb-2" :class="{active: vistaActual === 'dashboard'}" @click="vistaActual = 'dashboard'; cargarDashboard()">
                    <i class="bi bi-house-door me-2"></i> Inicio
                </a>

                <small v-if="tengoAlgunPermiso(['remisiones','ventas','compras','gastos','transferencias','cobranzas'])" 
                       class="text-muted text-uppercase fw-bold ps-2 mb-2 mt-2 d-block" style="font-size: 0.7rem;">
                    Operaciones
                </small>
                
                <a v-if="tengoPermiso('remisiones')" class="nav-link-desktop" :class="{active: vistaActual === 'remisiones'}" @click="cambiarVista('remisiones')">
                    <i class="bi bi-truck-flatbed me-2"></i> Notas de Remisi√≥n
                </a>
                
                <a v-if="tengoPermiso('ventas')" class="nav-link-desktop" :class="{active: vistaActual === 'ventas'}" @click="cambiarVista('ventas')">
                    <i class="bi bi-receipt me-2"></i> Ventas / Caja
                </a>
                
                <a v-if="tengoPermiso('compras')" class="nav-link-desktop" :class="{active: vistaActual === 'compras'}" @click="cambiarVista('compras')">
                    <i class="bi bi-cart-plus me-2"></i> Compras / Stock
                </a>
                
                <a v-if="tengoPermiso('gastos')" class="nav-link-desktop" :class="{active: vistaActual === 'gastos'}" @click="cambiarVista('gastos')">
                    <i class="bi bi-cash-stack me-2"></i> Gastos Operativos
                </a>
                
                <a v-if="tengoPermiso('transferencias')" class="nav-link-desktop" :class="{active: vistaActual === 'transferencias'}" @click="cambiarVista('transferencias')">
                    <i class="bi bi-arrow-left-right me-2"></i> Transferencias
                </a>
                
                <a v-if="tengoPermiso('cobranzas')" class="nav-link-desktop" :class="{active: vistaActual === 'cobranzas'}" @click="cargarCobranzas()">
                    <i class="bi bi-wallet2 me-2"></i> Cobranzas
                </a>

                <small v-if="tengoAlgunPermiso(['productos','clientes','proveedores'])" 
                       class="text-muted text-uppercase fw-bold ps-2 mb-2 mt-3 d-block" style="font-size: 0.7rem;">
                    Gesti√≥n
                </small>
                
                <a v-if="tengoPermiso('productos')" class="nav-link-desktop" :class="{active: vistaActual === 'productos'}" @click="cambiarVista('productos')">
                    <i class="bi bi-box-seam me-2"></i> Inventario
                </a>
                
                <a v-if="tengoPermiso('clientes')" class="nav-link-desktop" :class="{active: vistaActual === 'clientes'}" @click="cambiarVista('clientes')">
                    <i class="bi bi-people me-2"></i> Clientes
                </a>
                
                <a v-if="tengoPermiso('proveedores')" class="nav-link-desktop" :class="{active: vistaActual === 'proveedores'}" @click="cambiarVista('proveedores')">
                    <i class="bi bi-truck me-2"></i> Proveedores
                </a>

                <small v-if="tengoAlgunPermiso(['reportes','usuarios','config'])" 
                       class="text-muted text-uppercase fw-bold ps-2 mb-2 mt-3 d-block" style="font-size: 0.7rem;">
                    Sistema
                </small>
                
                <a v-if="tengoPermiso('reportes')" class="nav-link-desktop" :class="{active: vistaActual === 'reportes'}" @click="cambiarVista('reportes')">
                    <i class="bi bi-file-earmark-bar-graph me-2"></i> Reportes
                </a>
                
                <a v-if="tengoPermiso('usuarios')" class="nav-link-desktop" :class="{active: vistaActual === 'usuarios'}" @click="cambiarVista('usuarios')">
                    <i class="bi bi-person-badge me-2"></i> Usuarios
                </a>
                
                <a v-if="tengoPermiso('config')" class="nav-link-desktop" :class="{active: vistaActual === 'config'}" @click="cambiarVista('config')">
                    <i class="bi bi-gear me-2"></i> Configuraci√≥n
                </a>
            </div>

            <div class="mt-4 pt-3 border-top">
                <div class="d-flex align-items-center justify-content-between px-2 mb-2">
                    
                    <div class="d-flex align-items-center overflow-hidden" 
                         style="cursor: pointer;" 
                         @click="vistaActual = 'perfil'; cargarPerfil()" 
                         title="Editar mi perfil">
                        
                        <div class="user-icon-brand text-white rounded-circle d-flex align-items-center justify-content-center me-2 overflow-hidden" 
                             style="width: 32px; height: 32px; min-width: 32px;">
                            
                            <img v-if="usuarioLogueado && usuarioLogueado.avatar" 
                                 :src="usuarioLogueado.avatar" 
                                 style="width: 100%; height: 100%; object-fit: cover;">
                            
                            <i v-else class="bi bi-person-fill"></i>
                        </div>
                        
                        <div class="small fw-bold text-truncate" v-if="usuarioLogueado">
                            {{ usuarioLogueado.nombre }}
                        </div>
                    </div>
                    
                    <button class="btn btn-sm btn-outline-danger border-0" @click="logout" title="Cerrar Sesi√≥n">
                        <i class="bi bi-box-arrow-right fs-6"></i>
                    </button>
                </div>
            </div>
        </div>

            <div class="col-md-10 p-4 bg-light min-vh-100 main-content">
                
                <div v-if="vistaActual === 'ventas'">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="fw-bold text-dark mb-0"><i class="bi bi-receipt text-brand"></i> Punto de Venta</h3>
                        <div class="btn-group shadow-sm">
                            <button class="btn" :class="subVistaVentas === 'nueva' ? 'btn-brand' : 'btn-white bg-white text-secondary border'" @click="subVistaVentas = 'nueva'"><i class="bi bi-plus-lg"></i> Nueva Venta</button>
                            <button class="btn" :class="subVistaVentas === 'historial' ? 'btn-brand' : 'btn-white bg-white text-secondary border'" @click="cargarHistorialVentas"><i class="bi bi-clock-history"></i> Historial</button>
                        </div>
                    </div>

                      <div v-if="subVistaVentas === 'nueva'">
                        <div class="card border-0 shadow-sm mb-3 no-hover">
                            <div class="card-body">
                                <div class="row g-3 align-items-end">
                                    
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Cliente</label>
                                        <div class="input-group">
                                            <select class="form-select" v-model="formVenta.id_cliente">
                                                <option value="" disabled>Seleccionar cliente...</option>
                                                <option v-for="c in clientes" :value="c.id_cliente">{{ c.razon_social }}</option>
                                            </select>
                                            <button class="btn btn-outline-secondary" type="button" @click="abrirModalCliente(null)" title="Crear Nuevo Cliente">
                                                <i class="bi bi-person-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Desde Dep√≥sito</label>
                                        <select class="form-select text-brand fw-bold" v-model="formVenta.id_deposito">
                                            <option v-for="d in listaDepositos" :value="d.id_deposito">{{ d.nombre }}</option>
                                        </select>
                                    </div>

                                    <div class="col-md-2">
                                        <label class="form-label fw-bold">Condici√≥n</label>
                                        <select class="form-select" v-model="formVenta.condicion">
                                            <option value="CONTADO">Contado</option>
                                            <option value="CREDITO">Cr√©dito</option>
                                        </select>
                                    </div>

                                    <div class="col-md-2">
                                        <label class="form-label fw-bold">Fecha</label>
                                        <input type="date" class="form-control" v-model="formVenta.fecha">
                                    </div>
                                    
                                    <div class="col-md-2">
                                        <label class="form-label fw-bold">N¬∫ Factura</label>
                                        <input type="text" 
                                               class="form-control" 
                                               v-model="formVenta.nro_factura" 
                                               placeholder="Autom√°tico">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm mb-3 no-hover border-brand border-top border-3">
                            <div class="card-body bg-light">
                                <form @submit.prevent="agregarAlCarritoVenta">
                                    <div class="row g-2 align-items-end">
                                        <div class="col-md-6">
                                        <label class="form-label small fw-bold">Producto</label>
                                        <div class="input-group">
                                            <button class="btn btn-dark" type="button" @click="abrirEscaner" title="Escanear C√≥digo de Barras">
                                                <i class="bi bi-qr-code-scan"></i>
                                            </button>
                                            
                                            <select class="form-select form-select-lg" v-model="lineaVenta.id_producto" required @change="alSeleccionarProductoVenta">
                                                <option value="" disabled>üîç Buscar o Escanear...</option>
                                                <option v-for="p in productos" :value="p.id_producto" :disabled="(p.stock_actual||0) <= 0">
                                                    {{ p.nombre }} | Stock: {{ p.stock_actual || 0 }} | {{ formatoMoneda(p.precio_venta_base) }}
                                                </option>
                                            </select>
                                        </div>
                                    </div>

                                        <div class="col-md-2 col-4">
                                            <label class="form-label small">Cantidad</label>
                                            <input type="number" class="form-control form-control-lg" v-model.number="lineaVenta.cantidad" min="1" required>
                                        </div>
                                        <div class="col-md-2 col-8">
                                            <label class="form-label small">Precio Unit.</label>
                                            <input type="number" class="form-control form-control-lg" v-model.number="lineaVenta.precio" min="0" required>
                                        </div>
                                        <div class="col-md-2 d-grid">
                                            <button type="submit" class="btn btn-brand btn-lg fw-bold"><i class="bi bi-cart-plus"></i></button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm no-hover">
                            <div class="table-responsive">
                                <table class="table align-middle mb-0 table-striped">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Producto</th>
                                            <th class="text-center">Cant.</th>
                                            <th class="text-end">Precio</th>
                                            <th class="text-end">Subtotal</th>
                                            <th style="width: 50px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="(item, index) in carritoVenta" :key="index">
                                            <td class="fw-bold text-secondary">{{ obtenerNombreProducto(item.id_producto) }}</td>
                                            <td class="text-center">{{ item.cantidad }}</td>
                                            <td class="text-end">{{ formatoMoneda(item.precio) }}</td>
                                            <td class="text-end fw-bold">{{ formatoMoneda(item.cantidad * item.precio) }}</td>
                                            <td>
                                                <button class="btn btn-sm text-danger" @click="quitarDelCarritoVenta(index)"><i class="bi bi-trash"></i></button>
                                            </td>
                                        </tr>
                                        <tr v-if="carritoVenta.length === 0">
                                            <td colspan="5" class="text-center py-5 text-muted">Carrito vac√≠o, agrega productos arriba.</td>
                                        </tr>
                                    </tbody>
                                    <tfoot v-if="carritoVenta.length > 0">
                                        <tr class="text-muted small">
                                            <td colspan="3" class="text-end border-0 pt-3">Liquidaci√≥n IVA:</td>
                                            <td class="text-end border-0 pt-3">{{ formatoMoneda(totalIVA) }}</td>
                                            <td class="border-0"></td>
                                        </tr>
                                        <tr class="bg-brand text-white">
                                            <td colspan="3" class="text-end fw-bold fs-5 border-0">TOTAL A PAGAR:</td>
                                            <td class="text-end fw-bold fs-3 border-0">{{ formatoMoneda(totalVenta) }}</td>
                                            <td class="border-0"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <div class="card-footer bg-white p-3 text-end" v-if="carritoVenta.length > 0">
                                <button class="btn btn-outline-secondary me-2" @click="limpiarCarritoVenta">Cancelar</button>
                                <button class="btn btn-success btn-lg fw-bold px-5 shadow" @click="guardarVentaFinal">
                                    <i class="bi bi-cash-coin me-2"></i> COBRAR
                                </button>
                            </div>
                        </div>

                    </div>

                    <div v-if="subVistaVentas === 'historial'">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group shadow-sm">
                                    <span class="input-group-text bg-white border-end-0">
                                        <i class="bi bi-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-start-0 ps-0" 
                                          v-model="busquedaVenta" 
                                          placeholder="Buscar por cliente o factura...">
                                    <button v-if="busquedaVenta" class="btn btn-outline-secondary" @click="busquedaVenta = ''">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card border-0 shadow-sm">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="ps-3">Fecha</th>
                                            <th>Cliente</th>
                                            <th>Factura</th>
                                            <th class="text-center">Condici√≥n</th>
                                            <th class="text-end">Total</th>
                                            <th class="text-center">Estado</th>
                                            <th class="text-end pe-3">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="h in ventasFiltradas" :key="h.id_venta">
                                            <td class="ps-3 text-muted small">{{ new Date(h.fecha).toLocaleDateString() }}</td>
                                            <td class="fw-bold">{{ h.nombre_cliente }}</td>
                                            <td><span class="badge bg-light text-dark border">{{ h.factura }}</span></td>
                                            <td class="text-center">
                                                <span class="badge" :class="h.condicion === 'CREDITO' ? 'bg-warning text-dark border' : 'bg-info bg-opacity-10 text-primary border border-primary'">
                                                    {{ h.condicion }}
                                                </span>
                                            </td>
                                            <td class="text-end fw-bold text-success">{{ formatoMoneda(h.total) }}</td>
                                            <td class="text-center">
                                                <span v-if="h.estado === 'ANULADO'" class="badge bg-danger">ANULADO</span>
                                                <span v-else-if="h.estado === 'PENDIENTE'" class="badge bg-warning text-dark">PENDIENTE</span>
                                                <span v-else class="badge bg-success">PAGADO</span>
                                            </td>
                                            <td class="text-end pe-3">
                                                <button class="btn btn-sm btn-outline-dark me-1" @click="imprimirTicket(h)" title="Imprimir Ticket T√©rmico"><i class="bi bi-printer-fill"></i></button>
                                                <a v-if="h.url_pdf" :href="h.url_pdf" target="_blank" class="btn btn-sm btn-outline-secondary me-1" title="Ver Factura PDF"><i class="bi bi-file-earmark-pdf"></i></a>
                                                <button class="btn btn-sm btn-outline-primary me-1" @click="verDetalleVenta(h)" title="Ver productos">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button v-if="h.estado !== 'ANULADO'" class="btn btn-sm btn-outline-danger" @click="anularVenta(h)" title="Anular venta">
                                                    <i class="bi bi-slash-circle"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="vistaActual === 'perfil'">
                    <div class="row justify-content-center g-4">
                        
                        <div class="col-md-6">
                            <h5 class="fw-bold mb-3 text-secondary">
                                <i class="bi bi-person-badge me-2"></i>Informaci√≥n Personal
                            </h5>
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body p-4">
                                    <form @submit.prevent="guardarDatosPersonales">
                                        
                                        <div class="text-center mb-4">
                                            <div class="d-inline-block position-relative">
                                                <img v-if="perfilForm.avatar" :src="perfilForm.avatar" class="rounded-circle border border-3 border-white shadow" style="width: 100px; height: 100px; object-fit: cover;">
                                                <div v-else class="bg-brand text-white rounded-circle d-flex align-items-center justify-content-center shadow" style="width: 100px; height: 100px;">
                                                    <i class="bi bi-person-fill display-4"></i>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-4 text-center">
                                            <label class="form-label small fw-bold text-muted mb-2">Cambiar Avatar</label>
                                            <div class="d-flex flex-wrap gap-2 justify-content-center bg-light p-2 rounded">
                                                <div class="rounded-circle d-flex align-items-center justify-content-center border bg-white" @click="perfilForm.avatar = ''" style="width: 35px; height: 35px; cursor: pointer;">
                                                    <i class="bi bi-person-x text-muted"></i>
                                                </div>
                                                <img v-for="img in avataresDisponibles" :src="img" class="rounded-circle border bg-white" @click="perfilForm.avatar = img" style="width: 35px; height: 35px; cursor: pointer;">
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label small fw-bold">Nombre Completo</label>
                                            <input type="text" class="form-control" v-model="perfilForm.nombre" required>
                                        </div>

                                        <button type="submit" class="btn btn-brand w-100 fw-bold">Guardar Cambios</button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-5">
                            <h5 class="fw-bold mb-3 text-secondary">
                                <i class="bi bi-shield-lock me-2"></i>Seguridad
                            </h5>
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body p-4">
                                    <p class="small text-muted mb-4">
                                        Para tu seguridad, debes ingresar tu contrase√±a actual para establecer una nueva.
                                    </p>
                                    
                                    <form @submit.prevent="cambiarPassword">
                                        
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold">Contrase√±a Actual</label>
                                            <div class="input-group">
                                                <span class="input-group-text bg-light border-end-0"><i class="bi bi-key"></i></span>
                                                <input type="password" class="form-control border-start-0 ps-0 bg-light" v-model="passForm.actual" required placeholder="">
                                            </div>
                                        </div>

                                        <hr class="my-4">

                                        <div class="mb-3">
                                            <label class="form-label small fw-bold">Nueva Contrase√±a</label>
                                            <input type="password" class="form-control" v-model="passForm.nueva" required minlength="4">
                                        </div>

                                        <div class="mb-4">
                                            <label class="form-label small fw-bold">Confirmar Nueva</label>
                                            <input type="password" class="form-control" v-model="passForm.confirmacion" required>
                                            <div class="form-text text-danger small" v-if="passForm.nueva !== passForm.confirmacion && passForm.confirmacion">
                                                Las contrase√±as no coinciden.
                                            </div>
                                        </div>

                                        <button type="submit" class="btn btn-brand w-100 fw-bold" 
                                                :disabled="!passForm.actual || !passForm.nueva || passForm.nueva !== passForm.confirmacion">
                                            Actualizar Contrase√±a
                                        </button>

                                    </form>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div v-if="vistaActual === 'reportes'">
    
                  <div class="d-flex justify-content-between align-items-center mb-4">
                      <h3 class="fw-bold text-dark mb-0"><i class="bi bi-file-earmark-bar-graph me-2 text-brand"></i>Reportes</h3>
                  </div>

                  <div class="card border-0 shadow-sm mb-4 d-print-none">
                      <div class="card-body bg-light rounded">
                          <form @submit.prevent="cargarReporte" class="row g-3 align-items-end">
                              
                              <div class="col-md-4">
                                  <label class="form-label small fw-bold">Seleccionar Reporte</label>
                                  <select class="form-select" v-model="reporteForm.tipo" required>
                                      <optgroup label="Movimientos">
                                          <option value="ventas">Ventas</option>
                                          <option value="compras">Compras</option>
                                          <option value="gastos">Gastos</option>
                                          <option value="cobranzas">Cobranzas</option>
                                          <option value="transferencias">Transferencias</option>
                                          <option value="ajustes">Ajustes de Inventario</option>
                                          <option value="remisiones">Notas de Remisi√≥n</option>
                                      </optgroup>
                                      <optgroup label="Inventario y Stock">
                                          <option value="stock_deposito">Stock por Dep√≥sito</option>
                                          <option value="productos_categoria">Productos por Categor√≠a</option>
                                      </optgroup>
                                      <optgroup label="Listados Maestros">
                                          <option value="clientes">Listado de Clientes</option>
                                          <option value="proveedores">Listado de Proveedores</option>
                                      </optgroup>
                                  </select>
                              </div>

                              <div class="col-md-3" v-if="usaFiltroFecha">
                                  <label class="form-label small fw-bold">Desde</label>
                                  <input type="date" class="form-control" v-model="reporteForm.fechaInicio" required>
                              </div>

                              <div class="col-md-3" v-if="usaFiltroFecha">
                                  <label class="form-label small fw-bold">Hasta</label>
                                  <input type="date" class="form-control" v-model="reporteForm.fechaFin" required>
                              </div>

                              <div class="col-md-2">
                                  <button type="submit" class="btn btn-brand w-100 fw-bold" :disabled="cargando">
                                      <i class="bi bi-search me-2"></i>Ver
                                  </button>
                              </div>
                          </form>
                      </div>
                  </div>

                  <div v-if="reporteData.filas.length > 0">
                      
                      <div class="mb-3 text-center">
                          <h4 class="fw-bold text-uppercase mb-1">Reporte de {{ reporteForm.tipo.replace('_', ' ') }}</h4>
                          <p class="text-muted small mb-0" v-if="usaFiltroFecha">
                              Del {{ formatoFecha(reporteForm.fechaInicio) }} al {{ formatoFecha(reporteForm.fechaFin) }}
                          </p>
                          <p class="text-muted small mb-0" v-else>Generado el {{ formatoFecha(new Date()) }}</p>
                      </div>

                      <div class="d-flex justify-content-end gap-2 mb-3 d-print-none">
                          <button class="btn btn-outline-success btn-sm" @click="exportarCSV">
                              <i class="bi bi-filetype-csv me-2"></i>Descargar CSV
                          </button>
                          <button class="btn btn-outline-danger btn-sm" onclick="window.print()">
                              <i class="bi bi-file-pdf me-2"></i>Imprimir / PDF
                          </button>
                      </div>

                      <div class="table-responsive bg-white border rounded">
                          <table class="table table-striped table-hover mb-0" id="tablaReporte">
                              <thead class="bg-dark text-white">
                                  <tr>
                                      <th v-for="(col, index) in reporteData.cabeceras" :key="index" class="text-nowrap small">
                                          {{ col }}
                                      </th>
                                  </tr>
                              </thead>
                              <tbody>
                                  <tr v-for="(fila, i) in reporteData.filas" :key="i">
                                      <td v-for="(celda, j) in fila" :key="j" class="small">
                                          {{ esDinero(celda, j) ? formatoMoneda(celda) : celda }}
                                      </td>
                                  </tr>
                              </tbody>
                              <tfoot v-if="reporteData.totales.suma > 0" class="bg-light fw-bold border-top">
                                  <tr>
                                      <td :colspan="reporteData.cabeceras.length - 1" class="text-end">TOTAL:</td>
                                      <td>{{ formatoMoneda(reporteData.totales.suma) }}</td>
                                  </tr>
                              </tfoot>
                          </table>
                      </div>

                      <div class="report-footer">
                          <div class="d-flex align-items-center justify-content-center opacity-50">
                              <h5 class="fw-bold text-brand m-0 me-2"><i class="bi bi-basket2-fill"></i> CESTA ERP</h5>
                              <small>Sistema de Gesti√≥n Integral</small>
                          </div>
                          <div class="small mt-2">P√°gina 1 de 1 - Reporte generado por {{ usuarioLogueado.nombre }}</div>
                      </div>

                  </div>

                  <div v-else-if="reporteBuscado && !cargando" class="text-center py-5">
                      <i class="bi bi-clipboard-x text-muted display-1"></i>
                      <p class="text-muted mt-3">No hay datos disponibles para este reporte.</p>
                  </div>
              </div>

                <div v-if="vistaActual === 'dashboard'">
                    
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
                        <div class="mb-3 mb-md-0">
                            <h3 class="fw-bold text-dark mb-0">
                                Hola, <span class="text-brand">{{ usuarioLogueado ? usuarioLogueado.nombre.split(' ')[0] : 'Usuario' }}</span> üëã
                            </h3>
                            <small class="text-muted">Resumen de actividad al {{ fechaHoy }}</small>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button v-if="tengoPermiso('gastos')" class="btn btn-light border shadow-sm fw-bold text-muted" @click="cambiarVista('gastos')">
                                <i class="bi bi-dash-circle me-2 text-danger"></i>Gasto
                            </button>
                            <button v-if="tengoPermiso('ventas')" class="btn btn-brand shadow fw-bold px-4" @click="cambiarVista('ventas')">
                                <i class="bi bi-plus-lg me-2"></i>Nueva Venta
                            </button>
                        </div>
                    </div>

                    <div class="row g-3 mb-4" v-if="tengoPermiso('reportes') || tengoPermiso('ventas')">
                        
                        <div class="col-6 col-md-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Ventas Hoy</small>
                                            <h4 class="fw-bold text-dark mt-2 mb-0">{{ formatoMoneda(dashboardData.kpi.ventasHoy) }}</h4>
                                        </div>
                                        <div class="bg-success bg-opacity-10 text-success rounded p-2">
                                            <i class="bi bi-currency-dollar"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-6 col-md-3">
                            <div class="card border-0 shadow-sm h-100 border-start border-4 border-brand">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Ventas Mes</small>
                                            <h4 class="fw-bold text-brand mt-2 mb-0">{{ formatoMoneda(dashboardData.kpi.ventasMes) }}</h4>
                                        </div>
                                        <div class="bg-brand bg-opacity-10 text-brand rounded p-2">
                                            <i class="bi bi-graph-up"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-6 col-md-3" v-if="tengoPermiso('gastos')">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Gastos Mes</small>
                                            <h4 class="fw-bold text-danger mt-2 mb-0">{{ formatoMoneda(dashboardData.kpi.gastosMes) }}</h4>
                                        </div>
                                        <div class="bg-danger bg-opacity-10 text-danger rounded p-2">
                                            <i class="bi bi-wallet2"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-6 col-md-3" v-if="tengoPermiso('productos')">
                            <div class="card border-0 shadow-sm h-100 bg-warning bg-opacity-10">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <small class="text-dark text-uppercase fw-bold" style="font-size: 0.7rem;">Stock Bajo</small>
                                            <h4 class="fw-bold text-dark mt-2 mb-0">{{ dashboardData.kpi.stockBajo }}</h4>
                                        </div>
                                        <div class="bg-white text-warning rounded p-2 shadow-sm">
                                            <i class="bi bi-exclamation-triangle-fill"></i>
                                        </div>
                                    </div>
                                    <small class="text-dark mt-2 d-block" style="font-size: 0.7rem;">Productos cr√≠ticos</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4" v-if="tengoPermiso('reportes')">
                        <div class="col-md-8">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                                    <h6 class="fw-bold mb-0 text-secondary">
                                        <i class="bi bi-pie-chart-fill me-2 text-brand"></i>Flujo de Caja
                                    </h6>
                                    <span class="badge bg-light text-dark border">Este Mes vs Pasado</span>
                                </div>
                                <div class="card-body p-4">
                                    <div class="row align-items-center">
                                        
                                        <div class="col-md-4 text-center border-end mb-4 mb-md-0">
                                            <small class="text-muted fw-bold d-block mb-1">BALANCE NETO (ACTUAL)</small>
                                            <h2 class="fw-bold" :class="dashboardData.flujoCaja.balanceActual >= 0 ? 'text-success' : 'text-danger'">
                                                {{ formatoMoneda(dashboardData.flujoCaja.balanceActual) }}
                                            </h2>
                                            <small class="text-muted">Utilidad Operativa</small>
                                        </div>

                                        <div class="col-md-8 px-md-4">
                                            
                                            <div class="mb-4">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span class="small fw-bold"><i class="bi bi-arrow-up-circle-fill text-success me-1"></i> Ingresos</span>
                                                    <span class="small fw-bold">{{ formatoMoneda(dashboardData.flujoCaja.ingresoActual) }}</span>
                                                </div>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-success" style="width: 100%"></div>
                                                </div>
                                                <div class="d-flex justify-content-between mt-1">
                                                    <small class="text-muted" style="font-size: 0.7rem;">Mes Pasado: {{ formatoMoneda(dashboardData.flujoCaja.ingresoPasado) }}</small>
                                                </div>
                                            </div>

                                            <div>
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span class="small fw-bold"><i class="bi bi-arrow-down-circle-fill text-danger me-1"></i> Gastos</span>
                                                    <span class="small fw-bold">{{ formatoMoneda(dashboardData.flujoCaja.gastoActual) }}</span>
                                                </div>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-danger" 
                                                         :style="{width: calcularPorcentajeGasto() + '%'}"></div>
                                                </div>
                                                <div class="d-flex justify-content-between mt-1">
                                                    <small class="text-muted" style="font-size: 0.7rem;">Mes Pasado: {{ formatoMoneda(dashboardData.flujoCaja.gastoPasado) }}</small>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100 bg-brand text-white">
                                <div class="card-body p-4 d-flex flex-column justify-content-center text-center">
                                    <h5 class="fw-bold mb-3">¬øNecesitas ayuda?</h5>
                                    <p class="small opacity-75 mb-4">Revisa las alertas de stock o genera un reporte detallado para ver el desglose.</p>
                                    <button class="btn btn-light text-brand fw-bold shadow-sm" @click="cambiarVista('reportes')" v-if="tengoPermiso('reportes')">
                                        Ver Reportes
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="row mt-4 mb-4">
                      <div class="col-12">
                          <div class="card border-0 shadow-sm">
                              <div class="card-header bg-white border-0 py-3">
                                  <h5 class="card-title fw-bold text-dark mb-0">
                                      <i class="bi bi-graph-up-arrow text-brand me-2"></i>Tendencia de Ventas (7 d√≠as)
                                  </h5>
                              </div>
                              <div class="card-body">
                                  <canvas id="graficoVentas" style="max-height: 300px;"></canvas>
                              </div>
                          </div>
                      </div>
                  </div>
                </div>

                <div v-if="vistaActual === 'transferencias'">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="fw-bold text-dark mb-0"><i class="bi bi-arrow-left-right text-brand"></i> Transferencias</h3>
                        <div class="btn-group shadow-sm">
                            <button class="btn" :class="subVistaTransf === 'nueva' ? 'btn-brand' : 'btn-white bg-white text-secondary border'" @click="subVistaTransf = 'nueva'">Nueva</button>
                            <button class="btn" :class="subVistaTransf === 'historial' ? 'btn-brand' : 'btn-white bg-white text-secondary border'" @click="cargarHistorialTransf">Historial</button>
                        </div>
                    </div>

                    <div v-if="subVistaTransf === 'nueva'">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body">
                                <h6 class="text-brand fw-bold text-uppercase small mb-3">Datos del Traslado</h6>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Fecha</label>
                                        <input type="date" class="form-control" v-model="formTransf.fecha">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Origen (Sale)</label>
                                        <select class="form-select" v-model="formTransf.origen">
                                            <option v-for="d in listaDepositos" :value="d.id_deposito">{{ d.nombre }}</option>
                                        </select>
                                    </div>
                                    <div class="col-md-1 d-flex align-items-center justify-content-center pt-3">
                                        <i class="bi bi-arrow-right fs-3 text-muted"></i>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Destino (Entra)</label>
                                        <select class="form-select" v-model="formTransf.destino">
                                            <option v-for="d in listaDepositos" :value="d.id_deposito" :disabled="d.id_deposito === formTransf.origen">{{ d.nombre }}</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label fw-bold">Responsable</label>
                                        <input type="text" class="form-control" v-model="formTransf.responsable">
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <input type="text" class="form-control" placeholder="Observaci√≥n (Opcional)" v-model="formTransf.observacion">
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm mb-4 border-start border-3 border-brand">
                            <div class="card-body bg-light">
                                <form @submit.prevent="agregarAlCarritoTransf">
                                    <div class="row g-2 align-items-end">
                                        <div class="col-md-6">
                                            <label class="small fw-bold">Producto a mover</label>
                                            <select class="form-select" v-model="lineaTransf.id_producto" required>
                                                <option value="" disabled>Seleccionar...</option>
                                                <option v-for="p in productos" :value="p.id_producto">{{ p.nombre }} (Global: {{ p.stock_actual }})</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="small fw-bold">Cantidad</label>
                                            <input type="number" class="form-control" v-model.number="lineaTransf.cantidad" min="1" required>
                                        </div>
                                        <div class="col-md-3 d-grid">
                                            <button class="btn btn-brand fw-bold"><i class="bi bi-plus-lg"></i> Agregar</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm" v-if="carritoTransf.length > 0">
                            <table class="table align-middle mb-0">
                                <thead class="table-light"><tr><th>Producto</th><th class="text-center">Cant</th><th></th></tr></thead>
                                <tbody>
                                    <tr v-for="(item, i) in carritoTransf" :key="i">
                                        <td>{{ item.nombre }}</td>
                                        <td class="text-center fw-bold">{{ item.cantidad }}</td>
                                        <td class="text-end"><button class="btn btn-sm text-danger" @click="quitarCarritoTransf(i)"><i class="bi bi-x-lg"></i></button></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="card-footer bg-white text-end p-3">
                                <button class="btn btn-brand fw-bold px-4" @click="guardarTransfFinal">Confirmar Transferencia</button>
                            </div>
                        </div>
                    </div>

                    <div v-if="subVistaTransf === 'historial'">
                        <div class="card border-0 shadow-sm">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light"><tr><th class="ps-3">Fecha</th><th>Ruta</th><th>Responsable</th><th class="text-end pe-3">PDF</th></tr></thead>
                                    <tbody>
                                        <tr v-for="h in historialTransf" :key="h.id">
                                            <td class="ps-3">{{ h.fecha }}</td>
                                            <td><span class="badge bg-light text-dark border">{{ h.origen }}</span> <i class="bi bi-arrow-right mx-1 text-muted small"></i> <span class="badge bg-success bg-opacity-10 text-success border border-success">{{ h.destino }}</span></td>
                                            <td class="small">{{ h.responsable }}</td>
                                            <td class="text-end pe-3">
                                                <a v-if="h.url_pdf" :href="h.url_pdf" target="_blank" class="btn btn-sm btn-outline-danger"><i class="bi bi-file-earmark-pdf"></i></a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="vistaActual === 'remisiones'">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="fw-bold text-dark mb-0"><i class="bi bi-truck-flatbed text-brand"></i> Notas de Remisi√≥n</h3>
                        <div class="btn-group shadow-sm">
                            <button class="btn" :class="subVistaRemision === 'nueva' ? 'btn-brand' : 'btn-white bg-white text-secondary border'" @click="subVistaRemision = 'nueva'">Nueva</button>
                            <button class="btn" :class="subVistaRemision === 'historial' ? 'btn-brand' : 'btn-white bg-white text-secondary border'" @click="cargarHistorialRemisiones">Historial</button>
                        </div>
                    </div>

                    <div v-if="subVistaRemision === 'nueva'">
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-body">
                                <h6 class="text-secondary small fw-bold mb-3 text-uppercase">Datos del Traslado</h6>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold small">Fecha</label>
                                        <input type="date" class="form-control" v-model="formRemision.fecha">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold small">Nro. Comprobante</label>
                                        <input type="text" class="form-control" v-model="formRemision.numero" placeholder="Auto (Seg√∫n Config)">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold small">Cliente Destino</label>
                                        <select class="form-select" v-model="formRemision.id_cliente">
                                            <option value="" disabled>Seleccionar...</option>
                                            <option v-for="c in clientes" :value="c.id_cliente">{{ c.razon_social }}</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold small">Sale de Dep√≥sito</label>
                                        <select class="form-select" v-model="formRemision.id_deposito">
                                            <option v-for="d in listaDepositos" :value="d.id_deposito">{{ d.nombre }}</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small">Conductor (Opcional)</label>
                                        <input type="text" class="form-control" v-model="formRemision.conductor" placeholder="Nombre del chofer">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small">Chapa / Veh√≠culo (Opcional)</label>
                                        <input type="text" class="form-control" v-model="formRemision.chapa" placeholder="ABC-123">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm mb-3 border-top border-brand border-3">
                            <div class="card-body bg-light">
                                <form @submit.prevent="agregarAlCarritoRemision">
                                    <div class="row g-2 align-items-end">
                                        <div class="col-md-8">
                                            <label class="form-label small fw-bold">Producto a Trasladar</label>
                                            <select class="form-select" v-model="lineaRemision.id_producto" required>
                                                <option value="" disabled>Buscar producto...</option>
                                                <option v-for="p in productos" :value="p.id_producto">{{ p.nombre }} (Stock Global: {{ p.stock_actual }})</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small fw-bold">Cantidad</label>
                                            <input type="number" class="form-control" v-model.number="lineaRemision.cantidad" min="1" required>
                                        </div>
                                        <div class="col-md-2 d-grid">
                                            <button class="btn btn-brand fw-bold"><i class="bi bi-plus-lg"></i></button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm" v-if="carritoRemision.length > 0">
                            <table class="table align-middle mb-0 table-striped">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-3">Producto</th>
                                        <th class="text-center">Cant.</th>
                                        <th class="text-end">Precio Ref.</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(item, i) in carritoRemision" :key="i">
                                        <td class="ps-3">{{ item.nombre_prod }}</td>
                                        <td class="text-center fw-bold">{{ item.cantidad }}</td>
                                        <td class="text-end text-muted small">{{ formatoMoneda(item.precio) }}</td>
                                        <td class="text-end pe-3"><button class="btn btn-sm text-danger" @click="carritoRemision.splice(i,1)"><i class="bi bi-trash"></i></button></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="card-footer bg-white text-end p-3">
                                <button class="btn btn-brand fw-bold px-4" @click="guardarRemisionFinal"><i class="bi bi-file-earmark-check me-2"></i> GENERAR REMISI√ìN</button>
                            </div>
                        </div>
                    </div>

                    <div v-if="subVistaRemision === 'historial'">
                      <div class="row mb-3">
                          <div class="col-md-6">
                              <div class="input-group shadow-sm">
                                  <span class="input-group-text bg-white border-end-0">
                                      <i class="bi bi-search text-muted"></i>
                                  </span>
                                  <input type="text" class="form-control border-start-0 ps-0" 
                                        v-model="busquedaRemision" 
                                        placeholder="Buscar por cliente o n√∫mero de remisi√≥n...">
                                  <button v-if="busquedaRemision" class="btn btn-outline-secondary" @click="busquedaRemision = ''">
                                      <i class="bi bi-x-lg"></i>
                                  </button>
                              </div>
                          </div>
                      </div>
                      <div class="card border-0 shadow-sm">
                          <div class="table-responsive">
                              <table class="table table-hover align-middle mb-0">
                                  <thead class="table-light"><tr><th class="ps-3">Fecha</th><th>Nro</th><th>Cliente</th><th>Estado</th><th class="text-end pe-3">Acciones</th></tr></thead>
                                  <tbody>
                                      <tr v-for="h in remisionesFiltradas" :key="h.id_remision">
                                          <td class="ps-3 text-muted small">{{ new Date(h.fecha).toLocaleDateString() }}</td>
                                          <td><span class="badge bg-light text-dark border">{{ h.numero }}</span></td>
                                          <td class="fw-bold">{{ h.cliente }}</td>
                                            <td class="text-center">
                                              <span v-if="h.estado === 'ANULADO'" class="badge bg-danger">ANULADO</span>
                                              <span v-else-if="h.estado === 'FACTURADO'" class="badge bg-success">FACTURADO</span>
                                              <span v-else class="badge bg-warning text-dark border">PENDIENTE</span>
                                            </td>
                                            <td class="text-end pe-3">
                                                <a v-if="h.url_pdf" :href="h.url_pdf" target="_blank" class="btn btn-sm btn-outline-secondary me-1" title="Ver PDF">
                                                    <i class="bi bi-file-earmark-pdf"></i>
                                                </a>
                                                
                                                <button v-if="h.estado === 'PENDIENTE_FACTURAR' || h.estado === 'ENTREGADO'" class="btn btn-sm btn-success text-white fw-bold me-1" @click="facturarDesdeRemision(h)" title="Facturar esta remisi√≥n">
                                                    <i class="bi bi-receipt"></i>
                                                </button>

                                                <button v-if="h.estado !== 'ANULADO' && h.estado !== 'FACTURADO'" class="btn btn-sm btn-outline-danger" @click="anularRemision(h)" title="Anular y devolver stock">
                                                    <i class="bi bi-slash-circle"></i>
                                                </button>
                                            </td>
                                      </tr>
                                      <tr v-if="remisionesFiltradas && remisionesFiltradas.length === 0">
                                          <td colspan="5" class="text-center py-4 text-muted">
                                              <i class="bi bi-filter-circle me-2"></i> No se encontraron resultados.
                                          </td>
                                      </tr>
                                  </tbody>
                              </table>
                          </div>
                      </div>
                    </div>
                </div>

                <div v-if="vistaActual === 'usuarios'">
                    <div class="d-flex align-items-center justify-content-between mb-4">
                        <div>
                            <h3 class="fw-bold text-dark mb-0"><i class="bi bi-person-badge text-brand me-2"></i>Gesti√≥n de Usuarios</h3>
                            <small class="text-muted">Administra el acceso y permisos del personal</small>
                        </div>
                        <button class="btn btn-brand shadow-sm" @click="prepararNuevoUsuario">
                            <i class="bi bi-plus-lg me-2"></i>Nuevo Usuario
                        </button>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-7 col-lg-8">
                            <div class="row g-3">
                                <div class="col-md-6" v-for="u in listaUsuarios" :key="u.id_usuario">
                                    <div class="card border-0 shadow-sm h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-3">

                                                <div class="d-flex align-items-center mb-3">
                                                <img v-if="u.avatar" :src="u.avatar" class="rounded-circle me-3 border" style="width: 48px; height: 48px; object-fit: cover;">
                                                
                                                <div v-else class="bg-brand bg-opacity-10 text-brand rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 48px; height: 48px;">
                                                    <i class="bi bi-person-fill fs-4"></i>
                                                </div>
                                                </div>
                                                <div>
                                                    <h5 class="fw-bold mb-0 text-dark">{{ u.nombre }}</h5>
                                                    <small class="text-muted">{{ u.email }}</small>
                                                </div>
                                                <div class="ms-auto">
                                                    <span class="badge" :class="u.activo === 'SI' ? 'bg-success' : 'bg-danger'">{{ u.activo }}</span>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <span class="badge bg-light text-dark border me-1">{{ u.rol }}</span>
                                                <small class="text-muted d-block mt-2" v-if="u.rol !== 'ADMIN'">
                                                    Permisos: {{ parsearPermisos(u.modulos).length }} m√≥dulos
                                                </small>
                                                <small class="text-muted d-block mt-2" v-else>
                                                    <i class="bi bi-shield-lock-fill text-warning"></i> Acceso Total
                                                </small>
                                            </div>

                                            <div class="d-flex gap-2 border-top pt-3">
                                                <button class="btn btn-sm btn-light border flex-fill" @click="editarUsuario(u)">
                                                    <i class="bi bi-pencil me-1"></i> Editar
                                                </button>
                                                <button class="btn btn-sm btn-light border text-danger flex-fill" @click="eliminarUsuario(u)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-5 col-lg-4">
                            <div class="card border-0 shadow-sm sticky-top" style="top: 80px; border-top: 4px solid var(--color-primary);">
                                <div class="card-header bg-white fw-bold py-3">
                                    <i class="bi" :class="usuarioForm.id_usuario ? 'bi-pencil-square' : 'bi-person-plus'"></i> 
                                    {{ usuarioForm.id_usuario ? 'Editar Usuario' : 'Crear Usuario' }}
                                </div>
                                <div class="card-body">
                                    <form @submit.prevent="guardarUsuario">
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold">Nombre Completo</label>
                                            <input type="text" class="form-control" v-model="usuarioForm.nombre" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold">Usuario / Email</label>
                                            <input type="text" class="form-control" v-model="usuarioForm.email" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold">Contrase√±a</label>
                                            <input type="text" class="form-control" v-model="usuarioForm.password" required>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <label class="form-label small fw-bold">Rol</label>
                                                <select class="form-select" v-model="usuarioForm.rol">
                                                    <option value="OPERADOR">Operador</option>
                                                    <option value="ADMIN">Admin</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label small fw-bold">Activo</label>
                                                <select class="form-select" v-model="usuarioForm.activo">
                                                    <option>SI</option>
                                                    <option>NO</option>
                                                </select>
                                            </div>
                                        </div>

                                          <div class="mb-4" v-if="usuarioForm.rol === 'OPERADOR'">
                                            <label class="form-label small fw-bold mb-2">Permisos de Acceso</label>
                                            <div class="bg-light p-3 rounded border">
                                                <div class="row">
                                                    
                                                    <div class="col-6">
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" value="remisiones" v-model="usuarioForm.permisos">
                                                            <label class="form-check-label small">Notas de Remisi√≥n</label>
                                                        </div>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" value="ventas" v-model="usuarioForm.permisos">
                                                            <label class="form-check-label small">Ventas / Caja</label>
                                                        </div>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" value="compras" v-model="usuarioForm.permisos">
                                                            <label class="form-check-label small">Compras / Stock</label>
                                                        </div>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" value="gastos" v-model="usuarioForm.permisos">
                                                            <label class="form-check-label small">Gastos Operativos</label>
                                                        </div>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" value="transferencias" v-model="usuarioForm.permisos">
                                                            <label class="form-check-label small">Transferencias</label>
                                                        </div>
                                                    </div>

                                                    <div class="col-6">
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" value="cobranzas" v-model="usuarioForm.permisos">
                                                            <label class="form-check-label small">Cobranzas</label>
                                                        </div>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" value="productos" v-model="usuarioForm.permisos">
                                                            <label class="form-check-label small">Inventario</label>
                                                        </div>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" value="clientes" v-model="usuarioForm.permisos">
                                                            <label class="form-check-label small">Clientes</label>
                                                        </div>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" value="proveedores" v-model="usuarioForm.permisos">
                                                            <label class="form-check-label small">Proveedores</label>
                                                        </div>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" value="reportes" v-model="usuarioForm.permisos">
                                                            <label class="form-check-label small">Reportes</label>
                                                        </div>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <label class="form-label small fw-bold mb-2">Selecciona un Avatar</label>
                                            <div class="d-flex flex-wrap gap-2">
                                                <div class="rounded-circle d-flex align-items-center justify-content-center border" 
                                                     :class="usuarioForm.avatar === '' ? 'border-primary border-3' : ''"
                                                     style="width: 50px; height: 50px; cursor: pointer; background: #eee;"
                                                     @click="usuarioForm.avatar = ''">
                                                    <i class="bi bi-person-fill text-muted fs-4"></i>
                                                </div>

                                                <img v-for="img in avataresDisponibles" 
                                                     :src="img" 
                                                     class="rounded-circle border bg-white"
                                                     :class="usuarioForm.avatar === img ? 'border-primary border-3 shadow' : ''"
                                                     style="width: 50px; height: 50px; cursor: pointer; object-fit: cover;"
                                                     @click="usuarioForm.avatar = img">
                                            </div>
                                        </div>

                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-brand fw-bold">Guardar Cambios</button>
                                            <button type="button" class="btn btn-light border" v-if="usuarioForm.id_usuario" @click="prepararNuevoUsuario">Cancelar Edici√≥n</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="vistaActual === 'cobranzas'">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="fw-bold text-dark mb-0"><i class="bi bi-wallet2 text-brand"></i> Gesti√≥n de Cobros</h3>
                        
                        <div class="btn-group shadow-sm">
                            <button class="btn" :class="subVistaCobranzas === 'listado' || subVistaCobranzas === 'nuevo' ? 'btn-brand' : 'btn-white bg-white text-secondary border'" 
                                    @click="cargarCobranzas()">
                                <i class="bi bi-list-task me-1"></i> Pendientes
                            </button>
                            <button class="btn" :class="subVistaCobranzas === 'historial' ? 'btn-brand' : 'btn-white bg-white text-secondary border'" 
                                    @click="cargarHistorialCobranzas()">
                                <i class="bi bi-clock-history me-1"></i> Historial
                            </button>
                        </div>
                    </div>

                    <div v-if="subVistaCobranzas === 'listado'">
                        <div class="card border-0 shadow-sm">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light"><tr><th>Cliente</th><th class="text-end">Deuda Total</th><th class="text-end">Acci√≥n</th></tr></thead>
                                    <tbody>
                                        <template v-for="c in clientesDeudores" :key="c.id_cliente">
                                            <tr class="table-light" :class="{'border-bottom-0': c.mostrar_detalle}" style="cursor: pointer;" @click="c.mostrar_detalle = !c.mostrar_detalle">
                                                <td><div class="d-flex align-items-center"><i class="bi me-2 text-primary" :class="c.mostrar_detalle ? 'bi-chevron-down' : 'bi-chevron-right'"></i><div><div class="fw-bold">{{ c.nombre }}</div><small class="text-muted">{{ c.facturas_pendientes.length }} facturas pendientes</small></div></div></td>
                                                <td class="text-end fw-bold text-danger fs-5">{{ formatoMoneda(c.total_deuda) }}</td>
                                                <td class="text-end"><span class="text-muted small">Ver detalle <i class="bi bi-arrow-down"></i></span></td>
                                            </tr>
                                            <tr v-if="c.mostrar_detalle">
                                                <td colspan="3" class="p-0 bg-white border-bottom">
                                                    <div class="p-3 bg-light bg-opacity-50">
                                                        <table class="table table-sm table-bordered mb-0 bg-white shadow-sm align-middle">
                                                            <thead class="text-muted small bg-light"><tr><th>Fecha</th><th>Nro. Factura</th><th class="text-end">Importe Orig.</th><th class="text-end text-danger">Saldo</th><th class="text-center" style="width: 100px;">Acci√≥n</th></tr></thead>
                                                            <tbody>
                                                                <tr v-for="f in c.facturas_pendientes" :key="f.id_venta">
                                                                    <td class="small">{{ new Date(f.fecha).toLocaleDateString() }}</td><td class="fw-bold text-dark">{{ f.numero }}</td><td class="text-end text-muted small">{{ formatoMoneda(f.total_original) }}</td><td class="text-end fw-bold text-danger">{{ formatoMoneda(f.saldo) }}</td>
                                                                    <td class="text-center"><button class="btn btn-sm btn-outline-success fw-bold" @click="abrirCobro(f, c)">Pagar</button></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </td>
                                            </tr>
                                        </template>
                                        <tr v-if="clientesDeudores.length === 0"><td colspan="3" class="text-center p-5 text-muted"><i class="bi bi-check-circle fs-1 d-block mb-2 text-success"></i>üéâ ¬°Todo al d√≠a! No hay deudas pendientes.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div v-if="subVistaCobranzas === 'nuevo'">
                        <button class="btn btn-sm btn-outline-secondary mb-3" @click="subVistaCobranzas='listado'"><i class="bi bi-arrow-left"></i> Volver</button>
                        <div class="card border-0 shadow-sm" style="max-width: 500px; margin: 0 auto;">
                            <div class="card-header bg-success text-white fw-bold">Registrar Cobro</div>
                            <div class="card-body">
                                <div class="alert alert-warning">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>Factura: <strong>{{ formCobro.nro_factura_visual }}</strong></span>
                                        <span class="fw-bold fs-5">Saldo: {{ formatoMoneda(formCobro.deuda_total) }}</span>
                                    </div>
                                </div>
                                <form @submit.prevent="guardarCobro">
                                    <div class="mb-3"><label class="form-label">Cliente</label><input type="text" class="form-control" :value="formCobro.nombre" disabled></div>
                                    <div class="mb-3"><label class="form-label fw-bold">Monto a Pagar</label><input type="number" class="form-control form-control-lg text-end fw-bold text-success" v-model.number="formCobro.monto" required min="1"></div>
                                    <div class="mb-3"><label class="form-label">M√©todo de Pago</label><select class="form-select" v-model="formCobro.metodo"><option>Efectivo</option><option>Transferencia</option><option>Cheque</option><option>Tarjeta</option></select></div>
                                    <div class="mb-3"><label class="form-label">Observaci√≥n</label><input type="text" class="form-control" v-model="formCobro.observacion" placeholder="Nro de comprobante, banco..."></div>
                                    <div class="d-grid"><button type="submit" class="btn btn-success btn-lg fw-bold">Confirmar Pago</button></div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div v-if="subVistaCobranzas === 'historial'">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group shadow-sm">
                                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0" v-model="busquedaCobranza" placeholder="Buscar por cliente, m√©todo u observaci√≥n...">
                                    <button v-if="busquedaCobranza" class="btn btn-outline-secondary" @click="busquedaCobranza = ''"><i class="bi bi-x-lg"></i></button>
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="ps-3">Fecha</th>
                                            <th>Cliente</th>
                                            <th>M√©todo</th>
                                            <th>Ref/Obs</th>
                                            <th class="text-end pe-3">Monto Cobrado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="h in cobranzasFiltradas" :key="h.id_cobro">
                                            <td class="ps-3 small text-muted">{{ new Date(h.fecha).toLocaleDateString() }} {{ new Date(h.fecha).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) }}</td>
                                            <td class="fw-bold">{{ h.nombre_cliente }}</td>
                                            <td><span class="badge bg-light text-dark border">{{ h.metodo }}</span></td>
                                            <td class="small text-muted fst-italic text-truncate" style="max-width: 150px;">{{ h.observacion || '-' }}</td>
                                            <td class="text-end pe-3 fw-bold text-success">+ {{ formatoMoneda(h.monto) }}</td>
                                        </tr>
                                        <tr v-if="cobranzasFiltradas.length === 0">
                                            <td colspan="5" class="text-center py-4 text-muted">No se encontraron registros.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>

                <div v-if="vistaActual === 'compras'">
                    <div class="d-flex justify-content-between align-items-center mb-4"><h3 class="fw-bold text-dark mb-0"><i class="bi bi-cart-plus text-brand"></i> Compras</h3><div class="btn-group shadow-sm"><button class="btn" :class="subVistaCompras === 'nueva' ? 'btn-brand' : 'btn-white bg-white text-secondary border'" @click="subVistaCompras = 'nueva'"><i class="bi bi-plus-lg"></i> Nueva</button><button class="btn" :class="subVistaCompras === 'historial' ? 'btn-brand' : 'btn-white bg-white text-secondary border'" @click="cargarHistorial"><i class="bi bi-clock-history"></i> Historial</button></div></div>
                    <div v-if="subVistaCompras === 'nueva'"><div class="card border-0 shadow-sm mb-4 no-hover"><div class="card-body"><h6 class="text-muted text-uppercase fw-bold small mb-3">Datos del Comprobante</h6><div class="row g-3"><div class="col-md-4"><label class="form-label fw-bold">Proveedor</label><select class="form-select" v-model="formCompra.id_proveedor"><option value="" disabled>Seleccione proveedor...</option><option v-for="p in proveedores" :value="p.id_proveedor">{{ p.razon_social }}</option></select></div><div class="col-md-4"><label class="form-label fw-bold">Fecha Emisi√≥n</label><input type="date" class="form-control" v-model="formCompra.fecha"></div><div class="col-md-4"><label class="form-label fw-bold">N¬∫ Factura / Remisi√≥n</label><input type="text" class="form-control" v-model="formCompra.comprobante" placeholder="Ej: 001-001-123456"></div></div></div></div><div class="card border-0 shadow-sm mb-4 no-hover border-brand border-top border-3"><div class="card-body bg-light"><h6 class="text-brand text-uppercase fw-bold small mb-3">Agregar Productos</h6><form @submit.prevent="agregarAlCarrito"><div class="row g-2 align-items-end"><div class="col-md-5"><label class="form-label small">Producto</label><select class="form-select" v-model="lineaTemp.id_producto" required><option value="" disabled>Buscar producto...</option><option v-for="prod in productos" :value="prod.id_producto">{{ prod.sku }} - {{ prod.nombre }}</option></select></div><div class="col-md-2 col-6"><label class="form-label small">Cantidad</label><input type="number" class="form-control" v-model.number="lineaTemp.cantidad" min="1" required placeholder="0"></div><div class="col-md-3 col-6"><label class="form-label small">Costo (Gs)</label><input type="number" class="form-control" v-model.number="lineaTemp.costo" min="0" required placeholder="0"></div><div class="col-md-2 d-grid"><button type="submit" class="btn btn-brand fw-bold"><i class="bi bi-plus-lg"></i> Agregar</button></div></div></form></div></div><div class="card border-0 shadow-sm no-hover"><div class="table-responsive"><table class="table align-middle mb-0"><thead class="table-light"><tr><th>Producto</th><th class="text-center">Cant.</th><th class="text-end">Costo</th><th class="text-end">Subtotal</th><th style="width: 50px;"></th></tr></thead><tbody><tr v-for="(item, index) in carritoCompra" :key="index"><td><div class="fw-bold">{{ obtenerNombreProducto(item.id_producto) }}</div></td><td class="text-center">{{ item.cantidad }}</td><td class="text-end">{{ formatoMoneda(item.costo) }}</td><td class="text-end fw-bold">{{ formatoMoneda(item.cantidad * item.costo) }}</td><td><button class="btn btn-sm text-danger" @click="quitarDelCarrito(index)"><i class="bi bi-x-lg"></i></button></td></tr><tr v-if="carritoCompra.length === 0"><td colspan="5" class="text-center py-4 text-muted">Carrito vac√≠o</td></tr></tbody><tfoot v-if="carritoCompra.length > 0"><tr class="bg-light"><td colspan="3" class="text-end fw-bold fs-5 pt-3">TOTAL:</td><td class="text-end fw-bold fs-4 text-brand pt-3">{{ formatoMoneda(totalCompra) }}</td><td></td></tr></tfoot></table></div><div class="card-footer bg-white p-3 text-end" v-if="carritoCompra.length > 0"><button class="btn btn-outline-secondary me-2" @click="limpiarCarrito">Cancelar</button><button class="btn btn-brand fw-bold px-4" @click="guardarCompraFinal"><i class="bi bi-check-lg me-1"></i> FINALIZAR</button></div></div></div>
                    <div v-if="subVistaCompras === 'historial'"><div class="card border-0 shadow-sm"><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th class="ps-3">Fecha</th><th>Proveedor</th><th class="text-end">Total</th><th class="text-center">Estado</th><th class="text-end pe-3">Acciones</th></tr></thead><tbody><tr v-for="h in historialCompras" :key="h.id_compra"><td class="ps-3 text-muted small">{{ new Date(h.fecha).toLocaleDateString() }}</td><td class="fw-bold text-dark">{{ h.nombre_proveedor }}</td><td class="text-end fw-bold text-success">{{ formatoMoneda(h.total) }}</td><td class="text-center"><span v-if="h.estado === 'ANULADO'" class="badge bg-danger">ANULADO</span><span v-else class="badge bg-success bg-opacity-10 text-success border border-success">{{ h.estado }}</span></td><td class="text-end pe-3"> <a v-if="h.url_pdf" :href="h.url_pdf" target="_blank" class="btn btn-sm btn-outline-secondary me-1" title="Ver Orden Compra"><i class="bi bi-file-earmark-pdf"></i></a> <button class="btn btn-sm btn-outline-primary me-1" @click="verDetalleCompra(h)"><i class="bi bi-eye"></i></button><button v-if="h.estado !== 'ANULADO'" class="btn btn-sm btn-outline-danger" @click="anularCompra(h)"><i class="bi bi-slash-circle"></i></button></td></tr></tbody></table></div></div></div></div>
                </div>

                <div v-if="vistaActual === 'productos'">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                        <div><h3 class="fw-bold mb-0 text-dark">Inventario</h3><small class="text-muted">{{ productos.length }} productos activos</small></div>
                        <button class="btn btn-brand shadow-sm w-100 w-md-auto" @click="abrirModalProducto(null)"><i class="bi bi-plus-lg me-1"></i> Nuevo Producto</button>
                    </div>
                    <div class="row g-3">
                        <div class="col-12 col-sm-6 col-lg-3" v-for="item in productos" :key="item.id_producto"> 
                            <div class="card h-100 shadow-sm">
                                
                                <div class="img-producto-card">
                                    <img v-if="item.url_imagen" :src="item.url_imagen" alt="Producto">
                                    <i v-else class="bi bi-camera-fill fs-1 text-muted opacity-25"></i>
                                    <span class="position-absolute top-0 end-0 m-2 badge bg-brand bg-opacity-75 rounded-pill small">{{ obtenerNombreCategoria(item.id_categoria) }}</span>
                                </div>

                                <div class="card-body d-flex flex-column">
                                    
                                    <div class="mb-2">
                                        <h6 class="card-title fw-bold text-truncate mb-0" :title="item.nombre">{{ item.nombre }}</h6>
                                        <small class="text-muted" style="font-size: 0.8rem;">SKU: {{ item.sku }}</small>
                                    </div>
                                    
                                    <div class="row g-0 mb-3 small bg-light rounded border p-1">
                                        <div class="col-6 border-end pe-2 text-center">
                                            <span class="d-block text-muted" style="font-size: 0.7rem;">Stock Total</span>
                                            <span class="fw-bold fs-5" :class="(item.stock_actual || 0) <= (item.stock_minimo || 5) ? 'text-danger' : 'text-success'">
                                                {{ item.stock_actual || 0 }} 
                                            </span>
                                            <span class="d-block text-muted" style="font-size: 0.6rem;">{{ item.unidad_medida }}</span>
                                        </div>
                                        <div class="col-6 ps-2 text-center d-flex flex-column justify-content-center">
                                            <span class="d-block text-muted" style="font-size: 0.7rem;">Costo Prom.</span>
                                            <span class="fw-bold text-secondary">{{ formatoMoneda(item.costo_promedio || item.costo || 0) }}</span>
                                        </div>
                                    </div>

                                    <div class="mt-auto">
                                        <div class="d-flex justify-content-between align-items-end mb-2">
                                            <div>
                                                <div class="text-brand fw-bold fs-4 line-height-1">{{ formatoMoneda(item.precio_venta_base) }}</div>
                                                <small class="text-muted" style="font-size: 0.75rem;">Precio Venta</small>
                                            </div>
                                        </div>
                                        
                                        <a class="text-decoration-none small text-brand fw-bold d-flex align-items-center gap-1 mb-2" 
                                           data-bs-toggle="collapse" 
                                           :href="'#collapse' + item.id_producto" 
                                           role="button" 
                                           aria-expanded="false">
                                           <i class="bi bi-info-circle"></i> Ver detalles
                                        </a>
                                    </div>

                                    <div class="collapse" :id="'collapse' + item.id_producto">
                                        <div class="bg-light p-2 rounded small border shadow-sm mb-3">
                                            
                                            <h6 class="fw-bold text-secondary border-bottom pb-1 mb-2" style="font-size: 0.7rem;">üìç Ubicaci√≥n del Stock</h6>
                                            <div v-if="item.stocks && item.stocks.length > 0">
                                                <table class="table table-sm table-borderless mb-0">
                                                    <tbody>
                                                        <tr v-for="st in item.stocks" :key="st.nombre_deposito">
                                                            <td class="text-start ps-0 text-muted py-0">{{ st.nombre_deposito }}</td>
                                                            <td class="text-end fw-bold pe-0 py-0">{{ st.cantidad }}</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div v-else class="text-center text-muted fst-italic mb-2">Sin stock registrado</div>

                                            <div v-if="tieneDatosValidos(item)">
                                                <h6 class="fw-bold text-secondary border-bottom pb-1 mb-2 mt-3" style="font-size: 0.7rem;">‚ÑπÔ∏è Info Adicional</h6>
                                                <div v-for="(val, key) in item.datos_adicionales">
                                                    <div v-if="val && val.toString().trim() !== ''" class="mb-1 d-flex justify-content-between">
                                                        <span class="text-muted">{{ obtenerEtiquetaCampo(key) }}:</span> 
                                                        <span class="fw-bold text-dark">{{ val }}</span>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                    <div class="d-flex gap-2 pt-2 border-top">
                                        <button class="btn btn-sm btn-outline-brand flex-grow-1" @click="abrirModalProducto(item)"><i class="bi bi-pencil"></i> Editar</button>
                                        <button class="btn btn-sm btn-outline-danger" @click="eliminarProducto(item)"><i class="bi bi-trash"></i></button>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="vistaActual === 'clientes'">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                        <h3 class="fw-bold">Clientes</h3>
                        <button class="btn btn-brand shadow-sm w-100 w-md-auto" @click="abrirModalCliente(null)"><i class="bi bi-person-plus-fill me-1"></i> Nuevo Cliente</button>
                    </div>
                      <div class="card shadow-sm border-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" style="min-width: 600px;">
                                <thead class="table-light"><tr><th class="ps-3">Raz√≥n Social</th><th>Doc. Identidad</th><th>Contacto</th><th>Info Extra</th><th class="text-end pe-3">Acciones</th></tr></thead>
                                <tbody>
                                    <tr v-for="cli in clientes" :key="cli.id_cliente">
                                        <td class="ps-3 fw-bold text-brand">{{ cli.razon_social }}</td>
                                        <td><span class="badge bg-light text-dark border">{{ cli.doc_identidad }}</span></td>
                                        <td><div v-if="cli.telefono"><i class="bi bi-telephone me-1"></i>{{ cli.telefono }}</div><div v-if="cli.email" class="small text-muted"><i class="bi bi-envelope me-1"></i>{{ cli.email }}</div></td>
                                        <td class="small text-muted"><div v-for="(val, key) in cli.datos_adicionales"><span v-if="val" class="d-block">‚Ä¢ <strong>{{ key }}:</strong> {{ val }}</span></div></td>
                                        <td class="text-end pe-3"><button class="btn btn-sm btn-light text-brand border me-1" @click="abrirModalCliente(cli)"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-light text-danger border" @click="eliminarCliente(cli)"><i class="bi bi-trash"></i></button></td>
                                    </tr>
                                    <tr v-if="clientes.length === 0"><td colspan="5" class="text-center p-5 text-muted">No hay clientes registrados.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div v-if="vistaActual === 'proveedores'">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                        <h3 class="fw-bold">Proveedores</h3>
                        <button class="btn btn-brand shadow-sm w-100 w-md-auto" @click="abrirModalProveedor(null)"><i class="bi bi-person-plus-fill me-1"></i> Nuevo Proveedor</button>
                    </div>
                      <div class="card shadow-sm border-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" style="min-width: 600px;">
                                <thead class="table-light"><tr><th class="ps-3">Empresa</th><th>Documento</th><th>Contacto</th><th>Info Extra</th><th class="text-end pe-3">Acciones</th></tr></thead>
                                <tbody>
                                    <tr v-for="prov in proveedores" :key="prov.id_proveedor">
                                        <td class="ps-3 fw-bold text-brand">{{ prov.razon_social }}</td>
                                        <td><span class="badge bg-light text-dark border">{{ prov.doc_identidad }}</span></td>
                                        <td>{{ prov.contacto }}</td>
                                        <td class="small text-muted"><div v-for="(val, key) in prov.datos_adicionales"><span v-if="val" class="d-block">‚Ä¢ <strong>{{ key }}:</strong> {{ val }}</span></div></td>
                                        <td class="text-end pe-3"><button class="btn btn-sm btn-light text-brand border me-1" @click="abrirModalProveedor(prov)"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-light text-danger border" @click="eliminarProveedor(prov)"><i class="bi bi-trash"></i></button></td>
                                    </tr>
                                    <tr v-if="proveedores.length === 0"><td colspan="5" class="text-center p-5 text-muted">No hay proveedores registrados.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div v-if="vistaActual === 'config'">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-brand text-white rounded p-2 me-3 shadow-sm d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                            <i class="bi bi-gear-fill fs-4"></i>
                        </div>
                        <div>
                            <h3 class="fw-bold text-dark mb-0">Configuraci√≥n del Sistema</h3>
                            <small class="text-muted">Ajustes generales y par√°metros</small>
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="card h-100 shadow-sm border-0">
                                <div class="card-body">
                                    <h6 class="fw-bold text-secondary mb-3"><i class="bi bi-receipt me-2 text-brand"></i>Secuencia Facturaci√≥n</h6>
                                    <p class="text-muted small mb-2" style="font-size: 0.8rem;">√öltimo n√∫mero emitido. Se incrementar√° autom√°ticamente.</p>
                                    <div class="input-group">
                                        <input type="text" class="form-control" v-model="configFacturaActual" placeholder="001-001-0000000">
                                        <button class="btn btn-outline-success" @click="guardarConfigFactura" title="Guardar"><i class="bi bi-check-lg"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card h-100 shadow-sm border-0">
                                <div class="card-body">
                                    <h6 class="fw-bold text-secondary mb-3"><i class="bi bi-truck me-2 text-brand"></i>Secuencia Remisiones</h6>
                                    <p class="text-muted small mb-2" style="font-size: 0.8rem;">√öltimo n√∫mero de Nota de Remisi√≥n emitido.</p>
                                    <div class="input-group">
                                        <input type="text" class="form-control" v-model="configRemisionActual" placeholder="001-001-0000000">
                                        <button class="btn btn-outline-success" @click="guardarConfigRemision" title="Guardar"><i class="bi bi-check-lg"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card h-100 shadow-sm border-0">
                                <div class="card-body">
                                    <h6 class="fw-bold text-secondary mb-3"><i class="bi bi-house-door me-2 text-brand"></i>Dep√≥sito Predeterminado</h6>
                                    <p class="text-muted small mb-2" style="font-size: 0.8rem;">Selecci√≥n autom√°tica para nuevas operaciones.</p>
                                    <div class="input-group">
                                        <select class="form-select" v-model="depositoDefault">
                                            <option value="" disabled>Seleccionar...</option>
                                            <option v-for="d in listaDepositos" :value="d.id_deposito">{{ d.nombre }}</option>
                                        </select>
                                        <button class="btn btn-outline-success" @click="guardarConfigDepositoDefault" title="Guardar"><i class="bi bi-check-lg"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm border-0 mb-4 border-top border-4 border-brand">
                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                            <h6 class="fw-bold m-0"><i class="bi bi-building me-2"></i>Administrar Dep√≥sitos</h6>
                            <button class="btn btn-sm btn-brand text-white fw-bold" @click="abrirModalDeposito(null)">
                                <i class="bi bi-plus-lg me-1"></i> Nuevo
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-3">Nombre</th>
                                        <th>Direcci√≥n</th>
                                        <th>Responsable</th>
                                        <th>Estado</th>
                                        <th class="text-end pe-3">Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="d in listaDepositos" :key="d.id_deposito">
                                        <td class="ps-3 fw-bold">{{ d.nombre }}</td>
                                        <td class="small text-muted">{{ d.direccion }}</td>
                                        <td class="small">{{ d.responsable }}</td>
                                        <td><span class="badge" :class="d.activo=='Si'?'bg-success bg-opacity-75':'bg-secondary'">{{ d.activo }}</span></td>
                                        <td class="text-end pe-3">
                                            <button class="btn btn-sm btn-light text-primary border me-1" @click="abrirModalDeposito(d)"><i class="bi bi-pencil"></i></button>
                                            <button class="btn btn-sm btn-light text-danger border" @click="eliminarDeposito(d)"><i class="bi bi-trash"></i></button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card shadow-sm border-0 mb-4 border-top border-4 border-warning">
                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                            <h6 class="fw-bold m-0"><i class="bi bi-tags-fill me-2 text-warning"></i>Categor√≠as de Productos</h6>
                            <button class="btn btn-sm btn-warning text-dark fw-bold" @click="abrirModalCategoria(null)">
                                <i class="bi bi-plus-lg me-1"></i> Nueva
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-3">Nombre de la Categor√≠a</th>
                                        <th class="text-end pe-3">Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="c in listaCategorias" :key="c.id_categoria">
                                        <td class="ps-3 fw-bold text-dark">{{ c.nombre }}</td>
                                        <td class="text-end pe-3">
                                            <button class="btn btn-sm btn-light text-primary border me-1" @click="abrirModalCategoria(c)" title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-light text-danger border" @click="eliminarCategoria(c)" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr v-if="listaCategorias.length === 0">
                                        <td colspan="2" class="text-center py-3 text-muted">No hay categor√≠as registradas.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card shadow-sm border-0 mb-4 border-top border-4 border-primary">
                        <div class="card-header bg-white py-3">
                            <h6 class="fw-bold m-0"><i class="bi bi-tools me-2 text-primary"></i>Mantenimiento de Inventario</h6>
                        </div>
                        <div class="card-body bg-light bg-opacity-25">
                            <p class="text-muted small mb-3"><i class="bi bi-info-circle me-1"></i> Utiliza esta herramienta para correcciones manuales de stock (roturas, mermas, obsequios o producci√≥n interna).</p>
                            
                            <form @submit.prevent="guardarAjuste">
                                <div class="row g-3 align-items-end">
                                    
                                    <div class="col-md-12 mb-2 text-center">
                                        <div class="btn-group bg-white shadow-sm" role="group">
                                            <input type="radio" class="btn-check" name="tipoAjusteCfg" id="adjEntradaCfg" value="ENTRADA" v-model="formAjuste.tipo">
                                            <label class="btn btn-outline-success btn-sm fw-bold px-4" for="adjEntradaCfg">
                                                <i class="bi bi-plus-lg"></i> Entrada / Fabricaci√≥n
                                            </label>

                                            <input type="radio" class="btn-check" name="tipoAjusteCfg" id="adjSalidaCfg" value="SALIDA" v-model="formAjuste.tipo">
                                            <label class="btn btn-outline-danger btn-sm fw-bold px-4" for="adjSalidaCfg">
                                                <i class="bi bi-dash-lg"></i> Salida / Merma
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-md-3">
                                        <label class="form-label small fw-bold text-muted">Dep√≥sito</label>
                                        <select class="form-select form-select-sm bg-white" v-model="formAjuste.id_deposito" required>
                                            <option value="" disabled>Seleccionar...</option>
                                            <option v-for="d in listaDepositos" :value="d.id_deposito">{{ d.nombre }}</option>
                                        </select>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label small fw-bold text-muted">Producto</label>
                                        <select class="form-select form-select-sm bg-white" v-model="formAjuste.id_producto" required>
                                            <option value="" disabled>Buscar...</option>
                                            <option v-for="p in productos" :value="p.id_producto">
                                                {{ p.nombre }} (Global: {{ p.stock_actual }})
                                            </option>
                                        </select>
                                    </div>

                                    <div class="col-md-2">
                                        <label class="form-label small fw-bold text-muted">Cantidad</label>
                                        <input type="number" class="form-control form-control-sm text-center fw-bold" v-model.number="formAjuste.cantidad" min="0.01" step="0.01" required>
                                    </div>

                                    <div class="col-md-3">
                                        <label class="form-label small fw-bold text-muted">Motivo</label>
                                        <div class="input-group input-group-sm">
                                            <input type="text" class="form-control" v-model="formAjuste.motivo" placeholder="Ej: Rotura, Ajuste..." required>
                                            <button type="submit" class="btn fw-bold shadow-sm" 
                                                :class="formAjuste.tipo === 'ENTRADA' ? 'btn-success' : 'btn-danger'">
                                                Aplicar Ajuste
                                            </button>
                                        </div>
                                    </div>

                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="card shadow-sm border-0 border-top border-4 border-secondary">
                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                            <h6 class="fw-bold m-0"><i class="bi bi-input-cursor-text me-2"></i>Campos Personalizados</h6>
                            <button class="btn btn-sm btn-secondary fw-bold" @click="abrirModalCampo(null)">
                                <i class="bi bi-plus-lg me-1"></i> Nuevo
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-3">Entidad</th>
                                        <th>Etiqueta</th>
                                        <th>Tipo</th>
                                        <th class="text-center">Obligatorio</th>
                                        <th class="text-end pe-3">Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="c in listaConfigCampos" :key="c.id_campo">
                                        <td class="ps-3"><span class="badge bg-light text-dark border text-uppercase">{{ c.entidad_objetivo }}</span></td>
                                        <td class="fw-bold text-secondary">{{ c.etiqueta_visible }}</td>
                                        <td class="small text-muted font-monospace">{{ c.tipo_dato }}</td>
                                        <td class="text-center">
                                            <i v-if="esObligatorio(c.es_obligatorio)" class="bi bi-check-circle-fill text-success" title="Obligatorio"></i>
                                            <span v-else class="text-muted text-opacity-25">-</span>
                                        </td>
                                        <td class="text-end pe-3">
                                            <button class="btn btn-sm btn-light text-primary border me-1" @click="abrirModalCampo(c)"><i class="bi bi-pencil"></i></button>
                                            <button class="btn btn-sm btn-light text-danger border" @click="eliminarCampo(c)"><i class="bi bi-trash"></i></button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div v-if="vistaActual === 'ajustes'">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-warning text-dark rounded p-2 me-3 shadow-sm d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                            <i class="bi bi-arrow-down-up fs-4"></i>
                        </div>
                        <div>
                            <h3 class="fw-bold text-dark mb-0">Ajustes de Stock</h3>
                            <small class="text-muted">Entradas por fabricaci√≥n, mermas o correcciones.</small>
                        </div>
                    </div>

                    <div class="row justify-content-center">
                        <div class="col-md-8 col-lg-6">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body p-4">
                                    
                                    <form @submit.prevent="guardarAjuste">
                                        
                                        <div class="mb-4 text-center">
                                            <label class="form-label d-block fw-bold mb-2">Tipo de Ajuste</label>
                                            <div class="btn-group w-100" role="group">
                                                <input type="radio" class="btn-check" name="tipoAjuste" id="tipoEntrada" value="ENTRADA" v-model="formAjuste.tipo">
                                                <label class="btn btn-outline-success fw-bold py-2" for="tipoEntrada">
                                                    <i class="bi bi-plus-circle me-2"></i> ENTRADA / FABRICACI√ìN
                                                </label>

                                                <input type="radio" class="btn-check" name="tipoAjuste" id="tipoSalida" value="SALIDA" v-model="formAjuste.tipo">
                                                <label class="btn btn-outline-danger fw-bold py-2" for="tipoSalida">
                                                    <i class="bi bi-dash-circle me-2"></i> SALIDA / MERMA
                                                </label>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label fw-bold small">Dep√≥sito Afectado</label>
                                            <select class="form-select" v-model="formAjuste.id_deposito" required>
                                                <option value="" disabled>Seleccionar...</option>
                                                <option v-for="d in listaDepositos" :value="d.id_deposito">{{ d.nombre }}</option>
                                            </select>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label fw-bold small">Producto</label>
                                            <select class="form-select" v-model="formAjuste.id_producto" required>
                                                <option value="" disabled>Buscar producto...</option>
                                                <option v-for="p in productos" :value="p.id_producto">
                                                    {{ p.nombre }} (Stock Global: {{ p.stock_actual }})
                                                </option>
                                            </select>
                                        </div>

                                        <div class="row g-3 mb-4">
                                            <div class="col-md-4">
                                                <label class="form-label fw-bold small">Cantidad</label>
                                                <input type="number" class="form-control fw-bold fs-5 text-center" v-model.number="formAjuste.cantidad" min="0.01" step="0.01" required>
                                            </div>
                                            <div class="col-md-8">
                                                <label class="form-label fw-bold small">Motivo / Observaci√≥n</label>
                                                <input type="text" class="form-control" v-model="formAjuste.motivo" required placeholder="Ej: Rotura, Producci√≥n del d√≠a, Regalo...">
                                            </div>
                                        </div>

                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-lg fw-bold shadow-sm" 
                                                :class="formAjuste.tipo === 'ENTRADA' ? 'btn-success' : 'btn-danger'">
                                                <i class="bi bi-save me-2"></i> 
                                                Confirmar {{ formAjuste.tipo }}
                                            </button>
                                        </div>

                                    </form>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="vistaActual === 'gastos'">
                    
                    <div class="d-flex align-items-center mb-4">
                        <div>
                            <h3 class="fw-bold text-dark mb-0"><i class="bi bi-cash-stack text-brand"></i> Registro de Gastos</h3>
                            <small class="text-muted">Control de egresos operativos y administrativos</small>
                        </div>
                    </div>

                    <div class="row g-4">
                        
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-white fw-bold py-3 border-bottom">
                                    <i class="bi bi-plus-circle me-2 text-secondary"></i>Nuevo Gasto
                                </div>
                                <div class="card-body bg-light bg-opacity-10">
                                    <form @submit.prevent="guardarGasto">
                                        
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold text-secondary">Fecha</label>
                                            <input type="date" class="form-control" v-model="formGasto.fecha" required>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label small fw-bold text-secondary">Categor√≠a</label>
                                            <select class="form-select" v-model="formGasto.categoria" required>
                                                <option value="" disabled>Seleccionar...</option>
                                                <option>Alquiler</option>
                                                <option>Servicios B√°sicos (Luz/Agua)</option>
                                                <option>Salarios / Personal</option>
                                                <option>Mantenimiento / Reparaciones</option>
                                                <option>Insumos de Limpieza</option>
                                                <option>Impuestos / Tasas</option>
                                                <option>Marketing / Publicidad</option>
                                                <option>Transporte / Combustible</option>
                                                <option>Varios</option>
                                            </select>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label small fw-bold text-secondary">Descripci√≥n</label>
                                            <textarea class="form-control" v-model="formGasto.descripcion" rows="2" placeholder="Detalle del gasto..." required></textarea>
                                        </div>

                                        <div class="row g-2 mb-4">
                                            <div class="col-6">
                                                <label class="form-label small fw-bold text-secondary">Monto</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control fw-bold text-dark" v-model.number="formGasto.monto" min="1" required>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label small fw-bold text-secondary">M√©todo</label>
                                                <select class="form-select" v-model="formGasto.metodo">
                                                    <option>Efectivo</option>
                                                    <option>Transferencia</option>
                                                    <option>Cheque</option>
                                                    <option>Caja Chica</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="d-grid">
                                          <button type="submit" class="btn btn-brand fw-bold"><i class="bi bi-plus-lg"></i> Confirmar Egreso</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-8">
                            <div class="card border-0 shadow-sm h-100">
                                
                                <div class="card-header bg-white py-3 border-bottom">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span class="fw-bold text-dark"><i class="bi bi-clock-history me-2 text-secondary"></i>Historial</span>
                                    </div>
                                    
                                    <div class="row g-2 align-items-center bg-light p-2 rounded mx-0">
                                        <div class="col-4">
                                            <select class="form-select form-select-sm border-0 bg-transparent fw-bold" v-model="filtroGastoMes">
                                                <option v-for="(m, i) in mesesNombre" :value="i">{{ m }}</option>
                                            </select>
                                        </div>
                                        <div class="col-3">
                                            <select class="form-select form-select-sm border-0 bg-transparent fw-bold" v-model="filtroGastoAnio">
                                                <option v-for="a in aniosDisponibles" :value="a">{{ a }}</option>
                                            </select>
                                        </div>
                                        <div class="col-2">
                                            <button class="btn btn-sm btn-light border" @click="cargarGastos" title="Recargar"><i class="bi bi-arrow-clockwise"></i></button>
                                        </div>
                                        <div class="col-3 text-end border-start">
                                            <small class="text-muted d-block" style="font-size: 0.7rem;">TOTAL PERIODO</small>
                                            <span class="fw-bold text-dark fs-5">{{ formatoMoneda(totalGastosFiltrados) }}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="bg-light">
                                            <tr>
                                                <th class="ps-3 text-secondary small text-uppercase" style="font-weight: 600;">Fecha</th>
                                                <th class="text-secondary small text-uppercase" style="font-weight: 600;">Detalle</th>
                                                <th class="text-secondary small text-uppercase" style="font-weight: 600;">M√©todo</th>
                                                <th class="text-end pe-3 text-secondary small text-uppercase" style="font-weight: 600;">Importe</th>
                                                <th class="text-end pe-3" style="width: 50px;"></th> </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="g in gastosFiltrados" :key="g.id_gasto">
                                                <td class="ps-3 text-muted small" style="width: 80px;">
                                                    <div class="fw-bold text-dark">{{ new Date(g.fecha).getDate() }}</div>
                                                    <div class="text-uppercase" style="font-size: 0.7rem;">{{ obtenerNombreDia(g.fecha) }}</div>
                                                </td>
                                                <td>
                                                    <div class="fw-bold text-dark" style="font-size: 0.95rem;">{{ g.categoria }}</div>
                                                    <div class="small text-muted text-truncate" style="max-width: 200px;">{{ g.descripcion }}</div>
                                                </td>
                                                <td><span class="badge bg-light text-dark border fw-normal">{{ g.metodo }}</span></td>
                                                <td class="text-end pe-3">
                                                    <span class="fw-bold text-dark">{{ formatoMoneda(g.monto) }}</span>
                                                </td>
                                                <td class="text-end pe-3">
                                                    <button class="btn btn-sm btn-light text-danger border-0 hover-danger" @click="eliminarGasto(g)" title="Eliminar Gasto">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr v-if="gastosFiltrados.length === 0">
                                                <td colspan="5" class="text-center py-5">
                                                    <div class="text-muted opacity-50 mb-2"><i class="bi bi-inbox fs-1"></i></div>
                                                    <span class="text-muted small">Sin movimientos en este periodo</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

              <div class="modal fade" id="modalCategoria" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered modal-sm">
                    <div class="modal-content">
                        <div class="modal-header bg-warning">
                            <h5 class="modal-title fw-bold text-dark">{{ formCategoria.id_categoria ? 'Editar' : 'Nueva' }} Categor√≠a</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form @submit.prevent="guardarCategoria">
                                <div class="mb-3">
                                    <label class="form-label fw-bold small">Nombre</label>
                                    <input type="text" class="form-control" v-model="formCategoria.nombre" required placeholder="Ej: Bebidas, Limpieza...">
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-dark fw-bold">Guardar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
              </div>

            </div>
        </div>
      </div>
      
      <nav class="fixed-bottom bottom-nav d-md-none z-3" v-if="usuarioLogueado">
          <div class="d-flex justify-content-around">
              
              <a class="nav-item-mobile" :class="{active: vistaActual === 'dashboard'}" @click="vistaActual = 'dashboard'; cargarDashboard()">
                  <i class="bi bi-house-door"></i><span>Inicio</span>
              </a>

              <a v-if="tengoPermiso('ventas')" class="nav-item-mobile" :class="{active: vistaActual === 'ventas'}" @click="cambiarVista('ventas')">
                  <i class="bi bi-receipt"></i><span>Ventas</span>
              </a>

              <a v-if="tengoPermiso('compras')" class="nav-item-mobile" :class="{active: vistaActual === 'compras'}" @click="cambiarVista('compras')">
                  <i class="bi bi-cart-plus"></i><span>Compras</span>
              </a>

              <a v-if="tengoPermiso('productos')" class="nav-item-mobile" :class="{active: vistaActual === 'productos'}" @click="cambiarVista('productos')">
                  <i class="bi bi-box-seam"></i><span>Stock</span>
              </a>

              <a class="nav-item-mobile" data-bs-toggle="offcanvas" href="#menuMovil">
                  
                  <img v-if="usuarioLogueado.avatar" 
                       :src="usuarioLogueado.avatar" 
                       class="rounded-circle mb-1 border border-1"
                       style="width: 26px; height: 26px; object-fit: cover;">
                  
                  <i v-else class="bi bi-list"></i>
                  
                  <span>Men√∫</span>
              </a>

          </div>
      </nav>
      <div class="offcanvas offcanvas-end" tabindex="-1" id="menuMovil" style="width: 280px;">
          
          <div class="offcanvas-header bg-brand text-white">
              <h5 class="offcanvas-title fw-bold">
                  <i class="bi bi-grid-fill me-2"></i>Men√∫ Cesta
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
          </div>

          <div class="offcanvas-body p-0 d-flex flex-column">
            
            <div class="py-2">
                <button class="nav-mobile-btn" 
                        :class="{active: vistaActual === 'dashboard'}" 
                        @click="vistaActual = 'dashboard'; cargarDashboard(); cerrarMenuMovil()">
                    <i class="bi bi-house-door"></i> Inicio
                </button>

                <small v-if="tengoAlgunPermiso(['remisiones','ventas','compras','gastos','transferencias','cobranzas'])" 
                       class="text-muted text-uppercase fw-bold ps-3 mt-3 mb-1 d-block" style="font-size: 0.7rem;">
                    Operaciones
                </small>

                <button v-if="tengoPermiso('remisiones')" class="nav-mobile-btn" :class="{active: vistaActual === 'remisiones'}" @click="cambiarVista('remisiones'); cerrarMenuMovil()">
                    <i class="bi bi-truck-flatbed"></i> Notas de Remisi√≥n
                </button>

                <button v-if="tengoPermiso('ventas')" class="nav-mobile-btn" :class="{active: vistaActual === 'ventas'}" @click="cambiarVista('ventas'); cerrarMenuMovil()">
                    <i class="bi bi-receipt"></i> Ventas / Caja
                </button>
                
                <button v-if="tengoPermiso('compras')" class="nav-mobile-btn" :class="{active: vistaActual === 'compras'}" @click="cambiarVista('compras'); cerrarMenuMovil()">
                    <i class="bi bi-cart-plus"></i> Compras / Stock
                </button>

                <button v-if="tengoPermiso('gastos')" class="nav-mobile-btn" :class="{active: vistaActual === 'gastos'}" @click="cambiarVista('gastos'); cerrarMenuMovil()">
                    <i class="bi bi-cash-stack"></i> Gastos Operativos
                </button>

                <button v-if="tengoPermiso('transferencias')" class="nav-mobile-btn" :class="{active: vistaActual === 'transferencias'}" @click="cambiarVista('transferencias'); cerrarMenuMovil()">
                    <i class="bi bi-arrow-left-right"></i> Transferencias
                </button>
                
                <button v-if="tengoPermiso('cobranzas')" class="nav-mobile-btn" :class="{active: vistaActual === 'cobranzas'}" @click="cargarCobranzas(); cerrarMenuMovil()">
                    <i class="bi bi-wallet2"></i> Cobranzas
                </button>

                <small v-if="tengoAlgunPermiso(['productos','clientes','proveedores'])" 
                       class="text-muted text-uppercase fw-bold ps-3 mt-3 mb-1 d-block" style="font-size: 0.7rem;">
                    Gesti√≥n
                </small>
                
                <button v-if="tengoPermiso('productos')" class="nav-mobile-btn" :class="{active: vistaActual === 'productos'}" @click="cambiarVista('productos'); cerrarMenuMovil()">
                    <i class="bi bi-box-seam"></i> Inventario
                </button>
                
                <button v-if="tengoPermiso('clientes')" class="nav-mobile-btn" :class="{active: vistaActual === 'clientes'}" @click="cambiarVista('clientes'); cerrarMenuMovil()">
                    <i class="bi bi-people"></i> Clientes
                </button>

                <button v-if="tengoPermiso('proveedores')" class="nav-mobile-btn" :class="{active: vistaActual === 'proveedores'}" @click="cambiarVista('proveedores'); cerrarMenuMovil()">
                    <i class="bi bi-truck"></i> Proveedores
                </button>

                <small v-if="tengoAlgunPermiso(['reportes','usuarios','config'])" 
                       class="text-muted text-uppercase fw-bold ps-3 mt-3 mb-1 d-block" style="font-size: 0.7rem;">
                    Sistema
                </small>

                <button v-if="tengoPermiso('reportes')" class="nav-mobile-btn" :class="{active: vistaActual === 'reportes'}" @click="cambiarVista('reportes'); cerrarMenuMovil()">
                    <i class="bi bi-file-earmark-bar-graph"></i> Reportes
                </button>

                <button v-if="tengoPermiso('usuarios')" class="nav-mobile-btn" :class="{active: vistaActual === 'usuarios'}" @click="cambiarVista('usuarios'); cerrarMenuMovil()">
                    <i class="bi bi-person-badge"></i> Usuarios
                </button>

                <button v-if="tengoPermiso('config')" class="nav-mobile-btn" :class="{active: vistaActual === 'config'}" @click="cambiarVista('config'); cerrarMenuMovil()">
                    <i class="bi bi-gear"></i> Configuraci√≥n
                </button>
            </div>

            <div class="mt-auto"></div>

            <div class="border-top p-3 bg-light">
                <div class="d-flex align-items-center justify-content-between">
                    
                    <div class="d-flex align-items-center" 
                         @click="vistaActual = 'perfil'; cargarPerfil(); cerrarMenuMovil()">
                        
                        <div class="user-icon-brand text-white rounded-circle d-flex align-items-center justify-content-center me-2 overflow-hidden" 
                             style="width: 38px; height: 38px; min-width: 38px;">
                            
                            <img v-if="usuarioLogueado && usuarioLogueado.avatar" 
                                 :src="usuarioLogueado.avatar" 
                                 style="width: 100%; height: 100%; object-fit: cover;">
                            
                            <i v-else class="bi bi-person-fill fs-5"></i>
                        </div>

                        <div class="lh-1">
                            <div class="fw-bold text-dark small" v-if="usuarioLogueado">
                                {{ usuarioLogueado.nombre }}
                            </div>
                            <small class="text-muted" style="font-size: 0.7rem;" v-if="usuarioLogueado">
                                {{ usuarioLogueado.rol }}
                            </small>
                        </div>
                    </div>

                    <button class="btn btn-outline-danger btn-sm border-0" @click="logout(); cerrarMenuMovil()">
                        <i class="bi bi-box-arrow-right fs-4"></i>
                    </button>
                </div>
            </div>

          </div>
      </div>

      <div class="modal fade" id="modalDeposito" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-brand text-white"><h5 class="modal-title">Dep√≥sito</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form @submit.prevent="guardarDeposito"><div class="mb-3"><label>Nombre</label><input type="text" class="form-control" v-model="formDeposito.nombre" required></div><div class="mb-3"><label>Direcci√≥n</label><input type="text" class="form-control" v-model="formDeposito.direccion"></div><div class="row"><div class="col-6"><label>Responsable</label><input type="text" class="form-control" v-model="formDeposito.responsable"></div><div class="col-6"><label>Activo</label><select class="form-select" v-model="formDeposito.activo"><option>Si</option><option>No</option></select></div></div><div class="d-grid mt-3"><button type="submit" class="btn btn-brand">Guardar</button></div></form></div></div></div></div>

      <div class="modal fade" id="modalCampo" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-brand text-white"><h5 class="modal-title">Campo Personalizado</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form @submit.prevent="guardarCampo"><div class="mb-3"><label>Entidad</label><select class="form-select" v-model="formCampo.entidad_objetivo" required><option value="producto">Producto</option><option value="cliente">Cliente</option><option value="proveedor">Proveedor</option></select></div><div class="row g-2 mb-3"><div class="col-6"><label>Key (interno)</label><input type="text" class="form-control" v-model="formCampo.key_interno" required></div><div class="col-6"><label>Etiqueta Visible</label><input type="text" class="form-control" v-model="formCampo.etiqueta_visible" required></div></div><div class="mb-3"><label>Tipo</label><select class="form-select" v-model="formCampo.tipo_dato"><option value="text">Texto</option><option value="number">N√∫mero</option><option value="date">Fecha</option><option value="select">Lista</option></select></div><div class="mb-3" v-if="formCampo.tipo_dato === 'select'"><label>Opciones (x,y,z)</label><input type="text" class="form-control" v-model="formCampo.opciones_lista"></div><div class="form-check mb-3"><input class="form-check-input" type="checkbox" v-model="formCampo.es_obligatorio"><label>Obligatorio</label></div><div class="d-grid"><button type="submit" class="btn btn-brand">Guardar</button></div></form></div></div></div></div>

      <div class="modal fade" id="modalCliente" tabindex="-1" data-bs-backdrop="static">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header bg-brand text-white">
                    <h5 class="modal-title">{{ modoEdicion ? 'Editar' : 'Nuevo' }} Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body bg-light">
                      <form @submit.prevent="guardarCliente">
                          <div class="card border-0 shadow-sm mb-3">
                              <div class="card-body">
                                  <div class="mb-3">
                                      <label class="form-label text-secondary small fw-bold">Raz√≥n Social</label>
                                      <input type="text" class="form-control" v-model="formCliente.razon_social" required>
                                  </div>
                                  
                                  <div class="mb-3">
                                      <label class="form-label text-secondary small fw-bold">RUC</label>
                                      <input type="text" class="form-control" v-model="formCliente.doc_identidad" required>
                                  </div>

                                  <div class="mb-3">
                                      <label class="form-label text-secondary small fw-bold">Email</label>
                                      <input type="email" class="form-control" v-model="formCliente.email">
                                  </div>
                                  
                                  <div class="mb-3">
                                      <label class="form-label text-secondary small fw-bold">Tel√©fono</label>
                                      <input type="text" class="form-control" v-model="formCliente.telefono">
                                  </div>
                              </div>
                          </div>

                          <div v-if="camposExtraCliente.length > 0" class="card border-0 shadow-sm mb-3">
                              <div class="card-body">
                                  <div v-for="campo in camposExtraCliente" :key="campo.id_campo" class="mb-3">
                                      <label class="form-label text-secondary small fw-bold">{{ campo.etiqueta_visible }}</label>
                                      
                                      <select v-if="campo.tipo_dato === 'select'" class="form-select" v-model="formCliente.datos_adicionales[campo.key_interno]" :required="esObligatorio(campo.es_obligatorio)">
                                          <option value="">Seleccionar...</option>
                                          <option v-for="op in campo.opciones_lista.split(',')" :value="op.trim()">{{ op.trim() }}</option>
                                      </select>
                                      
                                      <input v-else :type="campo.tipo_dato" class="form-control" v-model="formCliente.datos_adicionales[campo.key_interno]" :required="esObligatorio(campo.es_obligatorio)">
                                  </div>
                              </div>
                          </div>

                          <button type="submit" class="btn btn-brand w-100 py-2 fw-bold">Guardar</button>
                      </form>
                  </div>
                </div>
              </div>
            </div>
      
      <div class="modal fade" id="modalProducto" tabindex="-1" data-bs-backdrop="static">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header bg-brand text-white">
                      <h5 class="modal-title">{{ modoEdicion ? 'Editar' : 'Nuevo' }} Producto</h5>
                      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body bg-light">
                        <form @submit.prevent="procesarGuardadoProducto">
                            
                            <div class="card border-0 shadow-sm mb-3">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-5 d-flex flex-column align-items-center justify-content-center border-end">
                                            <div class="mb-3 d-flex align-items-center justify-content-center bg-white border rounded" style="width: 100%; height: 180px; overflow: hidden;">
                                                <img v-if="imagenPreview" :src="imagenPreview" class="img-fluid" style="object-fit: contain; max-height: 100%;">
                                                <div v-else class="text-muted text-center">
                                                    <i class="bi bi-image fs-1 opacity-25"></i><br>
                                                    <small>Sin imagen</small>
                                                </div>
                                            </div>
                                            <input type="file" class="form-control form-control-sm" accept="image/*" @change="manejarArchivo">
                                        </div>

                                        <div class="col-md-7">
                                            <div class="mb-3">
                                                <label class="form-label text-secondary small fw-bold">Nombre del Producto</label>
                                                <input type="text" class="form-control" v-model="formProducto.nombre" required>
                                            </div>
                                        <div class="row g-2 mb-2">
                                            <div class="col-6">
                                                <label class="form-label text-secondary small fw-bold">SKU / C√≥digo</label>
                                                <input type="text" class="form-control" v-model="formProducto.sku" required>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label text-secondary small fw-bold">Precio Base</label>
                                                <input type="number" class="form-control" v-model="formProducto.precio_venta_base" required>
                                            </div>
                                        </div>

                                        <div class="row g-2 mt-2 bg-light p-2 rounded border">
                                            <div class="col-6">
                                                <label class="form-label small fw-bold text-dark">Tasa IVA %</label>
                                                <select class="form-select form-select-sm" v-model="formProducto.impuesto_iva">
                                                    <option value="10">10%</option>
                                                    <option value="5">5%</option>
                                                    <option value="0">Exenta</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label small fw-bold text-dark">M√©todo</label>
                                                <select class="form-select form-select-sm" v-model="formProducto.metodo_iva">
                                                    <option value="INCLUIDO">IVA Incluido</option>
                                                    <option value="EXCLUIDO">IVA Excluido (+)</option>
                                                </select>
                                            </div>
                                            <div class="col-12 text-end">
                                                <small class="text-muted" v-if="formProducto.metodo_iva === 'EXCLUIDO'">
                                                    Precio Final en Caja: <strong>{{ formatoMoneda(formProducto.precio_venta_base * (1 + (formProducto.impuesto_iva/100))) }}</strong>
                                                </small>
                                                <small class="text-muted" v-else>
                                                    El precio de lista ya incluye el impuesto.
                                                </small>
                                            </div>
                                        </div>
                                            </div>
                                            <div class="row g-2 mt-2">
                                                <div class="col-4">
                                                    <label class="form-label text-secondary small fw-bold">Categor√≠a</label>
                                                    <select class="form-select" v-model="formProducto.id_categoria" required>
                                                        <option v-for="c in listaCategorias" :value="c.id_categoria">{{c.nombre}}</option>
                                                    </select>
                                                </div>
                                                <div class="col-4">
                                                    <label class="form-label text-secondary small fw-bold">Stock M√≠nimo</label>
                                                    <input type="number" class="form-control" v-model="formProducto.stock_minimo">
                                                </div>
                                                <div class="col-4">
                                                  <label class="form-label text-secondary small fw-bold">Unidad de Medida</label>
                                                  <select class="form-select" v-model="formProducto.unidad_medida">
                                                      <option value="Unidad">Unidad</option>
                                                      <option value="Caja">Caja</option>
                                                      <option value="Kg">Kg</option>
                                                      <option value="Litro">Litro</option>
                                                      <option value="Metro">Metro</option>
                                                  </select>
                                              </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div v-if="camposExtraProducto.length > 0" class="card border-0 shadow-sm mb-3">
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-4" v-for="campo in camposExtraProducto" :key="campo.id_campo">
                                            <label class="form-label text-secondary small fw-bold mb-1">{{ campo.etiqueta_visible }}</label>
                                            
                                            <select v-if="campo.tipo_dato === 'select'" class="form-select" v-model="formProducto.datos_adicionales[campo.key_interno]" :required="esObligatorio(campo.es_obligatorio)">
                                                <option value="">Seleccionar...</option>
                                                <option v-for="op in campo.opciones_lista.split(',')" :value="op.trim()">{{ op.trim() }}</option>
                                            </select>
                                            
                                            <input v-else :type="campo.tipo_dato" class="form-control" v-model="formProducto.datos_adicionales[campo.key_interno]" :required="esObligatorio(campo.es_obligatorio)">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-brand w-100 py-2 fw-bold" @click="procesarGuardadoProducto"><i class="bi bi-save me-2"></i> Guardar </button>
                        </form>
                    </div>
                  </div>
                </div>
            </div>
      
      <div class="modal fade" id="modalProveedor" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header bg-brand text-white">
                  <h5 class="modal-title">{{ modoEdicion ? 'Editar' : 'Nuevo' }} Proveedor</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    <form @submit.prevent="guardarProveedor">
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Raz√≥n Social <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" v-model="formProveedor.razon_social" required placeholder="Nombre de la empresa">
                                </div>
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <label class="form-label fw-bold">Documento</label>
                                        <input type="text" class="form-control" v-model="formProveedor.doc_identidad" required placeholder="RUC / CI">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label fw-bold">Contacto</label>
                                        <input type="text" class="form-control" v-model="formProveedor.contacto" placeholder="Tel√©fono / Email">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div v-if="camposExtraProveedor.length > 0" class="card border-0 shadow-sm mb-3">
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-12" v-for="campo in camposExtraProveedor" :key="campo.id_campo">
                                        <label class="form-label small mb-1">{{ campo.etiqueta_visible }} <span v-if="esObligatorio(campo.es_obligatorio)" class="text-danger">*</span></label>
                                        <select v-if="campo.tipo_dato === 'select'" class="form-select form-select-sm" v-model="formProveedor.datos_adicionales[campo.key_interno]" :required="esObligatorio(campo.es_obligatorio)">
                                            <option value="">Seleccionar...</option>
                                            <option v-for="op in campo.opciones_lista.split(',')" :value="op.trim()">{{ op.trim() }}</option>
                                        </select>
                                        <input v-else :type="campo.tipo_dato" class="form-control form-control-sm" v-model="formProveedor.datos_adicionales[campo.key_interno]" :required="esObligatorio(campo.es_obligatorio)">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-brand fw-bold">Guardar</button>
                        </div>
                    </form>
                </div>
              </div>
            </div>
        </div>
    </div>    

    <div class="modal fade" id="modalScanner" tabindex="-1" data-bs-backdrop="static">
          <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                  <div class="modal-header bg-light text-dark"> 
                      <h5 class="modal-title"><i class="bi bi-qr-code-scan me-2"></i>Escanear Producto</h5>
                      <button type="button" class="btn-close btn-close-white" @click="detenerEscaner"></button>
                  </div>
                  <div class="modal-body p-0 bg-light">
                      <div id="reader" style="width: 100%;"></div>
                  </div>
                  <div class="modal-footer justify-content-center bg-light">
                      <small class="text-muted fw-bold">Apunta la c√°mara al c√≥digo de barras</small>
                  </div>
              </div>
          </div>
      </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const { createApp } = Vue;

      // --- CONFIGURACI√ìN DE NOTIFICACIONES (TOAST) ---
      const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true,
        didOpen: (toast) => {
            toast.addEventListener('mouseenter', Swal.stopTimer)
            toast.addEventListener('mouseleave', Swal.resumeTimer)
        }
      });

      createApp({
        data() {
          return {
                       
            cargando: false, subVistaVentas:'nueva', subVistaCompras:'nueva',
            chartInstance: null,
            productos: [], proveedores: [], clientes: [], listaDepositos: [], listaConfigCampos: [], listaCategorias: [], listaUnidades: [],
            
            usuarioLogueado: null,
            permisos: [],
            loginData: { usuario: '', password: '' },
            vistaActual: 'dashboard',

            html5QrcodeScanner: null, // Instancia del esc√°ner
            modalScanner: null,       // Instancia del modal Bootstrap

            perfilForm: {
                id_usuario: '',
                nombre: '',
                avatar: ''
            },
            passForm: {
                actual: '',
                nueva: '',
                confirmacion: ''
            },

            fechaHoy: new Date().toLocaleDateString(),
            dashboardData: {
                kpi: {
                    ventasHoy: 0,
                    ventasMes: 0,
                    gastosMes: 0,
                    stockBajo: 0
                },
                flujoCaja: {
                    ingresoActual: 0,
                    ingresoPasado: 0,
                    gastoActual: 0,
                    gastoPasado: 0,
                    balanceActual: 0
                },
              grafico: { 
                    labels: [], 
                    data: [] 
                }
            },

            reporteForm: {
                tipo: 'ventas',
                fechaInicio: new Date().toISOString().slice(0, 10),
                fechaFin: new Date().toISOString().slice(0, 10)
            },
            reporteData: {
                cabeceras: [],
                filas: [],
                totales: { suma: 0, conteo: 0 }
            },
            reporteBuscado: false,

            avataresDisponibles: [
                'https://api.dicebear.com/7.x/avataaars/svg?seed=Felix',
                'https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka',
                'https://api.dicebear.com/7.x/avataaars/svg?seed=Bob',
                'https://api.dicebear.com/7.x/avataaars/svg?seed=Callie',
                'https://api.dicebear.com/7.x/avataaars/svg?seed=Leo',
                'https://api.dicebear.com/7.x/avataaars/svg?seed=Zoe',
                'https://api.dicebear.com/7.x/avataaars/svg?seed=Jack'
            ],

            usuarioForm: {
                // ... otros campos ...
                avatar: '', // <--- CAMPO PARA GUARDAR LA URL
            },
            
            formDeposito: { nombre:'', direccion:'', responsable:'', activo:'Si' },
            formCampo: { entidad_objetivo:'producto', key_interno:'', etiqueta_visible:'', tipo_dato:'text', opciones_lista:'', es_obligatorio:false },
            configFacturaActual: '',

            formAjuste: { tipo: 'ENTRADA', id_producto: '', id_deposito: '', cantidad: 1, motivo: '' },

            formGasto: { fecha: new Date().toISOString().split('T')[0], categoria: '', descripcion: '', monto: 0, metodo: 'Efectivo' },
            listaGastos: [],
            filtroGastoMes: new Date().getMonth(), // Mes actual (0-11)
            filtroGastoAnio: new Date().getFullYear(), // A√±o actual
            mesesNombre: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],

            configRemisionActual: '', // Remision
            busquedaRemision: '',

            listaUsuarios: [],
            usuarioForm: {
                id_usuario: '',
                nombre: '',
                email: '',
                password: '',
                rol: 'OPERADOR',
                permisos: [],
                activo: 'SI'
            },

            historialCobranzas: [], // 
            busquedaCobranza: '',   // 
            subVistaCobranzas: 'listado',            
            
            subVistaRemision: 'nueva',
            historialRemisiones: [],
            carritoRemision: [],
            formRemision: { 
                fecha: new Date().toISOString().slice(0,10), 
                numero: '', 
                id_cliente: '', 
                id_deposito: '', 
                conductor: '', 
                chapa: '' 
            },
            lineaRemision: { id_producto: '', cantidad: 1 },

            formCategoria: { id_categoria: '', nombre: '' },
            modalCat: null, // Referencia al modal

            formVenta: { id_cliente:'', fecha: new Date().toISOString().slice(0,10), nro_factura: '' },
            lineaVenta: { id_producto:'', cantidad:1, precio:0 },
            carritoVenta: [], 
            busquedaVenta: '',
            historialVentas: [], 
            itemsDetalle: [],
            
            formCompra: { id_proveedor:'', fecha: new Date().toISOString().slice(0,10), comprobante: '' },
            lineaTemp: { id_producto:'', cantidad:'', costo:'' },
            carritoCompra: [], historialCompras: [],

            configGeneral: {}, // Para guardar toda la config
            depositoDefault: '', // Para el v-model del select de configuraci√≥n

            subVistaTransf: 'nueva', historialTransf: [], carritoTransf: [], formTransf: { fecha: new Date().toISOString().slice(0,10), origen: '', destino: '', responsable: 'Admin', observacion: '' }, lineaTransf: { id_producto: '', cantidad: 1 },

            // Nuevos datos para Cobranzas
            clientesDeudores: [],
            formCobro: { 
                id_cliente:'', 
                id_venta: '', // <--- IMPORTANTE: Agregado
                monto:0, 
                metodo:'Efectivo', 
                observacion:'', 
                nombre: '', 
                deuda_total: 0, // Esto ahora ser√° "Saldo Factura" visualmente
                nro_factura_visual: '' // Para mostrar en el modal
            },
            formProducto: { 
                nombre:'', sku:'', precio_venta_base:0, 
                impuesto_iva: 10, metodo_iva: 'INCLUIDO', // <--- AGREGAR ESTO
                datos_adicionales:{} 
            },
            formCliente: { razon_social:'', doc_identidad:'', email:'', datos_adicionales:{} }, 
            formProveedor: { razon_social:'', doc_identidad:'', contacto:'', datos_adicionales:{} },
            modoEdicion: false, archivoParaSubir: null, imagenPreview: null,
            modalDep: null, modalCmp: null, modalProd: null, modalCli: null, modalProv: null, modalDetalle: null
          }
        },
        computed: {
            camposExtraProducto() { return this.listaConfigCampos.filter(c => c.entidad_objetivo === 'producto'); },
            camposExtraCliente() { return this.listaConfigCampos.filter(c => c.entidad_objetivo === 'cliente'); },
            camposExtraProveedor() { return this.listaConfigCampos.filter(c => c.entidad_objetivo === 'proveedor'); },
            totalVenta() { return this.carritoVenta.reduce((acc, i) => acc + (i.cantidad * i.precio_final), 0); },
            totalIVA() {
                return this.carritoVenta.reduce((acc, item) => {
                    // Precio Final es lo que paga el cliente
                    const totalLinea = item.cantidad * item.precio_final;
                    const tasa = Number(item.tasa_iva);
                    
                    if (tasa === 0) return acc;

                    let montoIVA = 0;
                    if (tasa === 10) montoIVA = totalLinea / 11;
                    if (tasa === 5) montoIVA = totalLinea / 21;
                    
                    return acc + montoIVA;
                }, 0);
            },

            usaFiltroFecha() {
                const sinFecha = ['stock_deposito', 'productos_categoria', 'clientes', 'proveedores'];
                return !sinFecha.includes(this.reporteForm.tipo);
            },

            totalCompra() { return this.carritoCompra.reduce((acc, i) => acc + (i.cantidad * i.costo), 0); },
            cobranzasFiltradas() {
                if (!this.historialCobranzas) return [];
                if (!this.busquedaCobranza) return this.historialCobranzas;
                
                const texto = this.busquedaCobranza.toLowerCase().trim();
                return this.historialCobranzas.filter(item => {
                    const cliente = String(item.nombre_cliente || '').toLowerCase();
                    const obs = String(item.observacion || '').toLowerCase();
                    const metodo = String(item.metodo || '').toLowerCase();
                    
                    return cliente.includes(texto) || obs.includes(texto) || metodo.includes(texto);
                });
            },
          aniosDisponibles() {
              const actual = new Date().getFullYear();
              const anios = [];
              for(let i = 2023; i <= actual + 1; i++) anios.push(i);
              return anios.reverse(); // El m√°s reciente primero
          },

          // Filtra la lista completa seg√∫n los selectores
          gastosFiltrados() {
              if (!this.listaGastos) return [];
              return this.listaGastos.filter(g => {
                  // Convertimos la fecha del gasto (string ISO) a objeto Date
                  // Agregamos "T12:00:00" si viene solo fecha para evitar problemas de zona horaria
                  const fechaG = new Date(g.fecha);
                  return fechaG.getMonth() === this.filtroGastoMes && 
                        fechaG.getFullYear() === this.filtroGastoAnio;
              });
          },

          // Suma el total de lo que se ve en pantalla
          totalGastosFiltrados() {
              return this.gastosFiltrados.reduce((sum, item) => sum + item.monto, 0);
          },

          ventasFiltradas() {
              // 1. Blindaje contra errores (Airbag)
              if (!this.historialVentas || !Array.isArray(this.historialVentas)) {
                  return [];
              }

              // 2. Si no escriben nada, devolvemos todo
              if (!this.busquedaVenta) {
                  return this.historialVentas;
              }
              
              // 3. Filtrado (Cliente o Factura)
              const texto = this.busquedaVenta.toLowerCase().trim();
              
              return this.historialVentas.filter(item => {
                  const cliente = String(item.nombre_cliente || '').toLowerCase();
                  const factura = String(item.factura || '').toLowerCase();
                  
                  return cliente.includes(texto) || factura.includes(texto);
              });
           },
        
          remisionesFiltradas() {
              // 1. Si no existe la lista, devolvemos array vac√≠o (evita el error undefined)
              if (!this.historialRemisiones || !Array.isArray(this.historialRemisiones)) {
                  return [];
              }

              // 2. Si no hay b√∫squeda, devolvemos todo
              if (!this.busquedaRemision) {
                  return this.historialRemisiones;
              }
              
              // 3. Filtrado seguro
              const texto = this.busquedaRemision.toLowerCase().trim();
              return this.historialRemisiones.filter(item => {
                  // Forzamos conversi√≥n a string por si viene un n√∫mero o null
                  const n = String(item.numero || '').toLowerCase();
                  const c = String(item.cliente || '').toLowerCase();
                  return n.includes(texto) || c.includes(texto);
              });
            }
      },
      mounted() {
            // 1. Inicializar TODOS los componentes de Bootstrap (Modales)
            this.modalDep = new bootstrap.Modal(document.getElementById('modalDeposito'));
            this.modalCmp = new bootstrap.Modal(document.getElementById('modalCampo'));
            this.modalProd = new bootstrap.Modal(document.getElementById('modalProducto'));
            this.modalCli = new bootstrap.Modal(document.getElementById('modalCliente'));
            this.modalProv = new bootstrap.Modal(document.getElementById('modalProveedor'));
            this.modalDetalle = new bootstrap.Modal(document.getElementById('modalDetalle'));
            this.modalCat = new bootstrap.Modal(document.getElementById('modalCategoria'));
            
            // Referencia al modal del esc√°ner (Importante para el fix de c√°mara)
            const scannerElement = document.getElementById('modalScanner');
            this.modalScanner = new bootstrap.Modal(scannerElement);

            // --- ESC√ÅNER: FIX PARA APAGAR C√ÅMARA AL CERRAR ---
            scannerElement.addEventListener('hidden.bs.modal', () => {
                if (this.html5QrcodeScanner) {
                    try {
                        this.html5QrcodeScanner.stop().then(() => {
                            this.html5QrcodeScanner.clear();
                            this.html5QrcodeScanner = null;
                        }).catch(err => {
                            this.html5QrcodeScanner.clear();
                            this.html5QrcodeScanner = null;
                        });
                    } catch(e) { this.html5QrcodeScanner = null; }
                }
            });

            // 2. L√ìGICA DE SESI√ìN PERSISTENTE
            const tokenGuardado = localStorage.getItem('session_token');
            
            if (tokenGuardado) {
                this.cargando = true;
                google.script.run
                    .withSuccessHandler(res => {
                        this.cargando = false;
                        if (res) {
                            // ¬°Sesi√≥n v√°lida!
                            this.usuarioLogueado = res;
                            try { this.permisos = res.rol === 'ADMIN' ? ['todo'] : JSON.parse(res.modulos); } catch(e) { this.permisos = []; }
                            
                            // Solo cargamos datos si hay sesi√≥n
                            this.cargarDatosIniciales();
                            this.cargarDashboard();
                            
                            // Restaurar vista anterior si existe en history
                            if(history.state && history.state.vista) {
                                this.vistaActual = history.state.vista;
                            }
                        } else {
                            // Token inv√°lido/expirado
                            localStorage.removeItem('session_token');
                            this.usuarioLogueado = null;
                        }
                    })
                    .withFailureHandler(e => {
                        this.cargando = false;
                        console.error("Error al retomar sesi√≥n", e);
                        localStorage.removeItem('session_token');
                    })
                    .retomarSesion(tokenGuardado);
            } 
            // Nota: Si no hay token, no llamamos a cargarDatosIniciales() aqu√≠.
            // Se llamar√° cuando el usuario haga Login manual.

            // 3. CONFIGURACI√ìN DEL HISTORIAL (Bot√≥n Atr√°s)
            window.history.replaceState({ vista: 'ventas' }, null, '');
            window.onpopstate = (event) => {
                if (event.state && event.state.vista) {
                    this.vistaActual = event.state.vista;
                    this.cerrarMenuMovil();
                }
            };
        },
        methods: {
            // --- HELPER PARA NOTIFICACIONES ---
            notificar(icono, titulo) {
                Toast.fire({ icon: icono, title: titulo });
            },
            formatoMoneda(val) { if(!val) return 'Gs 0'; return new Intl.NumberFormat('es-PY').format(val); },
            cambiarVista(v) { 
                // 1. Si la vista es la misma, salimos
                if(this.vistaActual === v) return;

                // 2. Cambiamos la vista y subimos el scroll
                this.vistaActual = v; 
                window.scrollTo(0,0);
                
                // 3. Guardamos en el historial (Tu c√≥digo actual)
                window.history.pushState({ vista: v }, null, '');

                // 4. --- CARGA DE DATOS ESPEC√çFICA (LO NUEVO) ---
                // Si la vista a la que vamos es 'usuarios', cargamos la lista
                if (v === 'usuarios') {
                    this.cargarUsuarios();
                }
            },

            abrirEscaner() {
                this.modalScanner.show();
                
                // Esperamos 500ms a que el modal se dibuje para iniciar la c√°mara
                setTimeout(() => {
                    this.html5QrcodeScanner = new Html5Qrcode("reader");
                    
                    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                    
                    // 'environment' fuerza la c√°mara trasera del celular
                    this.html5QrcodeScanner.start({ facingMode: "environment" }, config, this.alEscanearExito)
                    .catch(err => {
                        this.modalScanner.hide();
                        // Usamos tu notificar (SweetAlert)
                        this.notificar('error', "No se pudo acceder a la c√°mara. Revisa los permisos.");
                        console.error(err);
                    });
                }, 500);
            },

            alEscanearExito(decodedText, decodedResult) {
                // 1. Detener esc√°ner inmediatamente para evitar lecturas dobles
                this.detenerEscaner(); 

                console.log(`C√≥digo escaneado: ${decodedText}`);

                // 2. Buscar producto por SKU (C√≥digo de barras) en tu lista local
                // Asumimos que el campo 'sku' es donde guardas el c√≥digo de barras
                const productoEncontrado = this.productos.find(p => String(p.sku).trim() === String(decodedText).trim());

                if (productoEncontrado) {
                    // 3. Efecto de sonido (Beep) - Opcional pero satisfactorio
                    const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
                    audio.play().catch(e => console.log("Audio bloqueado"));

                    // 4. Seleccionar el producto en el formulario
                    this.lineaVenta.id_producto = productoEncontrado.id_producto;
                    
                    // 5. Ejecutar la l√≥gica de precio (para cargar el precio correcto)
                    this.alSeleccionarProductoVenta();
                    
                    // 6. Notificar con SweetAlert (Toast)
                    this.notificar('success', "Encontrado: " + productoEncontrado.nombre);

                    // Opcional: ¬øQuieres que se agregue al carrito autom√°ticamente?
                    // Descomenta las siguientes 2 l√≠neas si quieres auto-agregar:
                    // this.lineaVenta.cantidad = 1;
                    // this.agregarAlCarritoVenta();

                } else {
                    this.notificar('warning', "Producto no encontrado: " + decodedText);
                    // Opcional: Volver a abrir el esc√°ner si fall√≥
                    // setTimeout(() => this.abrirEscaner(), 2000);
                }
            },

            detenerEscaner() {
                // Al ocultar el modal, se dispara el evento 'hidden.bs.modal' 
                // que definimos en mounted(), el cual apagar√° la c√°mara autom√°ticamente.
                this.modalScanner.hide();
            },

            renderizarGraficoVentas() {
                const ctx = document.getElementById('graficoVentas');
                if (!ctx) return; // Si no estamos en la vista dashboard, salir

                // Si ya existe un gr√°fico previo, lo destruimos para no encimar
                if (this.chartInstance) {
                    this.chartInstance.destroy();
                }

                // Crear nuevo gr√°fico
                this.chartInstance = new Chart(ctx, {
                    type: 'line', // Tipo de gr√°fico: L√≠nea
                    data: {
                        labels: this.dashboardData.grafico.labels,
                        datasets: [{
                            label: 'Ventas (Gs)',
                            data: this.dashboardData.grafico.data,
                            borderColor: '#E06920', // Tu color naranja
                            backgroundColor: 'rgba(224, 105, 32, 0.1)', // Naranja transparente
                            borderWidth: 2,
                            tension: 0.4, // Curva suave
                            fill: true,   // Relleno debajo de la l√≠nea
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#E06920',
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }, // Ocultar leyenda
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        // Formatear tooltip como moneda guaran√≠
                                        return 'Gs. ' + context.raw.toLocaleString('es-PY');
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { borderDash: [5, 5] },
                                ticks: {
                                    callback: function(value) {
                                        // Abreviar n√∫meros grandes (ej: 1M)
                                        if(value >= 1000000) return (value/1000000) + 'M';
                                        if(value >= 1000) return (value/1000) + 'K';
                                        return value;
                                    }
                                }
                            },
                            x: {
                                grid: { display: false }
                            }
                        }
                    }
                });
            },

            // M√©todo auxiliar para detectar si una celda debe verse como dinero
            esDinero(valor, index) {
                // L√≥gica simple: si es num√©rico y la cabecera dice 'Total', 'Monto', 'Costo' o 'Precio'
                const cabecera = this.reporteData.cabeceras[index].toLowerCase();
                return typeof valor === 'number' && 
                      (cabecera.includes('total') || cabecera.includes('monto') || cabecera.includes('costo') || cabecera.includes('precio'));
            },

            formatoFecha(f) {
                if(!f) return '';
                return new Date(f).toLocaleDateString('es-ES'); // O 'es-PY'
            },

            // --- FUNCI√ìN QUE FALTA PARA EL FORMULARIO ---
              cargarReporte() {
                  this.cargando = true;
                  this.reporteData = { cabeceras: [], filas: [], totales: { suma: 0, conteo: 0 } }; // Limpiar anterior
                  
                  google.script.run
                      .withSuccessHandler(res => {
                          this.cargando = false;
                          this.reporteBuscado = true;
                          this.reporteData = res;
                      })
                      .withFailureHandler(error => {
                          this.cargando = false;
                          this.notificar('error', "Error al generar el reporte: " + error);
                      })
                      .generarReporte(JSON.parse(JSON.stringify(this.reporteForm))); 
                      // Usamos JSON.parse/stringify para enviar una copia limpia del objeto
              },

            // --- FUNCI√ìN PARA GENERAR Y DESCARGAR CSV ---
            exportarCSV() {
                if (this.reporteData.filas.length === 0) return;

                // 1. Unir cabeceras
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // UTF-8 BOM para Excel
                csvContent += this.reporteData.cabeceras.join(",") + "\n";

                // 2. Unir filas
                this.reporteData.filas.forEach(fila => {
                    let filaString = fila.map(campo => {
                        // Escapar comillas y manejar textos con comas
                        let str = String(campo).replace(/"/g, '""'); 
                        return `"${str}"`;
                    }).join(",");
                    csvContent += filaString + "\n";
                });

                // 3. Descargar
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `Reporte_${this.reporteForm.tipo}_${this.reporteForm.fechaInicio}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            cargarDashboard() {
                this.cargando = true;
                google.script.run
                    .withSuccessHandler(res => {
                        this.cargando = false;
                        
                        // 1. Asignamos los datos
                        this.dashboardData = res;
                        
                        // 2. ¬°IMPORTANTE! Dibujamos el gr√°fico una vez que los datos llegaron
                        this.$nextTick(() => {
                            this.renderizarGraficoVentas();
                        });
                    })
                    .withFailureHandler(error => {
                        this.cargando = false;
                        console.error(error);
                    })
                    .obtenerDatosDashboard();
            },

            formatoMoneda(valor) {
                // Formato para Paraguay (Guaran√≠es) o D√≥lares seg√∫n prefieras
                // Ajusta 'es-PY' y 'PYG' si usas Guaran√≠es
                return new Intl.NumberFormat('es-PY', { style: 'currency', currency: 'PYG' }).format(valor);
            },

            calcularPorcentajeGasto() {
                const ingresos = this.dashboardData.flujoCaja.ingresoActual;
                const gastos = this.dashboardData.flujoCaja.gastoActual;
                
                if (ingresos === 0) return 0; // Evitar divisi√≥n por cero
                
                let porcentaje = (gastos / ingresos) * 100;
                // Limitamos visualmente al 100% para que no rompa la barra si gastas m√°s de lo que ganas
                return porcentaje > 100 ? 100 : porcentaje;
            },

            cargarPerfil() {
                const copia = JSON.parse(JSON.stringify(this.usuarioLogueado));
                this.perfilForm = {
                    id_usuario: copia.id_usuario,
                    nombre: copia.nombre,
                    avatar: copia.avatar || ''
                };
                // Limpiamos el formulario de password por seguridad
                this.passForm = { actual: '', nueva: '', confirmacion: '' };
            },

            guardarDatosPersonales() {
                this.cargando = true;
                google.script.run
                    .withSuccessHandler(res => {
                        this.cargando = false;
                        this.usuarioLogueado = res.usuarioActualizado;
                        this.notificar('success', "Datos personales actualizados.");
                    })
                    .actualizarDatosPersonales(this.perfilForm);
            },

            cambiarPassword() {
                if (this.passForm.nueva !== this.passForm.confirmacion) {
                    return this.notificar('warning', "Las contrase√±as no coinciden.");
                }
                this.cargando = true;
                google.script.run
                    .withSuccessHandler(() => {
                        this.cargando = false;
                        this.notificar('success', "Contrase√±a actualizada. Inicia sesi√≥n de nuevo.");
                        this.logout(); 
                    })
                    .withFailureHandler(error => {
                        this.cargando = false;
                        this.notificar('error', error); 
                    })
                    .cambiarPassword(this.usuarioLogueado.id_usuario, this.passForm.actual, this.passForm.nueva);
            },

            guardarMiPerfil() {
                Swal.fire({
                    title: '¬øGuardar cambios?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'S√≠, guardar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.cargando = true;
                        google.script.run
                            .withSuccessHandler(res => {
                                this.cargando = false;
                                this.usuarioLogueado = res.usuarioActualizado;
                                this.notificar('success', "Perfil actualizado correctamente");
                                this.vistaActual = 'dashboard';
                            })
                            .withFailureHandler(error => {
                                this.cargando = false;
                                this.notificar('error', "Error: " + error);
                            })
                            .actualizarMiPerfil(this.perfilForm);
                    }
                });
            },

            editarUsuario(u) {
                this.usuarioForm = {
                    // ... otros campos ...
                    rol: u.rol,
                    permisos: this.parsearPermisos(u.modulos),
                    activo: u.activo,
                    avatar: u.avatar || '' 
                };
            },

            // Funci√≥n auxiliar para ocultar t√≠tulos de secci√≥n vac√≠os
            tengoAlgunPermiso(listaPermisos) {
                // Recorre la lista y si tiene permiso AL MENOS para uno, devuelve TRUE
                return listaPermisos.some(permiso => this.tengoPermiso(permiso));
            },

            iniciarSesion() {
                this.cargando = true;
                google.script.run
                    .withSuccessHandler(res => {
                        this.cargando = false;
                        this.usuarioLogueado = res;
                        
                        // --- NUEVO: Guardar sesi√≥n persistente ---
                        if (res.token) {
                            localStorage.setItem('session_token', res.token);
                        }
                        // ----------------------------------------

                        try { this.permisos = res.rol === 'ADMIN' ? ['todo'] : JSON.parse(res.modulos); } catch(e) { this.permisos = []; }
                        this.cargarDatosIniciales();
                        this.cargarDashboard();
                        this.notificar('success', `Bienvenido, ${res.nombre}`);
                    })
                    .withFailureHandler(e => {
                        this.cargando = false;
                        this.notificar('error', "Error: " + e);
                    })
                    .loginUsuario(this.loginData.usuario, this.loginData.password);
            },

            cargarUsuarios() {
                if (!this.tengoPermiso('usuarios')) return;
                this.cargando = true;
                google.script.run
                    .withSuccessHandler(res => {
                        this.cargando = false;
                        this.listaUsuarios = res;
                    })
                    .obtenerUsuarios();
            },

            prepararNuevoUsuario() {
                this.usuarioForm = {
                    id_usuario: '',
                    nombre: '',
                    email: '',
                    password: '',
                    rol: 'OPERADOR',
                    permisos: [], // Array vac√≠o para checkboxes
                    activo: 'SI'
                };
            },

            editarUsuario(u) {
                // Clonamos el objeto para no editar la lista directamente antes de guardar
                this.usuarioForm = {
                    id_usuario: u.id_usuario,
                    nombre: u.nombre,
                    email: u.email,
                    password: u.password,
                    rol: u.rol,
                    permisos: this.parsearPermisos(u.modulos), // Convertir string JSON a Array
                    activo: u.activo
                };
            },

            guardarUsuario() {
                this.cargando = true;
                // Si es admin, forzamos permiso 'todo'
                if(this.usuarioForm.rol === 'ADMIN') {
                    this.usuarioForm.permisos = ['todo'];
                }
                
                google.script.run
                    .withSuccessHandler(() => {
                        this.cargando = false;
                        this.notificar('success', "Usuario guardado correctamente.");
                        this.cargarUsuarios();
                        this.prepararNuevoUsuario();
                    })
                    .guardarUsuario(this.usuarioForm);
            },

            eliminarUsuario(u) {
                if (!confirm("¬øEliminar al usuario " + u.nombre + "?")) return;
                if (u.rol === 'ADMIN' && u.id_usuario === '1') {
                    this.notificar('error', "No puedes eliminar al Admin principal.");
                    return;
                }
                
                this.cargando = true;
                google.script.run
                    .withSuccessHandler(() => {
                        this.cargando = false;
                        this.cargarUsuarios();
                    })
                    .eliminarUsuario(u.id_usuario);
            },

            parsearPermisos(jsonStr) {
                try {
                    return JSON.parse(jsonStr) || [];
                } catch(e) { return []; }
            },

            tengoPermiso(modulo) {
                if (!this.usuarioLogueado) return false;
                if (this.usuarioLogueado.rol === 'ADMIN') return true;
                return this.permisos.includes(modulo);
            },

            // Funci√≥n auxiliar para verificar permisos en el HTML
            tengoPermiso(modulo) {
                if (!this.usuarioLogueado) return false;
                if (this.usuarioLogueado.rol === 'ADMIN') return true;
                return this.permisos.includes(modulo);
            },

            logout() {
                Swal.fire({
                    title: '¬øCerrar Sesi√≥n?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'S√≠, salir',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const token = localStorage.getItem('session_token');
                        if (token) google.script.run.cerrarSesionServidor(token);

                        // Borrar del navegador
                        localStorage.removeItem('session_token');
                        
                        this.usuarioLogueado = null;
                        this.loginData = { usuario: '', password: '' };
                        this.vistaActual = 'dashboard';
                    }
                });
            },

            obtenerNombreDia(fechaStr) {
            const dias = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            return dias[new Date(fechaStr).getDay()];
            },

            guardarGasto() {
                if (this.formGasto.monto <= 0) return this.notificar('error', "El monto debe ser mayor a 0.");
                this.cargando = true;

                google.script.run
                    .withSuccessHandler(() => {
                        this.cargando = false;
                        this.notificar('success', "Gasto registrado.");

                        // Reset del formulario
                        this.formGasto = { 
                            fecha: new Date().toISOString().split('T')[0], 
                            categoria: '', 
                            descripcion: '', 
                            monto: 0, 
                            metodo: 'Efectivo' 
                        };

                        // Recargar lista
                        this.cargarGastos();
                    })
                    .withFailureHandler(e => {
                        this.cargando = false;
                        this.notificar('error', "Error: " + e);
                    })
                    .guardarGasto(this.formGasto);
            },

            cargarGastos() {
                // Solo cargar si la vista es gastos (opcional para optimizar)
                this.cargando = true;
                google.script.run
                    .withSuccessHandler(res => {
                        this.cargando = false;
                        this.listaGastos = res || [];
                    })
                    .withFailureHandler(e => {
                        this.cargando = false;
                        console.error(e);
                    })
                    .obtenerGastos();
            },

            eliminarGasto(item) {
                Swal.fire({
                    title: '¬øEliminar Gasto?',
                    text: `${item.categoria}: ${this.formatoMoneda(item.monto)}`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'S√≠, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.cargando = true;
                        
                        // 1. Obtenemos el usuario para la bit√°cora
                        const usuario = this.usuarioLogueado ? this.usuarioLogueado.nombre : 'Operador';

                        google.script.run
                            .withSuccessHandler(() => {
                                this.cargando = false;
                                this.notificar('success', "Gasto eliminado.");
                                this.cargarGastos(); 
                            })
                            .withFailureHandler(e => {
                                this.cargando = false;
                                this.notificar('error', "Error: " + e);
                            })
                            // 3. Enviamos ID y USUARIO al backend
                            .eliminarGasto(item.id_gasto, usuario);
                    }
                });
            },
          guardarAjuste() {
              if (!this.formAjuste.id_producto || !this.formAjuste.id_deposito) return this.notificar('warning', "Completa todos los datos.");
              if (this.formAjuste.cantidad <= 0) return this.notificar('warning', "Cantidad inv√°lida.");

              Swal.fire({ 
                  title: '¬øConfirmar Ajuste?', 
                  text: `${this.formAjuste.tipo} de ${this.formAjuste.cantidad} unidades`, 
                  icon: 'warning', 
                  showCancelButton: true, 
                  confirmButtonText: 'S√≠, confirmar' 
              })
              .then((result) => {
                  if(result.isConfirmed) {
                      this.cargando = true;
                      google.script.run.withSuccessHandler(() => {
                          this.cargando = false;
                          this.notificar('success', "Ajuste registrado.");
                          this.formAjuste.cantidad = 1; 
                          this.formAjuste.motivo = '';
                          this.cargarDatosIniciales();
                      })
                      .withFailureHandler(e => {
                          this.cargando = false;
                          this.notificar('error', e);
                      })
                      .guardarAjusteStock(this.formAjuste);
                  }
              });
            },
            
            cerrarMenuMovil() {
                const menuEl = document.getElementById('menuMovil');
                const menuBS = bootstrap.Offcanvas.getOrCreateInstance(menuEl);
                if (menuBS) menuBS.hide();
            },

            cargarHistorialCobranzas() {
                this.subVistaCobranzas = 'historial';
                this.cargando = true;
                this.historialCobranzas = [];
                
                google.script.run
                    .withSuccessHandler(res => {
                        this.cargando = false;
                        this.historialCobranzas = res || [];
                    })
                    .withFailureHandler(e => {
                        this.cargando = false;
                        this.notificar('error', "Error: " + e);
                    })
                    .obtenerHistorialCobranzas();
            },

            abrirModalCategoria(item) {
                this.formCategoria = item ? { ...item } : { id_categoria: '', nombre: '' };
                this.modalCat.show();
            },

          guardarCategoria() {
                if (!this.formCategoria.nombre) return this.notificar('warning', "Escribe un nombre para la categor√≠a");
                
                this.cargando = true;
                google.script.run.withSuccessHandler(() => {
                        this.cargando = false;
                        this.modalCat.hide();
                        this.cargarDatosIniciales(); 
                        this.notificar('success', "Categor√≠a guardada correctamente");
                    })
                    .withFailureHandler(e => {
                        this.cargando = false;
                        this.notificar('error', "Error: " + e);
                    })
                    .guardarCategoria(this.formCategoria);
            },

            eliminarCategoria(item) {
                Swal.fire({ 
                    title: `¬øEliminar '${item.nombre}'?`, 
                    text: "Verifica que no tenga productos asociados antes de borrar.", 
                    icon: 'warning', 
                    showCancelButton: true, 
                    confirmButtonColor: '#d33', 
                    confirmButtonText: 'S√≠, eliminar' 
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.cargando = true;
                        google.script.run.withSuccessHandler(() => {
                            this.cargando = false;
                            this.cargarDatosIniciales();
                            this.notificar('success', "Categor√≠a eliminada");
                        })
                        .withFailureHandler(e => {
                            this.cargando = false;
                            this.notificar('error', "Error: " + e);
                        })
                        .eliminarCategoria(item.id_categoria);
                    }
                });
            },

            esObligatorio(v) { return v === true || v === 'TRUE'; },
            
            cargarDatosIniciales() {
                this.cargando = true;
                Promise.all([
                    new Promise(r => google.script.run.withSuccessHandler(r).obtenerProductosConStock()), 
                    this.pedirDatos('PROVEEDORES'), 
                    new Promise(r => google.script.run.withSuccessHandler(r).obtenerClientes()),
                    this.pedirDatos('CATEGORIAS'), 
                    this.pedirDatos('UNIDADES'),
                    new Promise(r => google.script.run.withSuccessHandler(r).obtenerConfigCampos()),
                    new Promise(r => google.script.run.withSuccessHandler(r).obtenerDepositos()),
                    new Promise(r => google.script.run.withSuccessHandler(r).obtenerConfigFactura()),
                    new Promise(r => google.script.run.withSuccessHandler(r).obtenerConfigGeneral()),
                    new Promise(r => google.script.run.withSuccessHandler(r).obtenerConfigRemision())
                ]).then(res => {
                    this.productos = res[0]; 
                    this.proveedores = res[1]; 
                    this.clientes = res[2];
                    this.listaCategorias = res[3]; 
                    this.listaUnidades = res[4];
                    this.listaConfigCampos = res[5] || [];
                    this.listaDepositos = res[6] || [];
                    this.configFacturaActual = res[7];
                    this.configGeneral = res[8] || {};
                    this.configRemisionActual = res[9];
                    // Extraemos el dep√≥sito default o dejamos vac√≠o si no existe
                    this.depositoDefault = this.configGeneral['DEPOSITO_DEFAULT'] || '';

                    // üëá 3. APLICAMOS EL DEFAULT AL FORMULARIO DE VENTA
                    // Si existe un default configurado, lo pre-seleccionamos.
                    // Si no, forzamos "1" (Dep√≥sito Central) como respaldo.
                    this.formVenta.id_deposito = this.depositoDefault || '1';

                    this.cargando = false;
                });
              },

            anularRemision(h) {
                if(!confirm("‚ö†Ô∏è ¬øEst√°s seguro de ANULAR la Remisi√≥n Nro: " + h.numero + "?\n\nEl stock de los productos volver√° al dep√≥sito de origen.")) return;
                
                this.cargando = true;
                google.script.run
                    .withSuccessHandler(() => {
                        this.cargando = false;
                        this.notificar('success', "Remisi√≥n anulada correctamente.\nEl stock ha sido devuelto.");
                        this.cargarHistorialRemisiones(); // Refrescar lista
                        this.cargarDatosIniciales(); // Refrescar stock visual global
                    })
                    .withFailureHandler(e => {
                        this.cargando = false;
                        this.notificar('success', "Error al anular: " + e);                        
                    })
                    .anularRemision(h.id_remision);
            },

            guardarConfigRemision() {
                this.cargando = true;
                const usuario = this.usuarioLogueado ? this.usuarioLogueado.nombre : 'Operador';

                google.script.run.withSuccessHandler(() => {
                    this.cargando = false;
                    this.notificar('success', "Secuencia de remisi√≥n actualizada");
                })
                .guardarConfigRemision(this.configRemisionActual, usuario);
            },

            // L√ìGICA DE REMISI√ìN MEJORADA (CON PRECIOS Y AUTO-NUM)
            agregarAlCarritoRemision() {
                if(!this.lineaRemision.id_producto || this.lineaRemision.cantidad < 1) return;

                // Buscamos el producto para obtener su precio y nombre
                const p = this.productos.find(x => x.id_producto == this.lineaRemision.id_producto);

                if (p) {
                    this.carritoRemision.push({ 
                        ...this.lineaRemision, 
                        nombre_prod: p.nombre,
                        // Usamos el precio base como referencia para valorizar
                        precio: p.precio_venta_base 
                    });
                    this.lineaRemision = { id_producto: '', cantidad: 1 };
                }
            },

          guardarRemisionFinal() {
                if(!this.formRemision.id_cliente || !this.formRemision.id_deposito || this.carritoRemision.length === 0) {
                    return this.notificar('warning', "Faltan datos en la remisi√≥n.");
                }
                
                this.cargando = true;
                const cli = this.clientes.find(c => c.id_cliente == this.formRemision.id_cliente);
                const paquete = { 
                    ...this.formRemision, 
                    items: this.carritoRemision, 
                    nombre_cliente: cli ? cli.razon_social : 'Cliente' 
                };

                google.script.run.withSuccessHandler(res => {
                        this.cargando = false;
                        if(res.pdf_url) window.open(res.pdf_url, '_blank');
                        this.notificar('success', `Remisi√≥n ${res.numero} generada`);
                        this.carritoRemision = [];
                        this.cargarDatosIniciales(); 
                    })
                    .withFailureHandler(e => {
                        this.cargando = false;
                        this.notificar('error', "Error al guardar remisi√≥n: " + e);
                    })
                    .guardarRemision(paquete);
            },

          facturarDesdeRemision(h) {
                Swal.fire({
                    title: `Facturar Remisi√≥n ${h.numero}`,
                    text: "¬øDeseas generar la factura ahora?",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'S√≠, facturar',
                    footer: 'Se usar√° la condici√≥n de venta que elijas a continuaci√≥n.'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Reemplazo de PROMPT por SWAL con SELECT
                        Swal.fire({
                            title: 'Condici√≥n de Venta',
                            input: 'select',
                            inputOptions: { 'CONTADO': 'Contado', 'CREDITO': 'Cr√©dito' },
                            inputPlaceholder: 'Selecciona una opci√≥n',
                            showCancelButton: true,
                            inputValidator: (value) => { return new Promise((resolve) => { if (value) { resolve() } else { resolve('Debes seleccionar una opci√≥n') } }) }
                        }).then((inputResult) => {
                            if (inputResult.isConfirmed) {
                                const condicion = inputResult.value;
                                this.cargando = true;
                                google.script.run.withSuccessHandler(itemsRemision => {
                                    if(!itemsRemision || itemsRemision.length === 0) {
                                        this.cargando = false;
                                        return this.notificar('error', "No se pudieron recuperar los items.");
                                    }
                                    const paqueteVenta = {
                                        id_cliente: h.id_cliente_raw, 
                                        id_deposito: h.id_deposito_raw || this.depositoDefault || '1', 
                                        fecha: new Date().toISOString().slice(0,10),
                                        nro_factura: '', 
                                        condicion: condicion,
                                        items: itemsRemision, 
                                        es_desde_remision: true,
                                        id_remision_origen: h.id_remision
                                    };
                                    google.script.run.withSuccessHandler(res => {
                                        google.script.run.withSuccessHandler(() => {
                                            this.cargando = false;
                                            this.notificar('success', `Factura ${condicion} generada.`);
                                            this.cargarHistorialRemisiones(); 
                                        }).facturarRemision({ id_remision: h.id_remision });
                                        if(res.pdf_url) window.open(res.pdf_url, '_blank');
                                    }).guardarVenta(paqueteVenta);
                                }).obtenerDetalleRemisionParaFacturar(h.id_remision);
                            }
                        });
                    }
                });
            },

            cargarHistorialRemisiones() {
                this.subVistaRemision = 'historial';
                this.cargando = true;
                
                // 1. Limpieza preventiva
                this.historialRemisiones = []; 

                google.script.run
                    .withSuccessHandler(r => {
                        // 2. BLINDAJE: Si 'r' es nulo o undefined, usar array vac√≠o []
                        if (!r || !Array.isArray(r)) {
                            console.warn("El backend no devolvi√≥ una lista v√°lida:", r);
                            this.historialRemisiones = [];
                        } else {
                            this.historialRemisiones = r;
                        }
                        
                        this.cargando = false;
                    })
                    .withFailureHandler(e => {
                        console.error("Error backend:", e);
                        this.cargando = false;
                        this.historialRemisiones = []; // Evitamos que quede undefined
                        this.notificar('error', "Error cargando historial: " + e);
                    })
                    .obtenerHistorialRemisiones();
            },

            cargarCobranzas() {
                this.vistaActual = 'cobranzas';
                this.subVistaCobranzas = 'listado';
                this.cargando = true;
                this.clientesDeudores = [];

                //"PASO 1: El bot√≥n funciona. Llamando al servidor...");

                google.script.run
                    .withSuccessHandler(respuesta => {
                        this.cargando = false;
                        try {
                            // Parseamos la respuesta
                            const paquete = JSON.parse(respuesta);
                            
                            // 1. IMPRIMIR LOGS DEL SERVIDOR (IMPORTANTE)
                            console.log("=== LOGS DEL SERVIDOR ===");
                            console.log(paquete.logs.join("\n"));
                            
                            // Si no hay datos, mostrar alerta con los logs para diagnosticar
                            if (!paquete.datos || paquete.datos.length === 0) {
                                this.notificar('error', "ALERTA DE DEBUG:\n" + paquete.logs.join("\n"));
                            }

                            // 2. ASIGNAR DATOS
                            this.clientesDeudores = paquete.datos || [];

                        } catch (e) {
                            this.notificar('error', "Error cr√≠tico leyendo respuesta: " + e.message);
                        }
                    })
                    .withFailureHandler(e => {
                        this.cargando = false;
                        this.notificar('error', "Error de conexi√≥n: " + e);
                    })
                    .obtenerClientesConDeuda();
            },
            abrirCobro(factura, cliente) {
                this.formCobro = { 
                    id_cliente: cliente.id_cliente,
                    id_venta: factura.id_venta, // Guardamos ID Factura
                    monto: 0, 
                    metodo: 'Efectivo', 
                    observacion: '', 
                    nombre: cliente.nombre, 
                    deuda_total: factura.saldo, // Ahora el l√≠mite es el saldo de ESTA factura
                    nro_factura_visual: factura.numero 
                };
                this.subVistaCobranzas = 'nuevo';
            },
            guardarCobro() {
                if(this.formCobro.monto <= 0) return this.notificar('error', "Monto inv√°lido");
                
                // Validaci√≥n estricta del saldo
                if(this.formCobro.monto > this.formCobro.deuda_total) {
                    return this.notificar('error', "Error: No puedes cobrar m√°s del saldo pendiente de esta factura (" + this.formatoMoneda(this.formCobro.deuda_total) + ")");
                }
                
                this.cargando = true;
                google.script.run
                    .withSuccessHandler(() => {
                        this.cargando = false;
                        this.notificar('error', "Pago aplicado a la factura " + this.formCobro.nro_factura_visual);
                        this.subVistaCobranzas = 'listado';
                        this.cargarCobranzas(); 
                    })
                    .withFailureHandler(e => {
                        this.cargando = false;
                        this.notificar('error', "Error: " + e);
                    })
                    .registrarCobro(this.formCobro);
            },

            agregarAlCarritoTransf() {
                  if(this.formTransf.origen === this.formTransf.destino) {
                      return this.notificar('warning', "El dep√≥sito de Origen y Destino son iguales.");
                  }
                  const p = this.productos.find(x => x.id_producto == this.lineaTransf.id_producto);
                  if(!p) return;
                  
                  this.carritoTransf.push({ ...this.lineaTransf, nombre: p.nombre, sku: p.sku });
                  this.lineaTransf = { id_producto: '', cantidad: 1 };
              },
              quitarCarritoTransf(i) { this.carritoTransf.splice(i,1); },
              limpiarTransf() { this.carritoTransf=[]; this.formTransf.observacion=''; },
            guardarTransfFinal() {
                  if(!this.formTransf.origen || !this.formTransf.destino || this.carritoTransf.length === 0) {
                      return this.notificar('warning', "Completa origen, destino y agrega productos.");
                  }
                  
                  this.cargando = true;
                  const pkg = { ...this.formTransf, items: this.carritoTransf };
                  
                  google.script.run.withSuccessHandler(res => {
                      this.cargando = false;
                      if(res.pdf_url) window.open(res.pdf_url, '_blank');
                      
                      this.notificar('success', "Transferencia realizada con √©xito");
                      this.limpiarTransf();
                      this.cargarDatosIniciales(); 
                  }).withFailureHandler(e => {
                      this.cargando = false;
                      this.notificar('error', "Error: " + e);
                  }).guardarTransferencia(pkg);
              },
              cargarHistorialTransf() {
                  this.subVistaTransf='historial';
                  this.cargando=true;
                  google.script.run.withSuccessHandler(r => {
                      this.historialTransf = r;
                      this.cargando=false;
                  }).obtenerHistorialTransferencias();
              },

            pedirDatos(hoja) { return new Promise(r => google.script.run.withSuccessHandler(r).getData(hoja)); },

            // Generar Ticket
          imprimirTicket(h) {
                this.cargando = true;
                google.script.run.withSuccessHandler(url => {
                        this.cargando = false;
                        window.open(url, 'Ticket', 'width=400,height=600');
                    })
                    .withFailureHandler(err => {
                        this.cargando = false;
                        this.notificar('error', "Error al generar ticket: " + err);
                    })
                    .generarUrlTicket(h.id_venta);
            },
            
            // Helpers
            obtenerNombreCategoria(id) { const c = this.listaCategorias.find(x => x.id_categoria == id); return c ? c.nombre : '...'; },
            obtenerEtiquetaCampo(key) { const c = this.listaConfigCampos.find(x => x.key_interno === key); return c ? c.etiqueta_visible : key; },
            tieneDatosValidos(item) { if (!item.datos_adicionales) return false; return Object.values(item.datos_adicionales).some(val => val && val.toString().trim() !== ''); },
            obtenerNombreProducto(id) { const p = this.productos.find(x => x.id_producto == id); return p ? p.nombre : '...'; },

            // CONFIG
            abrirModalDeposito(item) { this.formDeposito = item ? {...item} : { nombre:'', direccion:'', responsable:'', activo:'Si' }; this.modalDep.show(); },
            guardarDeposito() { this.cargando = true; google.script.run.withSuccessHandler(() => { this.cargando=false; this.modalDep.hide(); this.cargarDatosIniciales(); }).guardarDeposito(this.formDeposito); },

          eliminarDeposito(item) { 
                Swal.fire({ 
                    title: '¬øEliminar Dep√≥sito?', 
                    text: item.nombre,
                    icon: 'warning', 
                    showCancelButton: true, 
                    confirmButtonColor: '#d33', 
                    confirmButtonText: 'S√≠, eliminar' 
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.cargando = true; 
                        google.script.run.withSuccessHandler(res => { 
                            this.cargando = false; 
                            if(res.error) {
                                this.notificar('error', res.error);
                            } else { 
                                this.cargarDatosIniciales(); 
                                this.notificar('success', 'Dep√≥sito eliminado'); 
                            } 
                        }).eliminarDeposito(item.id_deposito); 
                    }
                });
            },

            abrirModalCampo(item) { 
                this.formCampo = item ? {...item} : { entidad_objetivo:'producto', key_interno:'', etiqueta_visible:'', tipo_dato:'text', opciones_lista:'', es_obligatorio:false }; 
                  if(this.formCampo.entidad_objetivo) {
                    this.formCampo.entidad_objetivo = this.formCampo.entidad_objetivo.toLowerCase();
                }
                this.modalCmp.show(); 
            },
            guardarCampo() { 
                this.cargando = true; 
                if(this.formCampo.entidad_objetivo) {
                    this.formCampo.entidad_objetivo = this.formCampo.entidad_objetivo.toLowerCase();
                }

                google.script.run.withSuccessHandler(() => { 
                    this.cargando=false; 
                    this.modalCmp.hide(); 
                    this.cargarDatosIniciales(); 
                }).guardarCampoConfig(this.formCampo); 
            },

            eliminarCampo(item) { 
                  Swal.fire({
                      title: '¬øBorrar Campo?',
                      text: item.etiqueta_visible,
                      icon: 'warning',
                      showCancelButton: true,
                      confirmButtonColor: '#d33',
                      confirmButtonText: 'S√≠, borrar'
                  }).then((r) => {
                      if(r.isConfirmed) {
                          this.cargando = true; 
                          google.script.run.withSuccessHandler(() => { 
                              this.cargando = false; 
                              this.cargarDatosIniciales(); 
                              this.notificar('success', 'Campo eliminado');
                          }).eliminarCampoConfig(item.id_campo); 
                      }
                  });
              },
            
            guardarConfigFactura() { 
                this.cargando = true; 
                // Obtenemos el usuario
                const usuario = this.usuarioLogueado ? this.usuarioLogueado.nombre : 'Operador';
                
                google.script.run.withSuccessHandler(() => { 
                    this.cargando = false; 
                    this.notificar('success', "Numeraci√≥n de facturaci√≥n actualizada"); 
                })
                // Enviamos (valor, usuario)
                .guardarConfigFactura(this.configFacturaActual, usuario); 
            },

            guardarConfigDepositoDefault() {
                this.cargando = true;
                const usuario = this.usuarioLogueado ? this.usuarioLogueado.nombre : 'Operador';

                google.script.run
                    .withSuccessHandler(() => {
                        this.cargando = false;
                        this.notificar('success', "Dep√≥sito predeterminado guardado.");
                        this.cargarDatosIniciales(); 
                    })
                    .withFailureHandler(err => {
                        this.cargando = false;
                        this.notificar('error', err);
                    })
                    .guardarConfigGeneral('DEPOSITO_DEFAULT', this.depositoDefault, usuario); // Enviamos usuario al final
            },

            // MODALES MAESTROS
            abrirModalCliente(item) { this.modoEdicion=!!item; this.formCliente = item ? JSON.parse(JSON.stringify(item)) : { razon_social:'', doc_identidad:'', email:'', datos_adicionales:{} }; if(!this.formCliente.datos_adicionales) this.formCliente.datos_adicionales={}; this.modalCli.show(); },
          guardarCliente() { 
                this.cargando = true; 
                const f = this.modoEdicion ? 'actualizarCliente' : 'guardarNuevoCliente'; 
                
                google.script.run
                    .withSuccessHandler(() => {
                        this.cargando = false; 
                        this.modalCli.hide(); 
                        this.cargarDatosIniciales();
                        // Agregamos la notificaci√≥n que faltaba
                        this.notificar('success', 'Cliente guardado correctamente');
                    })
                    .withFailureHandler(error => {
                        this.cargando = false;
                        this.notificar('error', "Error: " + error);
                    })
                    [f](this.formCliente); 
            },
          eliminarCliente(item) {
                Swal.fire({
                    title: '¬øEliminar Cliente?',
                    text: `Se eliminar√° a ${item.razon_social}`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'S√≠, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.cargando = true;
                        
                        google.script.run
                            .withSuccessHandler(r => {
                                this.cargando = false;
                                if (r.error) {
                                    this.notificar('error', r.error);
                                } else {
                                    this.cargarDatosIniciales();
                                    this.notificar('success', 'Cliente eliminado correctamente');
                                }
                            })
                            .withFailureHandler(e => {
                                this.cargando = false;
                                this.notificar('error', "Error: " + e);
                            })
                            .eliminarCliente(item.id_cliente);
                    }
                });
            },

            abrirModalProveedor(item) { this.modoEdicion=!!item; this.formProveedor = item ? JSON.parse(JSON.stringify(item)) : { razon_social:'', doc_identidad:'', datos_adicionales:{} }; if(!this.formProveedor.datos_adicionales) this.formProveedor.datos_adicionales={}; this.modalProv.show(); },
          guardarProveedor() { 
                this.cargando = true; 
                const f = this.modoEdicion ? 'actualizarProveedor' : 'guardarNuevoProveedor'; 
                
                google.script.run
                    .withSuccessHandler(() => {
                        this.cargando = false; 
                        this.modalProv.hide(); 
                        this.cargarDatosIniciales();
                        // Agregamos la notificaci√≥n que faltaba
                        this.notificar('success', 'Proveedor guardado correctamente');
                    })
                    .withFailureHandler(error => {
                        this.cargando = false;
                        this.notificar('error', "Error: " + error);
                    })
                    .withUserObject(this)[f](this.formProveedor); 
            },
          eliminarProveedor(item) {
                Swal.fire({
                    title: `¬øEliminar Proveedor?`,
                    text: `Se eliminar√° a ${item.razon_social}`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'S√≠, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.cargando = true;
                        
                        google.script.run
                            .withSuccessHandler(r => {
                                this.cargando = false;
                                if (r.success) {
                                    this.cargarDatosIniciales();
                                    this.notificar('success', 'Proveedor eliminado correctamente');
                                } else {
                                    this.notificar('error', r.error);
                                }
                            })
                            .withFailureHandler(e => {
                                this.cargando = false;
                                this.notificar('error', "Error: " + e);
                            })
                            .eliminarProveedor(item.id_proveedor);
                    }
                });
            },
            manejarArchivo(e) { const f = e.target.files[0]; if(!f) return; this.archivoParaSubir = f; const r = new FileReader(); r.onload = (e) => { this.imagenPreview = e.target.result; }; r.readAsDataURL(f); },
            abrirModalProducto(item) {
                this.modoEdicion = !!item;
                this.archivoParaSubir = null;
                this.imagenPreview = null;
                
                if (item) {
                    // MODO EDICI√ìN: Copiamos el item
                    this.formProducto = JSON.parse(JSON.stringify(item));
                    
                    // CORRECCI√ìN IMPORTANTE: Si es un producto viejo sin datos de IVA, poner defaults
                    if (this.formProducto.impuesto_iva === undefined) this.formProducto.impuesto_iva = 10;
                    if (!this.formProducto.metodo_iva) this.formProducto.metodo_iva = 'INCLUIDO';
                    
                    // Cargar previsualizaci√≥n de imagen si existe
                    if (this.formProducto.url_imagen) this.imagenPreview = this.formProducto.url_imagen;
                } else {
                    // MODO NUEVO
                    this.formProducto = { 
                        nombre: '', sku: '', precio_venta_base: 0, 
                        impuesto_iva: 10, metodo_iva: 'INCLUIDO', // Defaults
                        datos_adicionales: {} 
                    };
                }

                // Asegurar que datos_adicionales exista
                if (!this.formProducto.datos_adicionales) this.formProducto.datos_adicionales = {};
                
                this.modalProd.show();
            },
            async procesarGuardadoProducto() {
                  // 1. Validaci√≥n de campos obligatorios con Toast de advertencia
                  if (!this.formProducto.nombre || !this.formProducto.sku || !this.formProducto.precio_venta_base) {
                      return this.notificar('warning', "Por favor completa los campos obligatorios.");
                  }

                  this.cargando = true;

                  // 2. L√≥gica de subida de imagen (si el usuario seleccion√≥ una)
                  if (this.archivoParaSubir) {
                      try {
                          this.formProducto.url_imagen = await new Promise((resolve, reject) => {
                              const reader = new FileReader();
                              reader.onload = e => {
                                  google.script.run
                                      .withSuccessHandler(url => resolve(url))
                                      .withFailureHandler(err => reject(err))
                                      .subirImagenDrive(e.target.result.split(',')[1], this.archivoParaSubir.name, this.archivoParaSubir.type);
                              };
                              reader.onerror = error => reject(error);
                              reader.readAsDataURL(this.archivoParaSubir);
                          });
                      } catch (e) {
                          this.cargando = false;
                          return this.notificar('error', "Error subiendo imagen: " + e);
                      }
                  }

                  // 3. Preparar datos para enviar al Backend
                  const funcionBackend = this.modoEdicion ? 'actualizarProducto' : 'guardarNuevoProducto';
                  
                  // Limpiamos el objeto Vue para evitar errores de Proxy en Google Script
                  const productoLimpio = JSON.parse(JSON.stringify(this.formProducto));

                  console.log("Enviando al servidor:", productoLimpio);

                  this.formProducto.usuario_editor = this.usuarioLogueado ? this.usuarioLogueado.nombre : 'Operador';

                  // 4. Llamada al servidor
                  google.script.run
                      .withSuccessHandler((res) => {
                          this.cargando = false;
                          
                          if (res && res.error) {
                              // Si el backend devuelve un error controlado
                              this.notificar('error', "Error del sistema: " + res.error);
                          } else {
                              // √âxito total
                              this.modalProd.hide();
                              this.cargarDatosIniciales();
                              this.notificar('success', "Producto guardado correctamente");
                          }
                      })
                      .withFailureHandler(error => {
                          // Error de red o script cr√≠tico
                          this.cargando = false;
                          this.notificar('error', "Error CR√çTICO: " + error);
                      })
                      [funcionBackend](productoLimpio);
              },

              eliminarProducto(item) { 
                Swal.fire({
                    title: '¬øBorrar Producto?',
                    text: item.nombre,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'S√≠, borrar'
                }).then((r) => {
                    if(r.isConfirmed) {
                        this.cargando = true; 
                        google.script.run.withSuccessHandler(res => { 
                            this.cargando = false; 
                            if(res.success) {
                                this.cargarDatosIniciales();
                                this.notificar('success', 'Producto eliminado');
                            } else {
                                this.notificar('error', res.error);
                            }
                        }).eliminarProducto(item.id_producto); 
                    }
                });
            },

            // TRANSACCIONES
            alSeleccionarProductoVenta() { 
                const p = this.productos.find(x => x.id_producto == this.lineaVenta.id_producto); 
                if(p) {
                    // C√ÅLCULO DE PRECIO AUTOM√ÅTICO
                    let precioFinal = Number(p.precio_venta_base);
                    
                    // Si el producto es "IVA EXCLUIDO", le sumamos el impuesto para cobrarle al cliente
                    if (p.metodo_iva === 'EXCLUIDO') {
                        precioFinal = precioFinal * (1 + (Number(p.impuesto_iva) / 100));
                    }
                    
                    this.lineaVenta.precio = precioFinal; // Precio unitario final a cobrar
                } 
            },

            agregarAlCarritoVenta() { 
                const p = this.productos.find(x => x.id_producto == this.lineaVenta.id_producto); 
                if(!p || this.lineaVenta.cantidad > p.stock_actual) return this.notificar('warning', "Stock insuficiente"); 
                
                this.carritoVenta.push({
                    ...this.lineaVenta,
                    precio_final: this.lineaVenta.precio, // Precio cobrado
                    tasa_iva: p.impuesto_iva || 10,       // Guardamos la tasa para calcular totales luego
                    nombre_prod: p.nombre                 // √ötil para ticket
                });
                
                this.lineaVenta={id_producto:'', cantidad:1, precio:0}; 
            },
            quitarDelCarritoVenta(i) { this.carritoVenta.splice(i,1); },
            limpiarCarritoVenta() { this.carritoVenta=[]; this.formVenta={id_cliente:'', fecha: new Date().toISOString().slice(0,10), nro_factura: ''}; },

            guardarVentaFinal() {
                if(!this.formVenta.id_cliente) return this.notificar('warning', "Selecciona Cliente");
                if(this.carritoVenta.length === 0) return this.notificar('warning', "Carrito vac√≠o");
                
                this.cargando = true;
                const total = this.carritoVenta.reduce((acc, item) => acc + (item.cantidad * item.precio), 0);
                const paquete = { id_cliente: this.formVenta.id_cliente, id_deposito: this.formVenta.id_deposito, fecha: this.formVenta.fecha, nro_factura: this.formVenta.nro_factura, condicion: this.formVenta.condicion, total: total, items: this.carritoVenta };
                
                google.script.run.withSuccessHandler((res) => { 
                    this.cargando = false; 
                    if(res.pdf_url) {
                        Swal.fire({ 
                            title: 'üí∞ Venta registrada', 
                            text: "¬øDeseas abrir la factura PDF ahora?", 
                            icon: 'success', 
                            showCancelButton: true, 
                            confirmButtonText: 'S√≠, ver factura', 
                            cancelButtonText: 'Cerrar' 
                        }).then((result) => {
                            if (result.isConfirmed) window.open(res.pdf_url, '_blank');
                        });
                    } else {
                        this.notificar('success', "Venta registrada.");
                    }
                    this.carritoVenta = []; 
                    this.cargarDatosIniciales(); 
                })
                .withFailureHandler(err => { 
                    this.cargando = false; 
                    this.notificar('error', err); 
                })
                .guardarVenta(paquete);
            },
            verDetalleVenta(h) {
                console.log("üîç Buscando venta:", h.id_venta);
                this.itemsDetalle = []; // Limpiar lista
                this.modalDetalle.show();
                
                google.script.run
                    .withSuccessHandler(r => {
                        console.log("üì¶ Datos recibidos:", r);
                        if (!r || r.length === 0) {
                            // Mensaje visual si no hay datos
                            this.itemsDetalle = []; // Dejamos vac√≠o para que el v-if del HTML muestre "No hay items"
                        } else {
                            this.itemsDetalle = r;
                        }
                    })
                    .withFailureHandler(e => {
                        this.notificar('success', "Error al cargar detalle: " + e);
                        this.itemsDetalle = [];
                    })
                    .obtenerDetalleVenta(h.id_venta);
            },
            cargarHistorialVentas() { this.subVistaVentas='historial'; this.cargando=true; google.script.run.withSuccessHandler(r=>{this.historialVentas=r||[]; this.cargando=false;}).obtenerHistorialVentas(); },

            anularVenta(h) { 
                  Swal.fire({ 
                      title: '¬øAnular Venta?', 
                      text: `Factura: ${h.factura}. Se devolver√° el stock.`,
                      icon: 'warning', 
                      showCancelButton: true, 
                      confirmButtonColor: '#d33', 
                      confirmButtonText: 'S√≠, anular',
                      cancelButtonText: 'Cancelar'
                  }).then((result) => {
                      if (result.isConfirmed) {
                          this.cargando = true; 
                          // Obtenemos usuario para la bit√°cora
                          const usuarioActual = this.usuarioLogueado ? this.usuarioLogueado.nombre : 'Operador';

                          google.script.run.withSuccessHandler(() => {
                              this.cargando = false; 
                              this.notificar('success', 'Venta anulada correctamente'); 
                              this.cargarHistorialVentas(); 
                              this.cargarDatosIniciales();
                          })
                          .withFailureHandler(e => {
                              this.cargando = false;
                              this.notificar('error', e);
                          })
                          .anularVenta(h.id_venta, this.usuarioLogueado.nombre);
                      }
                  });
              },

            agregarAlCarrito() { this.carritoCompra.push({...this.lineaTemp}); this.lineaTemp={id_producto:'', cantidad:'', costo:''}; },
            quitarDelCarrito(i) { this.carritoCompra.splice(i,1); },
            limpiarCarrito() { this.carritoCompra=[]; this.formCompra={id_proveedor:'', fecha: new Date().toISOString().slice(0,10), comprobante: ''}; },
      guardarCompraFinal() { 
                if(!this.formCompra.id_proveedor || this.carritoCompra.length===0) {
                    return this.notificar('warning', "Faltan datos del proveedor o productos.");
                }
                
                this.cargando = true; 
                const total = this.carritoCompra.reduce((acc, i) => acc + (i.cantidad * i.costo), 0); 
                const pkg = { ...this.formCompra, total, items: this.carritoCompra }; 
                
                google.script.run.withSuccessHandler((res)=>{
                    this.cargando = false; 
                    
                    if(res.pdf_url) {
                        Swal.fire({ 
                            title: '‚úÖ Compra registrada', 
                            text: "¬øDeseas ver la Orden de Compra PDF?", 
                            icon: 'success', 
                            showCancelButton: true, 
                            confirmButtonText: 'S√≠, ver', 
                            cancelButtonText: 'Cerrar' 
                        }).then((result) => {
                            if (result.isConfirmed) window.open(res.pdf_url, '_blank');
                        });
                    } else {
                        this.notificar('success', "Compra registrada correctamente.");
                    }

                    this.limpiarCarrito(); 
                    this.cargarDatosIniciales();
                })
                .withFailureHandler(e => {
                    this.cargando = false; 
                    this.notificar('error', "Error al guardar compra: " + e);
                })
                .guardarCompraCompleta(pkg); 
            },

            verDetalleCompra(h) {
                this.itemsDetalle = []; 
                this.modalDetalle.show(); 
                
                google.script.run
                    .withSuccessHandler(r => {
                        this.itemsDetalle = r || [];
                    })
                    .withFailureHandler(e => {
                        this.notificar('error', "Error al cargar detalle: " + e);
                    })
                    .obtenerDetalleCompra(h.id_compra);
            },

            anularCompra(h) { 
                Swal.fire({ 
                    title: '¬øAnular Compra?', 
                    text: "El stock ingresado ser√° descontado.", 
                    icon: 'warning', 
                    showCancelButton: true, 
                    confirmButtonColor: '#d33', 
                    confirmButtonText: 'S√≠, anular',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.cargando = true; 
                        
                        google.script.run
                            .withSuccessHandler(() => {
                                this.cargando = false; 
                                this.notificar('success', "Compra anulada correctamente"); 
                                this.cargarHistorial(); 
                                this.cargarDatosIniciales();
                            })
                            .withFailureHandler(e => {
                                this.cargando = false;
                                this.notificar('error', "Error: " + e);
                            })
                            .anularCompra(h.id_compra);
                    }
                });
            }
        }
      }).mount('#app');
    </script>
</body>
</html>