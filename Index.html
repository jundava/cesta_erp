<!DOCTYPE html>
<html lang="es">
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Cesta App</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
      /* =========================================
          PALETA DE COLORES CESTA
      ========================================= */
      :root {
          --color-primary: #E06920; 
          --color-primary-hover: #BF5210;
          --bg-light-tone: #f8f9fa;
          --text-dark: #333333;
      }

      body { 
          background-color: var(--bg-light-tone); 
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
          /* Mejora el scroll en m贸viles */
          overflow-x: hidden; 
          -webkit-overflow-scrolling: touch;
      }

      /* UTILIDADES */
      .bg-brand { background-color: var(--color-primary) !important; }
      .text-brand { color: var(--color-primary) !important; }
      .border-brand { border-color: var(--color-primary) !important; }
      
      .btn-brand { background-color: var(--color-primary); border-color: var(--color-primary); color: white; }
      .btn-brand:hover { background-color: var(--color-primary-hover); border-color: var(--color-primary-hover); color: white; }
      
      .btn-outline-brand { color: var(--color-primary); border-color: var(--color-primary); }
      .btn-outline-brand:hover { background-color: var(--color-primary); color: white; }

      .nav-link-desktop { color: #333; cursor: pointer; padding: 10px 15px; border-radius: 8px; margin-bottom: 2px; text-decoration: none; display: block; transition: all 0.2s; }
      .nav-link-desktop:hover { background-color: #fff4e6; color: var(--color-primary); }
      .nav-link-desktop.active { background-color: var(--color-primary) !important; color: white !important; box-shadow: 0 4px 6px rgba(224, 105, 32, 0.2); }

      .logo-img { height: 40px; width: auto; object-fit: contain; border-radius: 4px; background: white; padding: 2px; }

      /* LAYOUT */
      .sidebar { min-height: 100vh; background-color: #ffffff; border-right: 1px solid #dee2e6; }
      .bottom-nav { background-color: white; border-top: 1px solid #dee2e6; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
      
      /* Estilos Barra M贸vil */
      .nav-item-mobile { 
          flex: 1; 
          text-align: center; 
          padding: 12px 0; /* M谩s espacio para el dedo */
          color: #adb5bd; 
          cursor: pointer; 
          text-decoration: none; 
          transition: color 0.2s; 
          display: flex;           /* Flexbox para alinear */
          flex-direction: column;  /* Uno encima del otro */
          align-items: center;
          justify-content: center;
      }
      
      .nav-item-mobile i { 
          font-size: 1.6rem; /* Aumentado de tama帽o (antes era aprox 1rem) */
          margin-bottom: 2px;
          line-height: 1;
      }
      
      .nav-item-mobile span {
          font-size: 0.75rem; /* Texto un poco m谩s legible */
          font-weight: 500;
      }

      .nav-item-mobile.active { 
          color: var(--color-primary); 
      }
      /* Efecto de pulsaci贸n */
      .nav-item-mobile:active i {
          transform: scale(0.9); 
      }

      /* Estilos Men煤 Lateral M贸vil (Offcanvas) */
      .offcanvas-body .btn { font-weight: 500; color: #444; transition: background 0.2s; border-color: #eee; }
      .offcanvas-body .btn:active, .offcanvas-body .btn:focus { background-color: #fff4e6; border-color: var(--color-primary); color: var(--color-primary); }

      @media (max-width: 767.98px) { .main-content { padding-bottom: 90px !important; } }

      .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction: column; }
      
      /* ESTILOS ESPECIFICOS PRODUCTO */
      .img-producto-card { height: 180px; width: 100%; background-color: #ffffff; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #f0f0f0; position: relative; }
      .img-producto-card img { width: 100%; height: 100%; object-fit: contain; padding: 15px; }
      .card { transition: transform 0.2s; border: none; }
      .no-hover:hover { transform: none; }
    </style>
</head>
<body>
    <div id="app">
      <div class="modal fade" id="modalDetalle" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Detalle de la Operaci贸n</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <table class="table table-striped mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">Producto</th>
                            <th class="text-center">Cant.</th>
                            <th class="text-end">Precio</th>
                            <th class="text-end pe-3">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="it in itemsDetalle" :key="it.producto">
                            <td class="ps-3">{{ it.producto }}</td>
                            <td class="text-center">{{ it.cantidad }}</td>
                            <td class="text-end">{{ formatoMoneda(it.precio) }}</td>
                            <td class="text-end pe-3 fw-bold">{{ formatoMoneda(it.subtotal) }}</td>
                        </tr>
                        
                        <tr v-if="itemsDetalle.length === 0">
                            <td colspan="4" class="text-center py-4 text-muted">
                                <i class="bi bi-info-circle me-1"></i> No hay items para mostrar o est谩 cargando...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer bg-light py-1">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>
      </div>
      <div v-if="cargando" class="loading-overlay">
        <div class="spinner-border text-brand mb-2" role="status" style="width: 3rem; height: 3rem;"></div>
        <div class="text-muted fw-bold">Procesando...</div>
      </div>

      <nav class="navbar navbar-dark bg-brand shadow sticky-top z-3">
        <div class="container-fluid d-flex justify-content-between align-items-center">
          <a class="navbar-brand fw-bold d-flex align-items-center gap-2" href="#">
            <img src="https://drive.google.com/thumbnail?id=15DzlDGz-7Wr1Z0kLAHqBuKSX6QIyvuBf&sz=w500" alt="CESTA Logo" class="logo-img">
              <span>CESTA Control de Stock</span>
          </a>
          <div class="d-flex align-items-center text-white">
            <div class="d-none d-sm-block text-end me-2 line-height-1">
              <small class="d-block opacity-75">Hola,</small><span class="fw-bold">Admin</span>
            </div>
            <div class="bg-white text-brand rounded-circle d-flex align-items-center justify-content-center fw-bold shadow-sm" style="width: 35px; height: 35px;">A</div>
          </div>
        </div>
      </nav>

      <div class="container-fluid">
        <div class="row">         

            <div class="col-md-2 sidebar p-3 d-none d-md-block shadow-sm z-2">
                <small class="text-muted text-uppercase fw-bold ps-2 mb-2 d-block" style="font-size: 0.7rem;">Facturaci贸n</small>
                <a class="nav-link-desktop" :class="{active: vistaActual === 'remisiones'}" @click="cambiarVista('remisiones')"><i class="bi bi-truck-flatbed me-2"></i> Notas de Remisi贸n</a>                
                <a class="nav-link-desktop" :class="{active: vistaActual === 'ventas'}" @click="cambiarVista('ventas')"><i class="bi bi-receipt me-2"></i> Ventas / Caja</a>
                <a class="nav-link-desktop" :class="{active: vistaActual === 'compras'}" @click="cambiarVista('compras')"><i class="bi bi-cart-plus me-2"></i> Compras / Stock</a>
                <a class="nav-link-desktop" :class="{active: vistaActual === 'transferencias'}" @click="cambiarVista('transferencias')"><i class="bi bi-arrow-left-right me-2"></i> Transferencias</a>
                <a class="nav-link-desktop" :class="{active: vistaActual === 'cobranzas'}" @click="cargarCobranzas()"><i class="bi bi-wallet2 me-2"></i> Cobranzas</a>
                <small class="text-muted text-uppercase fw-bold ps-2 mb-2 mt-3 d-block" style="font-size: 0.7rem;">Gesti贸n</small>
                <a class="nav-link-desktop" :class="{active: vistaActual === 'productos'}" @click="cambiarVista('productos')"><i class="bi bi-box-seam me-2"></i> Inventario</a>
                <a class="nav-link-desktop" :class="{active: vistaActual === 'clientes'}" @click="cambiarVista('clientes')"><i class="bi bi-people me-2"></i> Clientes</a>
                <a class="nav-link-desktop" :class="{active: vistaActual === 'proveedores'}" @click="cambiarVista('proveedores')"><i class="bi bi-truck me-2"></i> Proveedores</a>              
                <small class="text-muted text-uppercase fw-bold ps-2 mb-2 mt-3 d-block" style="font-size: 0.7rem;">Sistema</small>
                <a class="nav-link-desktop" :class="{active: vistaActual === 'config'}" @click="cambiarVista('config')"><i class="bi bi-gear me-2"></i> Configuraci贸n</a>
            </div>

            <div class="col-md-10 p-4 bg-light min-vh-100 main-content">
                
                <div v-if="vistaActual === 'ventas'">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="fw-bold text-dark mb-0"><i class="bi bi-receipt text-brand"></i> Punto de Venta</h3>
                        <div class="btn-group shadow-sm">
                            <button class="btn" :class="subVistaVentas === 'nueva' ? 'btn-brand' : 'btn-white bg-white text-secondary border'" @click="subVistaVentas = 'nueva'"><i class="bi bi-plus-lg"></i> Nueva Venta</button>
                            <button class="btn" :class="subVistaVentas === 'historial' ? 'btn-brand' : 'btn-white bg-white text-secondary border'" @click="cargarHistorialVentas"><i class="bi bi-clock-history"></i> Historial</button>
                        </div>
                    </div>

                      <div v-if="subVistaVentas === 'nueva'">
                        <div class="card border-0 shadow-sm mb-3 no-hover">
                            <div class="card-body">
                                <div class="row g-3 align-items-end">
                                    
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Cliente</label>
                                        <div class="input-group">
                                            <select class="form-select" v-model="formVenta.id_cliente">
                                                <option value="" disabled>Seleccionar cliente...</option>
                                                <option v-for="c in clientes" :value="c.id_cliente">{{ c.razon_social }}</option>
                                            </select>
                                            <button class="btn btn-outline-secondary" type="button" @click="abrirModalCliente(null)" title="Crear Nuevo Cliente">
                                                <i class="bi bi-person-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Desde Dep贸sito</label>
                                        <select class="form-select text-brand fw-bold" v-model="formVenta.id_deposito">
                                            <option v-for="d in listaDepositos" :value="d.id_deposito">{{ d.nombre }}</option>
                                        </select>
                                    </div>

                                    <div class="col-md-2">
                                        <label class="form-label fw-bold">Condici贸n</label>
                                        <select class="form-select" v-model="formVenta.condicion">
                                            <option value="CONTADO">Contado</option>
                                            <option value="CREDITO">Cr茅dito</option>
                                        </select>
                                    </div>

                                    <div class="col-md-2">
                                        <label class="form-label fw-bold">Fecha</label>
                                        <input type="date" class="form-control" v-model="formVenta.fecha">
                                    </div>
                                    
                                    <div class="col-md-2">
                                        <label class="form-label fw-bold">N潞 Factura</label>
                                        <input type="text" 
                                               class="form-control" 
                                               v-model="formVenta.nro_factura" 
                                               placeholder="Autom谩tico">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm mb-3 no-hover border-brand border-top border-3">
                            <div class="card-body bg-light">
                                <form @submit.prevent="agregarAlCarritoVenta">
                                    <div class="row g-2 align-items-end">
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold">Producto</label>
                                            <select class="form-select form-select-lg" v-model="lineaVenta.id_producto" required @change="alSeleccionarProductoVenta">
                                                <option value="" disabled> Buscar producto...</option>
                                                <option v-for="p in productos" :value="p.id_producto" :disabled="(p.stock_actual||0) <= 0">
                                                    {{ p.nombre }} | Stock: {{ p.stock_actual || 0 }} | {{ formatoMoneda(p.precio_venta_base) }}
                                                </option>
                                            </select>
                                        </div>
                                        <div class="col-md-2 col-4">
                                            <label class="form-label small">Cantidad</label>
                                            <input type="number" class="form-control form-control-lg" v-model.number="lineaVenta.cantidad" min="1" required>
                                        </div>
                                        <div class="col-md-2 col-8">
                                            <label class="form-label small">Precio Unit.</label>
                                            <input type="number" class="form-control form-control-lg" v-model.number="lineaVenta.precio" min="0" required>
                                        </div>
                                        <div class="col-md-2 d-grid">
                                            <button type="submit" class="btn btn-brand btn-lg fw-bold"><i class="bi bi-cart-plus"></i></button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm no-hover">
                            <div class="table-responsive">
                                <table class="table align-middle mb-0 table-striped">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Producto</th>
                                            <th class="text-center">Cant.</th>
                                            <th class="text-end">Precio</th>
                                            <th class="text-end">Subtotal</th>
                                            <th style="width: 50px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="(item, index) in carritoVenta" :key="index">
                                            <td class="fw-bold text-secondary">{{ obtenerNombreProducto(item.id_producto) }}</td>
                                            <td class="text-center">{{ item.cantidad }}</td>
                                            <td class="text-end">{{ formatoMoneda(item.precio) }}</td>
                                            <td class="text-end fw-bold">{{ formatoMoneda(item.cantidad * item.precio) }}</td>
                                            <td>
                                                <button class="btn btn-sm text-danger" @click="quitarDelCarritoVenta(index)"><i class="bi bi-trash"></i></button>
                                            </td>
                                        </tr>
                                        <tr v-if="carritoVenta.length === 0">
                                            <td colspan="5" class="text-center py-5 text-muted">Carrito vac铆o, agrega productos arriba.</td>
                                        </tr>
                                    </tbody>
                                    <tfoot v-if="carritoVenta.length > 0">
                                        <tr class="text-muted small">
                                            <td colspan="3" class="text-end border-0 pt-3">Liquidaci贸n IVA:</td>
                                            <td class="text-end border-0 pt-3">{{ formatoMoneda(totalIVA) }}</td>
                                            <td class="border-0"></td>
                                        </tr>
                                        <tr class="bg-brand text-white">
                                            <td colspan="3" class="text-end fw-bold fs-5 border-0">TOTAL A PAGAR:</td>
                                            <td class="text-end fw-bold fs-3 border-0">{{ formatoMoneda(totalVenta) }}</td>
                                            <td class="border-0"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <div class="card-footer bg-white p-3 text-end" v-if="carritoVenta.length > 0">
                                <button class="btn btn-outline-secondary me-2" @click="limpiarCarritoVenta">Cancelar</button>
                                <button class="btn btn-success btn-lg fw-bold px-5 shadow" @click="guardarVentaFinal">
                                    <i class="bi bi-cash-coin me-2"></i> COBRAR
                                </button>
                            </div>
                        </div>

                    </div>

                    <div v-if="subVistaVentas === 'historial'">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group shadow-sm">
                                    <span class="input-group-text bg-white border-end-0">
                                        <i class="bi bi-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-start-0 ps-0" 
                                          v-model="busquedaVenta" 
                                          placeholder="Buscar por cliente o factura...">
                                    <button v-if="busquedaVenta" class="btn btn-outline-secondary" @click="busquedaVenta = ''">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card border-0 shadow-sm">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="ps-3">Fecha</th>
                                            <th>Cliente</th>
                                            <th>Factura</th>
                                            <th class="text-center">Condici贸n</th>
                                            <th class="text-end">Total</th>
                                            <th class="text-center">Estado</th>
                                            <th class="text-end pe-3">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="h in ventasFiltradas" :key="h.id_venta">
                                            <td class="ps-3 text-muted small">{{ new Date(h.fecha).toLocaleDateString() }}</td>
                                            <td class="fw-bold">{{ h.nombre_cliente }}</td>
                                            <td><span class="badge bg-light text-dark border">{{ h.factura }}</span></td>
                                            <td class="text-center">
                                                <span class="badge" :class="h.condicion === 'CREDITO' ? 'bg-warning text-dark border' : 'bg-info bg-opacity-10 text-primary border border-primary'">
                                                    {{ h.condicion }}
                                                </span>
                                            </td>
                                            <td class="text-end fw-bold text-success">{{ formatoMoneda(h.total) }}</td>
                                            <td class="text-center">
                                                <span v-if="h.estado === 'ANULADO'" class="badge bg-danger">ANULADO</span>
                                                <span v-else-if="h.estado === 'PENDIENTE'" class="badge bg-warning text-dark">PENDIENTE</span>
                                                <span v-else class="badge bg-success">PAGADO</span>
                                            </td>
                                            <td class="text-end pe-3">
                                                <button class="btn btn-sm btn-outline-dark me-1" @click="imprimirTicket(h)" title="Imprimir Ticket T茅rmico"><i class="bi bi-printer-fill"></i></button>
                                                <a v-if="h.url_pdf" :href="h.url_pdf" target="_blank" class="btn btn-sm btn-outline-secondary me-1" title="Ver Factura PDF"><i class="bi bi-file-earmark-pdf"></i></a>
                                                <button class="btn btn-sm btn-outline-primary me-1" @click="verDetalleVenta(h)" title="Ver productos">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button v-if="h.estado !== 'ANULADO'" class="btn btn-sm btn-outline-danger" @click="anularVenta(h)" title="Anular venta">
                                                    <i class="bi bi-slash-circle"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="vistaActual === 'transferencias'">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="fw-bold text-dark mb-0"><i class="bi bi-arrow-left-right text-brand"></i> Transferencias</h3>
                        <div class="btn-group shadow-sm">
                            <button class="btn" :class="subVistaTransf === 'nueva' ? 'btn-brand' : 'btn-white bg-white text-secondary border'" @click="subVistaTransf = 'nueva'">Nueva</button>
                            <button class="btn" :class="subVistaTransf === 'historial' ? 'btn-brand' : 'btn-white bg-white text-secondary border'" @click="cargarHistorialTransf">Historial</button>
                        </div>
                    </div>

                    <div v-if="subVistaTransf === 'nueva'">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body">
                                <h6 class="text-brand fw-bold text-uppercase small mb-3">Datos del Traslado</h6>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Fecha</label>
                                        <input type="date" class="form-control" v-model="formTransf.fecha">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Origen (Sale)</label>
                                        <select class="form-select" v-model="formTransf.origen">
                                            <option v-for="d in listaDepositos" :value="d.id_deposito">{{ d.nombre }}</option>
                                        </select>
                                    </div>
                                    <div class="col-md-1 d-flex align-items-center justify-content-center pt-3">
                                        <i class="bi bi-arrow-right fs-3 text-muted"></i>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Destino (Entra)</label>
                                        <select class="form-select" v-model="formTransf.destino">
                                            <option v-for="d in listaDepositos" :value="d.id_deposito" :disabled="d.id_deposito === formTransf.origen">{{ d.nombre }}</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label fw-bold">Responsable</label>
                                        <input type="text" class="form-control" v-model="formTransf.responsable">
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <input type="text" class="form-control" placeholder="Observaci贸n (Opcional)" v-model="formTransf.observacion">
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm mb-4 border-start border-3 border-brand">
                            <div class="card-body bg-light">
                                <form @submit.prevent="agregarAlCarritoTransf">
                                    <div class="row g-2 align-items-end">
                                        <div class="col-md-6">
                                            <label class="small fw-bold">Producto a mover</label>
                                            <select class="form-select" v-model="lineaTransf.id_producto" required>
                                                <option value="" disabled>Seleccionar...</option>
                                                <option v-for="p in productos" :value="p.id_producto">{{ p.nombre }} (Global: {{ p.stock_actual }})</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="small fw-bold">Cantidad</label>
                                            <input type="number" class="form-control" v-model.number="lineaTransf.cantidad" min="1" required>
                                        </div>
                                        <div class="col-md-3 d-grid">
                                            <button class="btn btn-brand fw-bold"><i class="bi bi-plus-lg"></i> Agregar</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm" v-if="carritoTransf.length > 0">
                            <table class="table align-middle mb-0">
                                <thead class="table-light"><tr><th>Producto</th><th class="text-center">Cant</th><th></th></tr></thead>
                                <tbody>
                                    <tr v-for="(item, i) in carritoTransf" :key="i">
                                        <td>{{ item.nombre }}</td>
                                        <td class="text-center fw-bold">{{ item.cantidad }}</td>
                                        <td class="text-end"><button class="btn btn-sm text-danger" @click="quitarCarritoTransf(i)"><i class="bi bi-x-lg"></i></button></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="card-footer bg-white text-end p-3">
                                <button class="btn btn-brand fw-bold px-4" @click="guardarTransfFinal">CONFIRMAR TRANSFERENCIA</button>
                            </div>
                        </div>
                    </div>

                    <div v-if="subVistaTransf === 'historial'">
                        <div class="card border-0 shadow-sm">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light"><tr><th class="ps-3">Fecha</th><th>Ruta</th><th>Responsable</th><th class="text-end pe-3">PDF</th></tr></thead>
                                    <tbody>
                                        <tr v-for="h in historialTransf" :key="h.id">
                                            <td class="ps-3">{{ h.fecha }}</td>
                                            <td><span class="badge bg-light text-dark border">{{ h.origen }}</span> <i class="bi bi-arrow-right mx-1 text-muted small"></i> <span class="badge bg-success bg-opacity-10 text-success border border-success">{{ h.destino }}</span></td>
                                            <td class="small">{{ h.responsable }}</td>
                                            <td class="text-end pe-3">
                                                <a v-if="h.url_pdf" :href="h.url_pdf" target="_blank" class="btn btn-sm btn-outline-danger"><i class="bi bi-file-earmark-pdf"></i></a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="vistaActual === 'remisiones'">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="fw-bold text-dark mb-0"><i class="bi bi-truck-flatbed text-brand"></i> Notas de Remisi贸n</h3>
                        <div class="btn-group shadow-sm">
                            <button class="btn" :class="subVistaRemision === 'nueva' ? 'btn-brand' : 'btn-white bg-white text-secondary border'" @click="subVistaRemision = 'nueva'">Nueva</button>
                            <button class="btn" :class="subVistaRemision === 'historial' ? 'btn-brand' : 'btn-white bg-white text-secondary border'" @click="cargarHistorialRemisiones">Historial</button>
                        </div>
                    </div>

                    <div v-if="subVistaRemision === 'nueva'">
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-body">
                                <h6 class="text-secondary small fw-bold mb-3 text-uppercase">Datos del Traslado</h6>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold small">Fecha</label>
                                        <input type="date" class="form-control" v-model="formRemision.fecha">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold small">Nro. Comprobante</label>
                                        <input type="text" class="form-control" v-model="formRemision.numero" placeholder="Auto (Seg煤n Config)">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold small">Cliente Destino</label>
                                        <select class="form-select" v-model="formRemision.id_cliente">
                                            <option value="" disabled>Seleccionar...</option>
                                            <option v-for="c in clientes" :value="c.id_cliente">{{ c.razon_social }}</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold small">Sale de Dep贸sito</label>
                                        <select class="form-select" v-model="formRemision.id_deposito">
                                            <option v-for="d in listaDepositos" :value="d.id_deposito">{{ d.nombre }}</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small">Conductor (Opcional)</label>
                                        <input type="text" class="form-control" v-model="formRemision.conductor" placeholder="Nombre del chofer">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small">Chapa / Veh铆culo (Opcional)</label>
                                        <input type="text" class="form-control" v-model="formRemision.chapa" placeholder="ABC-123">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm mb-3 border-top border-brand border-3">
                            <div class="card-body bg-light">
                                <form @submit.prevent="agregarAlCarritoRemision">
                                    <div class="row g-2 align-items-end">
                                        <div class="col-md-8">
                                            <label class="form-label small fw-bold">Producto a Trasladar</label>
                                            <select class="form-select" v-model="lineaRemision.id_producto" required>
                                                <option value="" disabled>Buscar producto...</option>
                                                <option v-for="p in productos" :value="p.id_producto">{{ p.nombre }} (Stock Global: {{ p.stock_actual }})</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small fw-bold">Cantidad</label>
                                            <input type="number" class="form-control" v-model.number="lineaRemision.cantidad" min="1" required>
                                        </div>
                                        <div class="col-md-2 d-grid">
                                            <button class="btn btn-brand fw-bold"><i class="bi bi-plus-lg"></i></button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm" v-if="carritoRemision.length > 0">
                            <table class="table align-middle mb-0 table-striped">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-3">Producto</th>
                                        <th class="text-center">Cant.</th>
                                        <th class="text-end">Precio Ref.</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(item, i) in carritoRemision" :key="i">
                                        <td class="ps-3">{{ item.nombre_prod }}</td>
                                        <td class="text-center fw-bold">{{ item.cantidad }}</td>
                                        <td class="text-end text-muted small">{{ formatoMoneda(item.precio) }}</td>
                                        <td class="text-end pe-3"><button class="btn btn-sm text-danger" @click="carritoRemision.splice(i,1)"><i class="bi bi-trash"></i></button></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="card-footer bg-white text-end p-3">
                                <button class="btn btn-brand fw-bold px-4" @click="guardarRemisionFinal"><i class="bi bi-file-earmark-check me-2"></i> GENERAR REMISIN</button>
                            </div>
                        </div>
                    </div>

                    <div v-if="subVistaRemision === 'historial'">
                      <div class="row mb-3">
                          <div class="col-md-6">
                              <div class="input-group shadow-sm">
                                  <span class="input-group-text bg-white border-end-0">
                                      <i class="bi bi-search text-muted"></i>
                                  </span>
                                  <input type="text" class="form-control border-start-0 ps-0" 
                                        v-model="busquedaRemision" 
                                        placeholder="Buscar por cliente o n煤mero de remisi贸n...">
                                  <button v-if="busquedaRemision" class="btn btn-outline-secondary" @click="busquedaRemision = ''">
                                      <i class="bi bi-x-lg"></i>
                                  </button>
                              </div>
                          </div>
                      </div>
                      <div class="card border-0 shadow-sm">
                          <div class="table-responsive">
                              <table class="table table-hover align-middle mb-0">
                                  <thead class="table-light"><tr><th class="ps-3">Fecha</th><th>Nro</th><th>Cliente</th><th>Estado</th><th class="text-end pe-3">Acciones</th></tr></thead>
                                  <tbody>
                                      <tr v-for="h in remisionesFiltradas" :key="h.id_remision">
                                          <td class="ps-3 text-muted small">{{ new Date(h.fecha).toLocaleDateString() }}</td>
                                          <td><span class="badge bg-light text-dark border">{{ h.numero }}</span></td>
                                          <td class="fw-bold">{{ h.cliente }}</td>
                                            <td class="text-center">
                                              <span v-if="h.estado === 'ANULADO'" class="badge bg-danger">ANULADO</span>
                                              <span v-else-if="h.estado === 'FACTURADO'" class="badge bg-success">FACTURADO</span>
                                              <span v-else class="badge bg-warning text-dark border">PENDIENTE</span>
                                            </td>
                                            <td class="text-end pe-3">
                                                <a v-if="h.url_pdf" :href="h.url_pdf" target="_blank" class="btn btn-sm btn-outline-secondary me-1" title="Ver PDF">
                                                    <i class="bi bi-file-earmark-pdf"></i>
                                                </a>
                                                
                                                <button v-if="h.estado === 'PENDIENTE_FACTURAR' || h.estado === 'ENTREGADO'" class="btn btn-sm btn-success text-white fw-bold me-1" @click="facturarDesdeRemision(h)" title="Facturar esta remisi贸n">
                                                    <i class="bi bi-receipt"></i>
                                                </button>

                                                <button v-if="h.estado !== 'ANULADO' && h.estado !== 'FACTURADO'" class="btn btn-sm btn-outline-danger" @click="anularRemision(h)" title="Anular y devolver stock">
                                                    <i class="bi bi-slash-circle"></i>
                                                </button>
                                            </td>
                                      </tr>
                                      <tr v-if="remisionesFiltradas && remisionesFiltradas.length === 0">
                                          <td colspan="5" class="text-center py-4 text-muted">
                                              <i class="bi bi-filter-circle me-2"></i> No se encontraron resultados.
                                          </td>
                                      </tr>
                                  </tbody>
                              </table>
                          </div>
                      </div>
                    </div>
                </div>

                <div v-if="vistaActual === 'cobranzas'">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="fw-bold text-dark mb-0"><i class="bi bi-wallet2 text-brand"></i> Cuentas por Cobrar</h3>
                        <button v-if="subVistaCobranzas === 'nuevo'" class="btn btn-outline-secondary" @click="subVistaCobranzas='listado'">Volver</button>
                    </div>
                    <div v-if="subVistaCobranzas === 'listado'">
                        <div class="card border-0 shadow-sm">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light"><tr><th>Cliente</th><th class="text-end">Deuda Total</th><th class="text-end">Acci贸n</th></tr></thead>
                                      <tbody>
                                          <template v-for="c in clientesDeudores" :key="c.id_cliente">
                                              
                                              <tr class="table-light" :class="{'border-bottom-0': c.mostrar_detalle}" style="cursor: pointer;" @click="c.mostrar_detalle = !c.mostrar_detalle">
                                                  <td>
                                                      <div class="d-flex align-items-center">
                                                          <i class="bi me-2 text-primary" :class="c.mostrar_detalle ? 'bi-chevron-down' : 'bi-chevron-right'"></i>
                                                          <div>
                                                              <div class="fw-bold">{{ c.nombre }}</div>
                                                              <small class="text-muted">{{ c.facturas_pendientes.length }} facturas pendientes</small>
                                                          </div>
                                                      </div>
                                                  </td>
                                                  <td class="text-end fw-bold text-danger fs-5">{{ formatoMoneda(c.total_deuda) }}</td>
                                                  <td class="text-end">
                                                      <span class="text-muted small">Ver detalle <i class="bi bi-arrow-down"></i></span>
                                                  </td>
                                              </tr>

                                              <tr v-if="c.mostrar_detalle">
                                                  <td colspan="3" class="p-0 bg-white border-bottom">
                                                      <div class="p-3 bg-light bg-opacity-50">
                                                          <table class="table table-sm table-bordered mb-0 bg-white shadow-sm align-middle">
                                                              <thead class="text-muted small bg-light">
                                                                  <tr>
                                                                      <th>Fecha</th>
                                                                      <th>Nro. Factura</th>
                                                                      <th class="text-end">Importe Orig.</th>
                                                                      <th class="text-end text-danger">Saldo</th>
                                                                      <th class="text-center" style="width: 100px;">Acci贸n</th> </tr>
                                                              </thead>
                                                              <tbody>
                                                                  <tr v-for="f in c.facturas_pendientes" :key="f.id_venta">
                                                                      <td class="small">{{ new Date(f.fecha).toLocaleDateString() }}</td>
                                                                      <td class="fw-bold text-dark">{{ f.numero }}</td>
                                                                      <td class="text-end text-muted small">{{ formatoMoneda(f.total_original) }}</td>
                                                                      <td class="text-end fw-bold text-danger">{{ formatoMoneda(f.saldo) }}</td>
                                                                      <td class="text-center">
                                                                          <button class="btn btn-sm btn-outline-success fw-bold" @click="abrirCobro(f, c)">
                                                                              Pagar
                                                                          </button>
                                                                      </td>
                                                                  </tr>
                                                              </tbody>
                                                          </table>
                                                      </div>
                                                  </td>
                                              </tr>
                                          </template>
                                          </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div v-if="subVistaCobranzas === 'nuevo'">
                        <div class="card border-0 shadow-sm" style="max-width: 500px; margin: 0 auto;">
                            <div class="card-header bg-success text-white fw-bold">Registrar Cobro</div>
                            <div class="card-body">
                    <div class="alert alert-warning">
                      <div class="d-flex justify-content-between align-items-center">
                          <span>Factura: <strong>{{ formCobro.nro_factura_visual }}</strong></span>
                          <span class="fw-bold fs-5">Saldo: {{ formatoMoneda(formCobro.deuda_total) }}</span>
                      </div>
                    </div>
                                
                                <form @submit.prevent="guardarCobro">
                                    <div class="mb-3">
                                        <label class="form-label">Cliente</label>
                                        <input type="text" class="form-control" :value="formCobro.nombre" disabled>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Monto a Pagar</label>
                                        <input type="number" class="form-control form-control-lg text-end fw-bold text-success" v-model.number="formCobro.monto" required min="1">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">M茅todo de Pago</label>
                                        <select class="form-select" v-model="formCobro.metodo">
                                            <option>Efectivo</option>
                                            <option>Transferencia</option>
                                            <option>Cheque</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Observaci贸n</label>
                                        <input type="text" class="form-control" v-model="formCobro.observacion" placeholder="Nro de comprobante, banco...">
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-success btn-lg fw-bold">CONFIRMAR PAGO</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="vistaActual === 'compras'">
                    <div class="d-flex justify-content-between align-items-center mb-4"><h3 class="fw-bold text-dark mb-0"><i class="bi bi-cart-plus text-brand"></i> Compras</h3><div class="btn-group shadow-sm"><button class="btn" :class="subVistaCompras === 'nueva' ? 'btn-brand' : 'btn-white bg-white text-secondary border'" @click="subVistaCompras = 'nueva'"><i class="bi bi-plus-lg"></i> Nueva</button><button class="btn" :class="subVistaCompras === 'historial' ? 'btn-brand' : 'btn-white bg-white text-secondary border'" @click="cargarHistorial"><i class="bi bi-clock-history"></i> Historial</button></div></div>
                    <div v-if="subVistaCompras === 'nueva'"><div class="card border-0 shadow-sm mb-4 no-hover"><div class="card-body"><h6 class="text-muted text-uppercase fw-bold small mb-3">Datos del Comprobante</h6><div class="row g-3"><div class="col-md-4"><label class="form-label fw-bold">Proveedor</label><select class="form-select" v-model="formCompra.id_proveedor"><option value="" disabled>Seleccione proveedor...</option><option v-for="p in proveedores" :value="p.id_proveedor">{{ p.razon_social }}</option></select></div><div class="col-md-4"><label class="form-label fw-bold">Fecha Emisi贸n</label><input type="date" class="form-control" v-model="formCompra.fecha"></div><div class="col-md-4"><label class="form-label fw-bold">N潞 Factura / Remisi贸n</label><input type="text" class="form-control" v-model="formCompra.comprobante" placeholder="Ej: 001-001-123456"></div></div></div></div><div class="card border-0 shadow-sm mb-4 no-hover border-brand border-top border-3"><div class="card-body bg-light"><h6 class="text-brand text-uppercase fw-bold small mb-3">Agregar Productos</h6><form @submit.prevent="agregarAlCarrito"><div class="row g-2 align-items-end"><div class="col-md-5"><label class="form-label small">Producto</label><select class="form-select" v-model="lineaTemp.id_producto" required><option value="" disabled>Buscar producto...</option><option v-for="prod in productos" :value="prod.id_producto">{{ prod.sku }} - {{ prod.nombre }}</option></select></div><div class="col-md-2 col-6"><label class="form-label small">Cantidad</label><input type="number" class="form-control" v-model.number="lineaTemp.cantidad" min="1" required placeholder="0"></div><div class="col-md-3 col-6"><label class="form-label small">Costo (Gs)</label><input type="number" class="form-control" v-model.number="lineaTemp.costo" min="0" required placeholder="0"></div><div class="col-md-2 d-grid"><button type="submit" class="btn btn-brand fw-bold"><i class="bi bi-plus-lg"></i> Agregar</button></div></div></form></div></div><div class="card border-0 shadow-sm no-hover"><div class="table-responsive"><table class="table align-middle mb-0"><thead class="table-light"><tr><th>Producto</th><th class="text-center">Cant.</th><th class="text-end">Costo</th><th class="text-end">Subtotal</th><th style="width: 50px;"></th></tr></thead><tbody><tr v-for="(item, index) in carritoCompra" :key="index"><td><div class="fw-bold">{{ obtenerNombreProducto(item.id_producto) }}</div></td><td class="text-center">{{ item.cantidad }}</td><td class="text-end">{{ formatoMoneda(item.costo) }}</td><td class="text-end fw-bold">{{ formatoMoneda(item.cantidad * item.costo) }}</td><td><button class="btn btn-sm text-danger" @click="quitarDelCarrito(index)"><i class="bi bi-x-lg"></i></button></td></tr><tr v-if="carritoCompra.length === 0"><td colspan="5" class="text-center py-4 text-muted">Carrito vac铆o</td></tr></tbody><tfoot v-if="carritoCompra.length > 0"><tr class="bg-light"><td colspan="3" class="text-end fw-bold fs-5 pt-3">TOTAL:</td><td class="text-end fw-bold fs-4 text-brand pt-3">{{ formatoMoneda(totalCompra) }}</td><td></td></tr></tfoot></table></div><div class="card-footer bg-white p-3 text-end" v-if="carritoCompra.length > 0"><button class="btn btn-outline-secondary me-2" @click="limpiarCarrito">Cancelar</button><button class="btn btn-brand fw-bold px-4" @click="guardarCompraFinal"><i class="bi bi-check-lg me-1"></i> FINALIZAR</button></div></div></div>
                    <div v-if="subVistaCompras === 'historial'"><div class="card border-0 shadow-sm"><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th class="ps-3">Fecha</th><th>Proveedor</th><th class="text-end">Total</th><th class="text-center">Estado</th><th class="text-end pe-3">Acciones</th></tr></thead><tbody><tr v-for="h in historialCompras" :key="h.id_compra"><td class="ps-3 text-muted small">{{ new Date(h.fecha).toLocaleDateString() }}</td><td class="fw-bold text-dark">{{ h.nombre_proveedor }}</td><td class="text-end fw-bold text-success">{{ formatoMoneda(h.total) }}</td><td class="text-center"><span v-if="h.estado === 'ANULADO'" class="badge bg-danger">ANULADO</span><span v-else class="badge bg-success bg-opacity-10 text-success border border-success">{{ h.estado }}</span></td><td class="text-end pe-3"> <a v-if="h.url_pdf" :href="h.url_pdf" target="_blank" class="btn btn-sm btn-outline-secondary me-1" title="Ver Orden Compra"><i class="bi bi-file-earmark-pdf"></i></a> <button class="btn btn-sm btn-outline-primary me-1" @click="verDetalleCompra(h)"><i class="bi bi-eye"></i></button><button v-if="h.estado !== 'ANULADO'" class="btn btn-sm btn-outline-danger" @click="anularCompra(h)"><i class="bi bi-slash-circle"></i></button></td></tr></tbody></table></div></div></div></div>
                </div>

                <div v-if="vistaActual === 'productos'">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                        <div><h3 class="fw-bold mb-0 text-dark">Inventario</h3><small class="text-muted">{{ productos.length }} productos activos</small></div>
                        <button class="btn btn-brand shadow-sm w-100 w-md-auto" @click="abrirModalProducto(null)"><i class="bi bi-plus-lg me-1"></i> Nuevo Producto</button>
                    </div>
                    <div class="row g-3">
                        <div class="col-12 col-sm-6 col-lg-3" v-for="item in productos" :key="item.id_producto"> 
                            <div class="card h-100 shadow-sm">
                                
                                <div class="img-producto-card">
                                    <img v-if="item.url_imagen" :src="item.url_imagen" alt="Producto">
                                    <i v-else class="bi bi-camera-fill fs-1 text-muted opacity-25"></i>
                                    <span class="position-absolute top-0 end-0 m-2 badge bg-brand bg-opacity-75 rounded-pill small">{{ obtenerNombreCategoria(item.id_categoria) }}</span>
                                </div>

                                <div class="card-body d-flex flex-column">
                                    
                                    <div class="mb-2">
                                        <h6 class="card-title fw-bold text-truncate mb-0" :title="item.nombre">{{ item.nombre }}</h6>
                                        <small class="text-muted" style="font-size: 0.8rem;">SKU: {{ item.sku }}</small>
                                    </div>
                                    
                                    <div class="row g-0 mb-3 small bg-light rounded border p-1">
                                        <div class="col-6 border-end pe-2 text-center">
                                            <span class="d-block text-muted" style="font-size: 0.7rem;">Stock Total</span>
                                            <span class="fw-bold fs-5" :class="(item.stock_actual || 0) <= (item.stock_minimo || 5) ? 'text-danger' : 'text-success'">
                                                {{ item.stock_actual || 0 }} 
                                            </span>
                                            <span class="d-block text-muted" style="font-size: 0.6rem;">{{ item.unidad_medida }}</span>
                                        </div>
                                        <div class="col-6 ps-2 text-center d-flex flex-column justify-content-center">
                                            <span class="d-block text-muted" style="font-size: 0.7rem;">Costo Prom.</span>
                                            <span class="fw-bold text-secondary">{{ formatoMoneda(item.costo_promedio || item.costo || 0) }}</span>
                                        </div>
                                    </div>

                                    <div class="mt-auto">
                                        <div class="d-flex justify-content-between align-items-end mb-2">
                                            <div>
                                                <div class="text-brand fw-bold fs-4 line-height-1">{{ formatoMoneda(item.precio_venta_base) }}</div>
                                                <small class="text-muted" style="font-size: 0.75rem;">Precio Venta</small>
                                            </div>
                                        </div>
                                        
                                        <a class="text-decoration-none small text-brand fw-bold d-flex align-items-center gap-1 mb-2" 
                                           data-bs-toggle="collapse" 
                                           :href="'#collapse' + item.id_producto" 
                                           role="button" 
                                           aria-expanded="false">
                                           <i class="bi bi-info-circle"></i> Ver detalles
                                        </a>
                                    </div>

                                    <div class="collapse" :id="'collapse' + item.id_producto">
                                        <div class="bg-light p-2 rounded small border shadow-sm mb-3">
                                            
                                            <h6 class="fw-bold text-secondary border-bottom pb-1 mb-2" style="font-size: 0.7rem;"> Ubicaci贸n del Stock</h6>
                                            <div v-if="item.stocks && item.stocks.length > 0">
                                                <table class="table table-sm table-borderless mb-0">
                                                    <tbody>
                                                        <tr v-for="st in item.stocks" :key="st.nombre_deposito">
                                                            <td class="text-start ps-0 text-muted py-0">{{ st.nombre_deposito }}</td>
                                                            <td class="text-end fw-bold pe-0 py-0">{{ st.cantidad }}</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div v-else class="text-center text-muted fst-italic mb-2">Sin stock registrado</div>

                                            <div v-if="tieneDatosValidos(item)">
                                                <h6 class="fw-bold text-secondary border-bottom pb-1 mb-2 mt-3" style="font-size: 0.7rem;">癸 Info Adicional</h6>
                                                <div v-for="(val, key) in item.datos_adicionales">
                                                    <div v-if="val && val.toString().trim() !== ''" class="mb-1 d-flex justify-content-between">
                                                        <span class="text-muted">{{ obtenerEtiquetaCampo(key) }}:</span> 
                                                        <span class="fw-bold text-dark">{{ val }}</span>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                    <div class="d-flex gap-2 pt-2 border-top">
                                        <button class="btn btn-sm btn-outline-brand flex-grow-1" @click="abrirModalProducto(item)"><i class="bi bi-pencil"></i> Editar</button>
                                        <button class="btn btn-sm btn-outline-danger" @click="eliminarProducto(item)"><i class="bi bi-trash"></i></button>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="vistaActual === 'clientes'">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                        <h3 class="fw-bold">Clientes</h3>
                        <button class="btn btn-brand shadow-sm w-100 w-md-auto" @click="abrirModalCliente(null)"><i class="bi bi-person-plus-fill me-1"></i> Nuevo Cliente</button>
                    </div>
                      <div class="card shadow-sm border-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" style="min-width: 600px;">
                                <thead class="table-light"><tr><th class="ps-3">Raz贸n Social</th><th>Doc. Identidad</th><th>Contacto</th><th>Info Extra</th><th class="text-end pe-3">Acciones</th></tr></thead>
                                <tbody>
                                    <tr v-for="cli in clientes" :key="cli.id_cliente">
                                        <td class="ps-3 fw-bold text-brand">{{ cli.razon_social }}</td>
                                        <td><span class="badge bg-light text-dark border">{{ cli.doc_identidad }}</span></td>
                                        <td><div v-if="cli.telefono"><i class="bi bi-telephone me-1"></i>{{ cli.telefono }}</div><div v-if="cli.email" class="small text-muted"><i class="bi bi-envelope me-1"></i>{{ cli.email }}</div></td>
                                        <td class="small text-muted"><div v-for="(val, key) in cli.datos_adicionales"><span v-if="val" class="d-block"> <strong>{{ key }}:</strong> {{ val }}</span></div></td>
                                        <td class="text-end pe-3"><button class="btn btn-sm btn-light text-brand border me-1" @click="abrirModalCliente(cli)"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-light text-danger border" @click="eliminarCliente(cli)"><i class="bi bi-trash"></i></button></td>
                                    </tr>
                                    <tr v-if="clientes.length === 0"><td colspan="5" class="text-center p-5 text-muted">No hay clientes registrados.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div v-if="vistaActual === 'proveedores'">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                        <h3 class="fw-bold">Proveedores</h3>
                        <button class="btn btn-brand shadow-sm w-100 w-md-auto" @click="abrirModalProveedor(null)"><i class="bi bi-person-plus-fill me-1"></i> Nuevo Proveedor</button>
                    </div>
                      <div class="card shadow-sm border-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" style="min-width: 600px;">
                                <thead class="table-light"><tr><th class="ps-3">Empresa</th><th>Documento</th><th>Contacto</th><th>Info Extra</th><th class="text-end pe-3">Acciones</th></tr></thead>
                                <tbody>
                                    <tr v-for="prov in proveedores" :key="prov.id_proveedor">
                                        <td class="ps-3 fw-bold text-brand">{{ prov.razon_social }}</td>
                                        <td><span class="badge bg-light text-dark border">{{ prov.doc_identidad }}</span></td>
                                        <td>{{ prov.contacto }}</td>
                                        <td class="small text-muted"><div v-for="(val, key) in prov.datos_adicionales"><span v-if="val" class="d-block"> <strong>{{ key }}:</strong> {{ val }}</span></div></td>
                                        <td class="text-end pe-3"><button class="btn btn-sm btn-light text-brand border me-1" @click="abrirModalProveedor(prov)"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-light text-danger border" @click="eliminarProveedor(prov)"><i class="bi bi-trash"></i></button></td>
                                    </tr>
                                    <tr v-if="proveedores.length === 0"><td colspan="5" class="text-center p-5 text-muted">No hay proveedores registrados.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div v-if="vistaActual === 'config'">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-brand text-white rounded p-2 me-3 shadow-sm d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                            <i class="bi bi-gear-fill fs-4"></i>
                        </div>
                        <div>
                            <h3 class="fw-bold text-dark mb-0">Configuraci贸n del Sistema</h3>
                            <small class="text-muted">Ajustes generales y par谩metros</small>
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="card h-100 shadow-sm border-0">
                                <div class="card-body">
                                    <h6 class="fw-bold text-secondary mb-3"><i class="bi bi-receipt me-2 text-brand"></i>Secuencia Facturaci贸n</h6>
                                    <p class="text-muted small mb-2" style="font-size: 0.8rem;">ltimo n煤mero emitido. Se incrementar谩 autom谩ticamente.</p>
                                    <div class="input-group">
                                        <input type="text" class="form-control" v-model="configFacturaActual" placeholder="001-001-0000000">
                                        <button class="btn btn-outline-success" @click="guardarConfigFactura" title="Guardar"><i class="bi bi-check-lg"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card h-100 shadow-sm border-0">
                                <div class="card-body">
                                    <h6 class="fw-bold text-secondary mb-3"><i class="bi bi-truck me-2 text-brand"></i>Secuencia Remisiones</h6>
                                    <p class="text-muted small mb-2" style="font-size: 0.8rem;">ltimo n煤mero de Nota de Remisi贸n emitido.</p>
                                    <div class="input-group">
                                        <input type="text" class="form-control" v-model="configRemisionActual" placeholder="001-001-0000000">
                                        <button class="btn btn-outline-success" @click="guardarConfigRemision" title="Guardar"><i class="bi bi-check-lg"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card h-100 shadow-sm border-0">
                                <div class="card-body">
                                    <h6 class="fw-bold text-secondary mb-3"><i class="bi bi-house-door me-2 text-brand"></i>Dep贸sito Predeterminado</h6>
                                    <p class="text-muted small mb-2" style="font-size: 0.8rem;">Selecci贸n autom谩tica para nuevas operaciones.</p>
                                    <div class="input-group">
                                        <select class="form-select" v-model="depositoDefault">
                                            <option value="" disabled>Seleccionar...</option>
                                            <option v-for="d in listaDepositos" :value="d.id_deposito">{{ d.nombre }}</option>
                                        </select>
                                        <button class="btn btn-outline-success" @click="guardarConfigDepositoDefault" title="Guardar"><i class="bi bi-check-lg"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm border-0 mb-4 border-top border-4 border-brand">
                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                            <h6 class="fw-bold m-0"><i class="bi bi-building me-2"></i>Administrar Dep贸sitos</h6>
                            <button class="btn btn-sm btn-brand text-white fw-bold" @click="abrirModalDeposito(null)">
                                <i class="bi bi-plus-lg me-1"></i> Nuevo
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-3">Nombre</th>
                                        <th>Direcci贸n</th>
                                        <th>Responsable</th>
                                        <th>Estado</th>
                                        <th class="text-end pe-3">Acci贸n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="d in listaDepositos" :key="d.id_deposito">
                                        <td class="ps-3 fw-bold">{{ d.nombre }}</td>
                                        <td class="small text-muted">{{ d.direccion }}</td>
                                        <td class="small">{{ d.responsable }}</td>
                                        <td><span class="badge" :class="d.activo=='Si'?'bg-success bg-opacity-75':'bg-secondary'">{{ d.activo }}</span></td>
                                        <td class="text-end pe-3">
                                            <button class="btn btn-sm btn-light text-primary border me-1" @click="abrirModalDeposito(d)"><i class="bi bi-pencil"></i></button>
                                            <button class="btn btn-sm btn-light text-danger border" @click="eliminarDeposito(d)"><i class="bi bi-trash"></i></button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card shadow-sm border-0 mb-4 border-top border-4 border-warning">
                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                            <h6 class="fw-bold m-0"><i class="bi bi-tags-fill me-2 text-warning"></i>Categor铆as de Productos</h6>
                            <button class="btn btn-sm btn-warning text-dark fw-bold" @click="abrirModalCategoria(null)">
                                <i class="bi bi-plus-lg me-1"></i> Nueva
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-3">Nombre de la Categor铆a</th>
                                        <th class="text-end pe-3">Acci贸n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="c in listaCategorias" :key="c.id_categoria">
                                        <td class="ps-3 fw-bold text-dark">{{ c.nombre }}</td>
                                        <td class="text-end pe-3">
                                            <button class="btn btn-sm btn-light text-primary border me-1" @click="abrirModalCategoria(c)" title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-light text-danger border" @click="eliminarCategoria(c)" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr v-if="listaCategorias.length === 0">
                                        <td colspan="2" class="text-center py-3 text-muted">No hay categor铆as registradas.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card shadow-sm border-0 border-top border-4 border-secondary">
                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                            <h6 class="fw-bold m-0"><i class="bi bi-input-cursor-text me-2"></i>Campos Personalizados</h6>
                            <button class="btn btn-sm btn-secondary fw-bold" @click="abrirModalCampo(null)">
                                <i class="bi bi-plus-lg me-1"></i> Nuevo
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-3">Entidad</th>
                                        <th>Etiqueta</th>
                                        <th>Tipo</th>
                                        <th class="text-center">Obligatorio</th>
                                        <th class="text-end pe-3">Acci贸n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="c in listaConfigCampos" :key="c.id_campo">
                                        <td class="ps-3"><span class="badge bg-light text-dark border text-uppercase">{{ c.entidad_objetivo }}</span></td>
                                        <td class="fw-bold text-secondary">{{ c.etiqueta_visible }}</td>
                                        <td class="small text-muted font-monospace">{{ c.tipo_dato }}</td>
                                        <td class="text-center">
                                            <i v-if="esObligatorio(c.es_obligatorio)" class="bi bi-check-circle-fill text-success" title="Obligatorio"></i>
                                            <span v-else class="text-muted text-opacity-25">-</span>
                                        </td>
                                        <td class="text-end pe-3">
                                            <button class="btn btn-sm btn-light text-primary border me-1" @click="abrirModalCampo(c)"><i class="bi bi-pencil"></i></button>
                                            <button class="btn btn-sm btn-light text-danger border" @click="eliminarCampo(c)"><i class="bi bi-trash"></i></button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="modalCategoria" tabindex="-1">
                  <div class="modal-dialog modal-dialog-centered modal-sm">
                      <div class="modal-content">
                          <div class="modal-header bg-warning">
                              <h5 class="modal-title fw-bold text-dark">{{ formCategoria.id_categoria ? 'Editar' : 'Nueva' }} Categor铆a</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                              <form @submit.prevent="guardarCategoria">
                                  <div class="mb-3">
                                      <label class="form-label fw-bold small">Nombre</label>
                                      <input type="text" class="form-control" v-model="formCategoria.nombre" required placeholder="Ej: Bebidas, Limpieza...">
                                  </div>
                                  <div class="d-grid">
                                      <button type="submit" class="btn btn-dark fw-bold">Guardar</button>
                                  </div>
                              </form>
                          </div>
                      </div>
                  </div>
                </div>

            </div>
        </div>
      </div>
      
      <nav class="fixed-bottom bottom-nav d-md-none z-3">
          <div class="d-flex justify-content-around">
              <a class="nav-item-mobile" :class="{active: vistaActual === 'ventas'}" @click="cambiarVista('ventas')">
                  <i class="bi bi-receipt"></i><span>Ventas</span>
              </a>
              <a class="nav-item-mobile" :class="{active: vistaActual === 'compras'}" @click="cambiarVista('compras')">
                  <i class="bi bi-cart-plus"></i><span>Compras</span>
              </a>
              <a class="nav-item-mobile" :class="{active: vistaActual === 'productos'}" @click="cambiarVista('productos')">
                  <i class="bi bi-box-seam"></i><span>Stock</span>
              </a>
              <a class="nav-item-mobile" data-bs-toggle="offcanvas" href="#menuMovil">
                  <i class="bi bi-list"></i><span>Men煤</span>
              </a>
          </div>
      </nav>

      <div class="offcanvas offcanvas-end" tabindex="-1" id="menuMovil">
          <div class="offcanvas-header bg-brand text-white">
              <h5 class="offcanvas-title fw-bold">
                  <i class="bi bi-grid-fill me-2"></i>Men煤 Cesta
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
          </div>
          <div class="offcanvas-body">
              <div class="d-grid gap-2">
                  <small class="text-muted text-uppercase fw-bold mt-2">Facturaci贸n</small>
                  <button class="btn btn-light text-start border py-3" @click="cambiarVista('remisiones'); cerrarMenuMovil()">
                      <i class="bi bi-truck-flatbed me-3 text-brand"></i> Notas de Remisi贸n
                  <button class="btn btn-light text-start border py-3" @click="cambiarVista('ventas'); cerrarMenuMovil()">
                      <i class="bi bi-receipt me-3 text-brand"></i> Ventas / Caja
                  </button>
                  <button class="btn btn-light text-start border py-3" @click="cambiarVista('compras'); cerrarMenuMovil()">
                      <i class="bi bi-cart-plus me-3 text-brand"></i> Compras / Stock
                  </button>
                  <button class="btn btn-light text-start border py-3" @click="cambiarVista('transferencias'); cerrarMenuMovil()">
                      <i class="bi bi-arrow-left-right me-3 text-brand"></i> Transferencias
                  </button>
                  <button class="btn btn-light text-start border py-3" @click="cargarCobranzas(); cerrarMenuMovil()">
                      <i class="bi bi-wallet2 me-3 text-brand"></i> Cobranzas
                  </button>
                  <small class="text-muted text-uppercase fw-bold mt-3">Gesti贸n</small>
                  <button class="btn btn-light text-start border py-3" @click="cambiarVista('productos'); cerrarMenuMovil()">
                      <i class="bi bi-box-seam me-3 text-brand"></i> Inventario
                  </button>
                  <button class="btn btn-light text-start border py-3" @click="cambiarVista('clientes'); cerrarMenuMovil()">
                      <i class="bi bi-people me-3 text-brand"></i> Clientes
                  </button>
                  <button class="btn btn-light text-start border py-3" @click="cambiarVista('proveedores'); cerrarMenuMovil()">
                      <i class="bi bi-truck me-3 text-brand"></i> Proveedores
                  </button>

                  <small class="text-muted text-uppercase fw-bold mt-3">Sistema</small>
                  <button class="btn btn-light text-start border py-3" @click="cambiarVista('config'); cerrarMenuMovil()">
                      <i class="bi bi-gear me-3 text-brand"></i> Configuraci贸n
                  </button>
              </div>
          </div>
      </div>

      <div class="modal fade" id="modalDeposito" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-brand text-white"><h5 class="modal-title">Dep贸sito</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form @submit.prevent="guardarDeposito"><div class="mb-3"><label>Nombre</label><input type="text" class="form-control" v-model="formDeposito.nombre" required></div><div class="mb-3"><label>Direcci贸n</label><input type="text" class="form-control" v-model="formDeposito.direccion"></div><div class="row"><div class="col-6"><label>Responsable</label><input type="text" class="form-control" v-model="formDeposito.responsable"></div><div class="col-6"><label>Activo</label><select class="form-select" v-model="formDeposito.activo"><option>Si</option><option>No</option></select></div></div><div class="d-grid mt-3"><button type="submit" class="btn btn-brand">Guardar</button></div></form></div></div></div></div>

      <div class="modal fade" id="modalCampo" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-brand text-white"><h5 class="modal-title">Campo Personalizado</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form @submit.prevent="guardarCampo"><div class="mb-3"><label>Entidad</label><select class="form-select" v-model="formCampo.entidad_objetivo" required><option value="producto">Producto</option><option value="cliente">Cliente</option><option value="proveedor">Proveedor</option></select></div><div class="row g-2 mb-3"><div class="col-6"><label>Key (interno)</label><input type="text" class="form-control" v-model="formCampo.key_interno" required></div><div class="col-6"><label>Etiqueta Visible</label><input type="text" class="form-control" v-model="formCampo.etiqueta_visible" required></div></div><div class="mb-3"><label>Tipo</label><select class="form-select" v-model="formCampo.tipo_dato"><option value="text">Texto</option><option value="number">N煤mero</option><option value="date">Fecha</option><option value="select">Lista</option></select></div><div class="mb-3" v-if="formCampo.tipo_dato === 'select'"><label>Opciones (x,y,z)</label><input type="text" class="form-control" v-model="formCampo.opciones_lista"></div><div class="form-check mb-3"><input class="form-check-input" type="checkbox" v-model="formCampo.es_obligatorio"><label>Obligatorio</label></div><div class="d-grid"><button type="submit" class="btn btn-brand">Guardar</button></div></form></div></div></div></div>

      <div class="modal fade" id="modalCliente" tabindex="-1" data-bs-backdrop="static">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header bg-brand text-white">
                    <h5 class="modal-title">{{ modoEdicion ? 'Editar' : 'Nuevo' }} Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body bg-light">
                      <form @submit.prevent="guardarCliente">
                          <div class="card border-0 shadow-sm mb-3">
                              <div class="card-body">
                                  <div class="mb-3">
                                      <label class="form-label text-secondary small fw-bold">Raz贸n Social</label>
                                      <input type="text" class="form-control" v-model="formCliente.razon_social" required>
                                  </div>
                                  
                                  <div class="mb-3">
                                      <label class="form-label text-secondary small fw-bold">RUC</label>
                                      <input type="text" class="form-control" v-model="formCliente.doc_identidad" required>
                                  </div>

                                  <div class="mb-3">
                                      <label class="form-label text-secondary small fw-bold">Email</label>
                                      <input type="email" class="form-control" v-model="formCliente.email">
                                  </div>
                                  
                                  <div class="mb-3">
                                      <label class="form-label text-secondary small fw-bold">Tel茅fono</label>
                                      <input type="text" class="form-control" v-model="formCliente.telefono">
                                  </div>
                              </div>
                          </div>

                          <div v-if="camposExtraCliente.length > 0" class="card border-0 shadow-sm mb-3">
                              <div class="card-body">
                                  <div v-for="campo in camposExtraCliente" :key="campo.id_campo" class="mb-3">
                                      <label class="form-label text-secondary small fw-bold">{{ campo.etiqueta_visible }}</label>
                                      
                                      <select v-if="campo.tipo_dato === 'select'" class="form-select" v-model="formCliente.datos_adicionales[campo.key_interno]" :required="esObligatorio(campo.es_obligatorio)">
                                          <option value="">Seleccionar...</option>
                                          <option v-for="op in campo.opciones_lista.split(',')" :value="op.trim()">{{ op.trim() }}</option>
                                      </select>
                                      
                                      <input v-else :type="campo.tipo_dato" class="form-control" v-model="formCliente.datos_adicionales[campo.key_interno]" :required="esObligatorio(campo.es_obligatorio)">
                                  </div>
                              </div>
                          </div>

                          <button type="submit" class="btn btn-brand w-100 py-2 fw-bold">Guardar</button>
                      </form>
                  </div>
                </div>
              </div>
            </div>
      
      <div class="modal fade" id="modalProducto" tabindex="-1" data-bs-backdrop="static">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header bg-brand text-white">
                      <h5 class="modal-title">{{ modoEdicion ? 'Editar' : 'Nuevo' }} Producto</h5>
                      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body bg-light">
                        <form @submit.prevent="procesarGuardadoProducto">
                            
                            <div class="card border-0 shadow-sm mb-3">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-5 d-flex flex-column align-items-center justify-content-center border-end">
                                            <div class="mb-3 d-flex align-items-center justify-content-center bg-white border rounded" style="width: 100%; height: 180px; overflow: hidden;">
                                                <img v-if="imagenPreview" :src="imagenPreview" class="img-fluid" style="object-fit: contain; max-height: 100%;">
                                                <div v-else class="text-muted text-center">
                                                    <i class="bi bi-image fs-1 opacity-25"></i><br>
                                                    <small>Sin imagen</small>
                                                </div>
                                            </div>
                                            <input type="file" class="form-control form-control-sm" accept="image/*" @change="manejarArchivo">
                                        </div>

                                        <div class="col-md-7">
                                            <div class="mb-3">
                                                <label class="form-label text-secondary small fw-bold">Nombre del Producto</label>
                                                <input type="text" class="form-control" v-model="formProducto.nombre" required>
                                            </div>
                                        <div class="row g-2 mb-2">
                                            <div class="col-6">
                                                <label class="form-label text-secondary small fw-bold">SKU / C贸digo</label>
                                                <input type="text" class="form-control" v-model="formProducto.sku" required>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label text-secondary small fw-bold">Precio Base</label>
                                                <input type="number" class="form-control" v-model="formProducto.precio_venta_base" required>
                                            </div>
                                        </div>

                                        <div class="row g-2 mt-2 bg-light p-2 rounded border">
                                            <div class="col-6">
                                                <label class="form-label small fw-bold text-dark">Tasa IVA %</label>
                                                <select class="form-select form-select-sm" v-model="formProducto.impuesto_iva">
                                                    <option value="10">10%</option>
                                                    <option value="5">5%</option>
                                                    <option value="0">Exenta</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label small fw-bold text-dark">M茅todo</label>
                                                <select class="form-select form-select-sm" v-model="formProducto.metodo_iva">
                                                    <option value="INCLUIDO">IVA Incluido</option>
                                                    <option value="EXCLUIDO">IVA Excluido (+)</option>
                                                </select>
                                            </div>
                                            <div class="col-12 text-end">
                                                <small class="text-muted" v-if="formProducto.metodo_iva === 'EXCLUIDO'">
                                                    Precio Final en Caja: <strong>{{ formatoMoneda(formProducto.precio_venta_base * (1 + (formProducto.impuesto_iva/100))) }}</strong>
                                                </small>
                                                <small class="text-muted" v-else>
                                                    El precio de lista ya incluye el impuesto.
                                                </small>
                                            </div>
                                        </div>
                                            </div>
                                            <div class="row g-2 mt-2">
                                                <div class="col-4">
                                                    <label class="form-label text-secondary small fw-bold">Categor铆a</label>
                                                    <select class="form-select" v-model="formProducto.id_categoria" required>
                                                        <option v-for="c in listaCategorias" :value="c.id_categoria">{{c.nombre}}</option>
                                                    </select>
                                                </div>
                                                <div class="col-4">
                                                    <label class="form-label text-secondary small fw-bold">Stock M铆nimo</label>
                                                    <input type="number" class="form-control" v-model="formProducto.stock_minimo">
                                                </div>
                                                <div class="col-4">
                                                  <label class="form-label text-secondary small fw-bold">Unidad de Medida</label>
                                                  <select class="form-select" v-model="formProducto.unidad_medida">
                                                      <option value="Unidad">Unidad</option>
                                                      <option value="Caja">Caja</option>
                                                      <option value="Kg">Kg</option>
                                                      <option value="Litro">Litro</option>
                                                      <option value="Metro">Metro</option>
                                                  </select>
                                              </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div v-if="camposExtraProducto.length > 0" class="card border-0 shadow-sm mb-3">
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-4" v-for="campo in camposExtraProducto" :key="campo.id_campo">
                                            <label class="form-label text-secondary small fw-bold mb-1">{{ campo.etiqueta_visible }}</label>
                                            
                                            <select v-if="campo.tipo_dato === 'select'" class="form-select" v-model="formProducto.datos_adicionales[campo.key_interno]" :required="esObligatorio(campo.es_obligatorio)">
                                                <option value="">Seleccionar...</option>
                                                <option v-for="op in campo.opciones_lista.split(',')" :value="op.trim()">{{ op.trim() }}</option>
                                            </select>
                                            
                                            <input v-else :type="campo.tipo_dato" class="form-control" v-model="formProducto.datos_adicionales[campo.key_interno]" :required="esObligatorio(campo.es_obligatorio)">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-brand w-100 py-2 fw-bold" @click="procesarGuardadoProducto"><i class="bi bi-save me-2"></i> Guardar </button>
                        </form>
                    </div>
                  </div>
                </div>
            </div>
      
      <div class="modal fade" id="modalProveedor" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header bg-brand text-white">
                  <h5 class="modal-title">{{ modoEdicion ? 'Editar' : 'Nuevo' }} Proveedor</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    <form @submit.prevent="guardarProveedor">
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Raz贸n Social <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" v-model="formProveedor.razon_social" required placeholder="Nombre de la empresa">
                                </div>
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <label class="form-label fw-bold">Documento</label>
                                        <input type="text" class="form-control" v-model="formProveedor.doc_identidad" required placeholder="RUC / CI">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label fw-bold">Contacto</label>
                                        <input type="text" class="form-control" v-model="formProveedor.contacto" placeholder="Tel茅fono / Email">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div v-if="camposExtraProveedor.length > 0" class="card border-0 shadow-sm mb-3">
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-12" v-for="campo in camposExtraProveedor" :key="campo.id_campo">
                                        <label class="form-label small mb-1">{{ campo.etiqueta_visible }} <span v-if="esObligatorio(campo.es_obligatorio)" class="text-danger">*</span></label>
                                        <select v-if="campo.tipo_dato === 'select'" class="form-select form-select-sm" v-model="formProveedor.datos_adicionales[campo.key_interno]" :required="esObligatorio(campo.es_obligatorio)">
                                            <option value="">Seleccionar...</option>
                                            <option v-for="op in campo.opciones_lista.split(',')" :value="op.trim()">{{ op.trim() }}</option>
                                        </select>
                                        <input v-else :type="campo.tipo_dato" class="form-control form-control-sm" v-model="formProveedor.datos_adicionales[campo.key_interno]" :required="esObligatorio(campo.es_obligatorio)">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-brand fw-bold">Guardar</button>
                        </div>
                    </form>
                </div>
              </div>
            </div>
        </div>
    </div>    

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const { createApp } = Vue;
      createApp({
        data() {
          return {
            cargando: false, vistaActual: 'remisiones', subVistaVentas:'nueva', subVistaCompras:'nueva',
            productos: [], proveedores: [], clientes: [], listaDepositos: [], listaConfigCampos: [], listaCategorias: [], listaUnidades: [],
            
            formDeposito: { nombre:'', direccion:'', responsable:'', activo:'Si' },
            formCampo: { entidad_objetivo:'producto', key_interno:'', etiqueta_visible:'', tipo_dato:'text', opciones_lista:'', es_obligatorio:false },
            configFacturaActual: '',

            configRemisionActual: '', // Remision
            busquedaRemision: '',
            
            subVistaRemision: 'nueva',
            historialRemisiones: [],
            carritoRemision: [],
            formRemision: { 
                fecha: new Date().toISOString().slice(0,10), 
                numero: '', 
                id_cliente: '', 
                id_deposito: '', 
                conductor: '', 
                chapa: '' 
            },
            lineaRemision: { id_producto: '', cantidad: 1 },

            formCategoria: { id_categoria: '', nombre: '' },
            modalCat: null, // Referencia al modal

            formVenta: { id_cliente:'', fecha: new Date().toISOString().slice(0,10), nro_factura: '' },
            lineaVenta: { id_producto:'', cantidad:1, precio:0 },
            carritoVenta: [], 
            busquedaVenta: '',
            historialVentas: [], 
            itemsDetalle: [],
            
            formCompra: { id_proveedor:'', fecha: new Date().toISOString().slice(0,10), comprobante: '' },
            lineaTemp: { id_producto:'', cantidad:'', costo:'' },
            carritoCompra: [], historialCompras: [],

            configGeneral: {}, // Para guardar toda la config
            depositoDefault: '', // Para el v-model del select de configuraci贸n

            subVistaTransf: 'nueva', historialTransf: [], carritoTransf: [], formTransf: { fecha: new Date().toISOString().slice(0,10), origen: '', destino: '', responsable: 'Admin', observacion: '' }, lineaTransf: { id_producto: '', cantidad: 1 },

            // Nuevos datos para Cobranzas
            clientesDeudores: [],
            formCobro: { 
                id_cliente:'', 
                id_venta: '', // <--- IMPORTANTE: Agregado
                monto:0, 
                metodo:'Efectivo', 
                observacion:'', 
                nombre: '', 
                deuda_total: 0, // Esto ahora ser谩 "Saldo Factura" visualmente
                nro_factura_visual: '' // Para mostrar en el modal
            },
            subVistaCobranzas: 'listado',
            formProducto: { 
                nombre:'', sku:'', precio_venta_base:0, 
                impuesto_iva: 10, metodo_iva: 'INCLUIDO', // <--- AGREGAR ESTO
                datos_adicionales:{} 
            },
            formCliente: { razon_social:'', doc_identidad:'', email:'', datos_adicionales:{} }, 
            formProveedor: { razon_social:'', doc_identidad:'', contacto:'', datos_adicionales:{} },
            modoEdicion: false, archivoParaSubir: null, imagenPreview: null,
            modalDep: null, modalCmp: null, modalProd: null, modalCli: null, modalProv: null, modalDetalle: null
          }
        },
        computed: {
            camposExtraProducto() { return this.listaConfigCampos.filter(c => c.entidad_objetivo === 'producto'); },
            camposExtraCliente() { return this.listaConfigCampos.filter(c => c.entidad_objetivo === 'cliente'); },
            camposExtraProveedor() { return this.listaConfigCampos.filter(c => c.entidad_objetivo === 'proveedor'); },
            totalVenta() { return this.carritoVenta.reduce((acc, i) => acc + (i.cantidad * i.precio_final), 0); },
            totalIVA() {
                return this.carritoVenta.reduce((acc, item) => {
                    // Precio Final es lo que paga el cliente
                    const totalLinea = item.cantidad * item.precio_final;
                    const tasa = Number(item.tasa_iva);
                    
                    if (tasa === 0) return acc;

                    let montoIVA = 0;
                    if (tasa === 10) montoIVA = totalLinea / 11;
                    if (tasa === 5) montoIVA = totalLinea / 21;
                    
                    return acc + montoIVA;
                }, 0);
            },
            totalCompra() { return this.carritoCompra.reduce((acc, i) => acc + (i.cantidad * i.costo), 0); },

        ventasFiltradas() {
                // 1. Blindaje contra errores (Airbag)
                if (!this.historialVentas || !Array.isArray(this.historialVentas)) {
                    return [];
                }

                // 2. Si no escriben nada, devolvemos todo
                if (!this.busquedaVenta) {
                    return this.historialVentas;
                }
                
                // 3. Filtrado (Cliente o Factura)
                const texto = this.busquedaVenta.toLowerCase().trim();
                
                return this.historialVentas.filter(item => {
                    const cliente = String(item.nombre_cliente || '').toLowerCase();
                    const factura = String(item.factura || '').toLowerCase();
                    
                    return cliente.includes(texto) || factura.includes(texto);
                });
            },
        
        remisionesFiltradas() {
            // 1. Si no existe la lista, devolvemos array vac铆o (evita el error undefined)
            if (!this.historialRemisiones || !Array.isArray(this.historialRemisiones)) {
                return [];
            }

            // 2. Si no hay b煤squeda, devolvemos todo
            if (!this.busquedaRemision) {
                return this.historialRemisiones;
            }
            
            // 3. Filtrado seguro
            const texto = this.busquedaRemision.toLowerCase().trim();
            return this.historialRemisiones.filter(item => {
                // Forzamos conversi贸n a string por si viene un n煤mero o null
                const n = String(item.numero || '').toLowerCase();
                const c = String(item.cliente || '').toLowerCase();
                return n.includes(texto) || c.includes(texto);
            });
          }
      },
        mounted() {
            // Inicializar componentes de Bootstrap
            this.modalDep = new bootstrap.Modal(document.getElementById('modalDeposito'));
            this.modalCmp = new bootstrap.Modal(document.getElementById('modalCampo'));
            this.modalProd = new bootstrap.Modal(document.getElementById('modalProducto'));
            this.modalCli = new bootstrap.Modal(document.getElementById('modalCliente'));
            this.modalProv = new bootstrap.Modal(document.getElementById('modalProveedor'));
            this.modalDetalle = new bootstrap.Modal(document.getElementById('modalDetalle'));
            this.modalCat = new bootstrap.Modal(document.getElementById('modalCategoria'));
            
            // Cargar datos
            this.cargarDatosIniciales();

            // --- LGICA DEL BOTN ATRS (NUEVO) ---
            // 1. Crear el estado inicial
            window.history.replaceState({ vista: 'ventas' }, null, '');

            // 2. Escuchar cuando el usuario presiona "Atr谩s"
            window.onpopstate = (event) => {
                if (event.state && event.state.vista) {
                    // Si hay un estado guardado, volvemos a esa vista
                    this.vistaActual = event.state.vista;
                    
                    // Si estamos volviendo al men煤 principal, cerramos cualquier men煤 lateral abierto
                    this.cerrarMenuMovil();
                }
            };
        },
        methods: {
            formatoMoneda(val) { if(!val) return 'Gs 0'; return new Intl.NumberFormat('es-PY').format(val); },
            cambiarVista(v) { 
                // Si la vista es la misma, no hacemos nada para no ensuciar el historial
                if(this.vistaActual === v) return;

                this.vistaActual = v; 
                window.scrollTo(0,0);
                
                // --- AGREGAR AL HISTORIAL (NUEVO) ---
                // Esto crea un punto de retorno para el bot贸n "Atr谩s"
                window.history.pushState({ vista: v }, null, '');
            },
            
            // Nueva funci贸n para cerrar el men煤 m贸vil al hacer clic en una opci贸n
            cerrarMenuMovil() {
                const menuEl = document.getElementById('menuMovil');
                const menuBS = bootstrap.Offcanvas.getOrCreateInstance(menuEl);
                if (menuBS) menuBS.hide();
            },

            abrirModalCategoria(item) {
                this.formCategoria = item ? { ...item } : { id_categoria: '', nombre: '' };
                this.modalCat.show();
            },

            guardarCategoria() {
                if (!this.formCategoria.nombre) return alert("Escribe un nombre");
                this.cargando = true;
                
                google.script.run
                    .withSuccessHandler(() => {
                        this.cargando = false;
                        this.modalCat.hide();
                        this.cargarDatosIniciales(); // Recargar para ver los cambios y actualizar selectores de productos
                        alert(" Categor铆a guardada");
                    })
                    .withFailureHandler(e => {
                        this.cargando = false;
                        alert("Error: " + e);
                    })
                    .guardarCategoria(this.formCategoria);
            },

            eliminarCategoria(item) {
                if (!confirm("驴Eliminar la categor铆a '" + item.nombre + "'?\n(Aseg煤rate que no tenga productos asociados)")) return;
                
                this.cargando = true;
                google.script.run
                    .withSuccessHandler(() => {
                        this.cargando = false;
                        this.cargarDatosIniciales();
                    })
                    .withFailureHandler(e => {
                        this.cargando = false;
                        alert("Error: " + e);
                    })
                    .eliminarCategoria(item.id_categoria);
            },

            esObligatorio(v) { return v === true || v === 'TRUE'; },
            
            cargarDatosIniciales() {
                this.cargando = true;
                Promise.all([
                    new Promise(r => google.script.run.withSuccessHandler(r).obtenerProductosConStock()), 
                    this.pedirDatos('PROVEEDORES'), 
                    new Promise(r => google.script.run.withSuccessHandler(r).obtenerClientes()),
                    this.pedirDatos('CATEGORIAS'), 
                    this.pedirDatos('UNIDADES'),
                    new Promise(r => google.script.run.withSuccessHandler(r).obtenerConfigCampos()),
                    new Promise(r => google.script.run.withSuccessHandler(r).obtenerDepositos()),
                    new Promise(r => google.script.run.withSuccessHandler(r).obtenerConfigFactura()),
                    new Promise(r => google.script.run.withSuccessHandler(r).obtenerConfigGeneral()),
                    new Promise(r => google.script.run.withSuccessHandler(r).obtenerConfigRemision())
                ]).then(res => {
                    this.productos = res[0]; 
                    this.proveedores = res[1]; 
                    this.clientes = res[2];
                    this.listaCategorias = res[3]; 
                    this.listaUnidades = res[4];
                    this.listaConfigCampos = res[5] || [];
                    this.listaDepositos = res[6] || [];
                    this.configFacturaActual = res[7];
                    this.configGeneral = res[8] || {};
                    this.configRemisionActual = res[9];
                    // Extraemos el dep贸sito default o dejamos vac铆o si no existe
                    this.depositoDefault = this.configGeneral['DEPOSITO_DEFAULT'] || '';

                    //  3. APLICAMOS EL DEFAULT AL FORMULARIO DE VENTA
                    // Si existe un default configurado, lo pre-seleccionamos.
                    // Si no, forzamos "1" (Dep贸sito Central) como respaldo.
                    this.formVenta.id_deposito = this.depositoDefault || '1';

                    this.cargando = false;
                });
              },

            anularRemision(h) {
                if(!confirm("锔 驴Est谩s seguro de ANULAR la Remisi贸n Nro: " + h.numero + "?\n\nEl stock de los productos volver谩 al dep贸sito de origen.")) return;
                
                this.cargando = true;
                google.script.run
                    .withSuccessHandler(() => {
                        this.cargando = false;
                        alert(" Remisi贸n anulada correctamente.\nEl stock ha sido devuelto.");
                        this.cargarHistorialRemisiones(); // Refrescar lista
                        this.cargarDatosIniciales(); // Refrescar stock visual global
                    })
                    .withFailureHandler(e => {
                        this.cargando = false;
                        alert(" Error al anular: " + e);
                    })
                    .anularRemision(h.id_remision);
            },

            guardarConfigRemision() {
                this.cargando = true;
                google.script.run.withSuccessHandler(() => {
                    this.cargando = false;
                    alert(" Secuencia de remisi贸n actualizada");
                }).guardarConfigRemision(this.configRemisionActual);
            },

            // LGICA DE REMISIN MEJORADA (CON PRECIOS Y AUTO-NUM)
            agregarAlCarritoRemision() {
                if(!this.lineaRemision.id_producto || this.lineaRemision.cantidad < 1) return;

                // Buscamos el producto para obtener su precio y nombre
                const p = this.productos.find(x => x.id_producto == this.lineaRemision.id_producto);

                if (p) {
                    this.carritoRemision.push({ 
                        ...this.lineaRemision, 
                        nombre_prod: p.nombre,
                        // Usamos el precio base como referencia para valorizar
                        precio: p.precio_venta_base 
                    });
                    this.lineaRemision = { id_producto: '', cantidad: 1 };
                }
            },

            guardarRemisionFinal() {
                if(!this.formRemision.id_cliente || !this.formRemision.id_deposito || this.carritoRemision.length === 0) {
                    return alert("Faltan datos.");
                }

                this.cargando = true;
                // Calculamos el nombre del cliente para el PDF
                const cli = this.clientes.find(c => c.id_cliente == this.formRemision.id_cliente);

                const paquete = { 
                    ...this.formRemision, 
                    items: this.carritoRemision,
                    nombre_cliente: cli ? cli.razon_social : 'Cliente' 
                };

                google.script.run
                    .withSuccessHandler(res => {
                        this.cargando = false;
                        if(res.pdf_url) window.open(res.pdf_url, '_blank');
                        alert(" Remisi贸n " + res.numero + " generada correctamente.");
                        this.carritoRemision = [];
                        // Actualizamos el n煤mero visualmente
                        this.cargarDatosIniciales(); 
                    })
                    .withFailureHandler(e => {
                        this.cargando = false;
                        alert("Error: " + e);
                    })
                    .guardarRemision(paquete);
            },

            facturarDesdeRemision(h) {
                // 1. Confirmaci贸n Inicial
                if(!confirm("驴Convertir Remisi贸n " + h.numero + " en Factura?")) return;

                // 2. Preguntar Condici贸n de Venta (Simple y efectivo)
                let condicion = "CONTADO"; // Valor por defecto
                const respuesta = prompt("Ingrese la Condici贸n de Venta:\n\n1 = CONTADO\n2 = CRDITO", "1");
                
                if (respuesta === null) return; // Si el usuario cancela, salimos
                if (respuesta === "2") condicion = "CREDITO";
                
                // Si escribe cualquier otra cosa, se queda en CONTADO por seguridad

                this.cargando = true;

                google.script.run.withSuccessHandler(itemsRemision => {
                    if(!itemsRemision || itemsRemision.length === 0) {
                        this.cargando = false;
                        return alert("Error: No se pudieron recuperar los items de la remisi贸n.");
                    }

                    // 3. Armar el paquete de Venta
                    const paqueteVenta = {
                        id_cliente: h.id_cliente_raw, // Cliente original
                        
                        // Usamos el dep贸sito de la remisi贸n (o el default si fallara)
                        id_deposito: h.id_deposito_raw || this.depositoDefault || '1', 
                        
                        fecha: new Date().toISOString().slice(0,10),
                        nro_factura: '', // Autom谩tico
                        condicion: condicion, //  LA ELEGIDA POR EL USUARIO
                        items: itemsRemision, 
                        es_desde_remision: true,
                        id_remision_origen: h.id_remision
                    };

                    // 4. Procesar Venta
                    google.script.run.withSuccessHandler(res => {
                        // Marcar como facturado
                        google.script.run.withSuccessHandler(() => {
                            this.cargando = false;
                            alert(" Factura (" + condicion + ") generada exitosamente.");
                            this.cargarHistorialRemisiones(); 
                        }).facturarRemision({ id_remision: h.id_remision });

                        if(res.pdf_url) window.open(res.pdf_url, '_blank');

                    }).guardarVenta(paqueteVenta);

                }).obtenerDetalleRemisionParaFacturar(h.id_remision);
            },

            cargarHistorialRemisiones() {
                this.subVistaRemision = 'historial';
                this.cargando = true;
                
                // 1. Limpieza preventiva
                this.historialRemisiones = []; 

                google.script.run
                    .withSuccessHandler(r => {
                        // 2. BLINDAJE: Si 'r' es nulo o undefined, usar array vac铆o []
                        if (!r || !Array.isArray(r)) {
                            console.warn("El backend no devolvi贸 una lista v谩lida:", r);
                            this.historialRemisiones = [];
                        } else {
                            this.historialRemisiones = r;
                        }
                        
                        this.cargando = false;
                    })
                    .withFailureHandler(e => {
                        console.error("Error backend:", e);
                        this.cargando = false;
                        this.historialRemisiones = []; // Evitamos que quede undefined
                        alert("Error cargando historial: " + e);
                    })
                    .obtenerHistorialRemisiones();
            },

            cargarCobranzas() {
                this.vistaActual = 'cobranzas';
                this.cargando = true;
                this.clientesDeudores = [];

                //alert("PASO 1: El bot贸n funciona. Llamando al servidor...");

                google.script.run
                    .withSuccessHandler(respuesta => {
                        this.cargando = false;
                        try {
                            // Parseamos la respuesta
                            const paquete = JSON.parse(respuesta);
                            
                            // 1. IMPRIMIR LOGS DEL SERVIDOR (IMPORTANTE)
                            console.log("=== LOGS DEL SERVIDOR ===");
                            console.log(paquete.logs.join("\n"));
                            
                            // Si no hay datos, mostrar alerta con los logs para diagnosticar
                            if (!paquete.datos || paquete.datos.length === 0) {
                                alert("锔 ALERTA DE DEBUG:\n" + paquete.logs.join("\n"));
                            }

                            // 2. ASIGNAR DATOS
                            this.clientesDeudores = paquete.datos || [];

                        } catch (e) {
                            alert("Error cr铆tico leyendo respuesta: " + e.message);
                        }
                    })
                    .withFailureHandler(e => {
                        this.cargando = false;
                        alert("Error de conexi贸n: " + e);
                    })
                    .obtenerClientesConDeuda();
            },
            abrirCobro(factura, cliente) {
                this.formCobro = { 
                    id_cliente: cliente.id_cliente,
                    id_venta: factura.id_venta, // Guardamos ID Factura
                    monto: 0, 
                    metodo: 'Efectivo', 
                    observacion: '', 
                    nombre: cliente.nombre, 
                    deuda_total: factura.saldo, // Ahora el l铆mite es el saldo de ESTA factura
                    nro_factura_visual: factura.numero 
                };
                this.subVistaCobranzas = 'nuevo';
            },
            guardarCobro() {
                if(this.formCobro.monto <= 0) return alert("Monto inv谩lido");
                
                // Validaci贸n estricta del saldo
                if(this.formCobro.monto > this.formCobro.deuda_total) {
                    return alert(" Error: No puedes cobrar m谩s del saldo pendiente de esta factura (" + this.formatoMoneda(this.formCobro.deuda_total) + ")");
                }
                
                this.cargando = true;
                google.script.run
                    .withSuccessHandler(() => {
                        this.cargando = false;
                        alert(" Pago aplicado a la factura " + this.formCobro.nro_factura_visual);
                        this.subVistaCobranzas = 'listado';
                        this.cargarCobranzas(); 
                    })
                    .withFailureHandler(e => {
                        this.cargando = false;
                        alert("Error: " + e);
                    })
                    .registrarCobro(this.formCobro);
            },

              agregarAlCarritoTransf() {
                  if(this.formTransf.origen === this.formTransf.destino) return alert("Origen y Destino iguales");
                  const p = this.productos.find(x => x.id_producto == this.lineaTransf.id_producto);
                  if(!p) return;
                  
                  // Validaci贸n b谩sica visual (la real est谩 en backend)
                  // Nota: Para validar stock exacto del dep贸sito origen aqu铆, necesitar铆amos l贸gica compleja en frontend.
                  // Por ahora validamos que exista el producto.
                  
                  this.carritoTransf.push({ ...this.lineaTransf, nombre: p.nombre, sku: p.sku });
                  this.lineaTransf = { id_producto: '', cantidad: 1 };
              },
              quitarCarritoTransf(i) { this.carritoTransf.splice(i,1); },
              limpiarTransf() { this.carritoTransf=[]; this.formTransf.observacion=''; },
              guardarTransfFinal() {
                  if(!this.formTransf.origen || !this.formTransf.destino || this.carritoTransf.length===0) return alert("Datos incompletos");
                  this.cargando=true;
                  const pkg = { ...this.formTransf, items: this.carritoTransf };
                  google.script.run.withSuccessHandler(res => {
                      this.cargando=false;
                      if(res.pdf_url) window.open(res.pdf_url, '_blank');
                      alert("Transferencia Exitosa");
                      this.limpiarTransf();
                      this.cargarDatosIniciales(); // Recargar datos
                  }).withFailureHandler(e => {
                      this.cargando=false;
                      alert("Error: " + e);
                  }).guardarTransferencia(pkg);
              },
              cargarHistorialTransf() {
                  this.subVistaTransf='historial';
                  this.cargando=true;
                  google.script.run.withSuccessHandler(r => {
                      this.historialTransf = r;
                      this.cargando=false;
                  }).obtenerHistorialTransferencias();
              },

            pedirDatos(hoja) { return new Promise(r => google.script.run.withSuccessHandler(r).getData(hoja)); },

            // Generar Ticket
            imprimirTicket(h) {
                this.cargando = true;
                google.script.run
                    .withSuccessHandler(url => {
                        this.cargando = false;
                        // Abrir en ventana peque帽a para imprimir f谩cil
                        window.open(url, 'Ticket', 'width=400,height=600');
                    })
                    .withFailureHandler(err => {
                        this.cargando = false;
                        alert("Error al generar ticket: " + err);
                    })
                    .generarUrlTicket(h.id_venta);
            },
            
            // Helpers
            obtenerNombreCategoria(id) { const c = this.listaCategorias.find(x => x.id_categoria == id); return c ? c.nombre : '...'; },
            obtenerEtiquetaCampo(key) { const c = this.listaConfigCampos.find(x => x.key_interno === key); return c ? c.etiqueta_visible : key; },
            tieneDatosValidos(item) { if (!item.datos_adicionales) return false; return Object.values(item.datos_adicionales).some(val => val && val.toString().trim() !== ''); },
            obtenerNombreProducto(id) { const p = this.productos.find(x => x.id_producto == id); return p ? p.nombre : '...'; },

            // CONFIG
            abrirModalDeposito(item) { this.formDeposito = item ? {...item} : { nombre:'', direccion:'', responsable:'', activo:'Si' }; this.modalDep.show(); },
            guardarDeposito() { this.cargando = true; google.script.run.withSuccessHandler(() => { this.cargando=false; this.modalDep.hide(); this.cargarDatosIniciales(); }).guardarDeposito(this.formDeposito); },
            eliminarDeposito(item) { if(!confirm("驴Borrar?")) return; this.cargando=true; google.script.run.withSuccessHandler(res => { this.cargando=false; if(res.error) alert(res.error); else this.cargarDatosIniciales(); }).eliminarDeposito(item.id_deposito); },
            
            abrirModalCampo(item) { 
                this.formCampo = item ? {...item} : { entidad_objetivo:'producto', key_interno:'', etiqueta_visible:'', tipo_dato:'text', opciones_lista:'', es_obligatorio:false }; 
                  if(this.formCampo.entidad_objetivo) {
                    this.formCampo.entidad_objetivo = this.formCampo.entidad_objetivo.toLowerCase();
                }
                this.modalCmp.show(); 
            },
            guardarCampo() { 
                this.cargando = true; 
                if(this.formCampo.entidad_objetivo) {
                    this.formCampo.entidad_objetivo = this.formCampo.entidad_objetivo.toLowerCase();
                }

                google.script.run.withSuccessHandler(() => { 
                    this.cargando=false; 
                    this.modalCmp.hide(); 
                    this.cargarDatosIniciales(); 
                }).guardarCampoConfig(this.formCampo); 
            },
            eliminarCampo(item) { if(!confirm("驴Borrar campo?")) return; this.cargando=true; google.script.run.withSuccessHandler(() => { this.cargando=false; this.cargarDatosIniciales(); }).eliminarCampoConfig(item.id_campo); },
            
            guardarConfigFactura() { this.cargando = true; google.script.run.withSuccessHandler(() => { this.cargando=false; alert("Numeraci贸n actualizada"); }).guardarConfigFactura(this.configFacturaActual); },

            guardarConfigDepositoDefault() {
                this.cargando = true;
                google.script.run
                    .withSuccessHandler(() => {
                        this.cargando = false;
                        alert(" Dep贸sito predeterminado guardado.");
                        // Recargamos datos para asegurar que se aplique en todos lados
                        this.cargarDatosIniciales(); 
                    })
                    .withFailureHandler(err => {
                        this.cargando = false;
                        alert("Error: " + err);
                    })
                    .guardarConfigGeneral('DEPOSITO_DEFAULT', this.depositoDefault);
            },

            // MODALES MAESTROS
            abrirModalCliente(item) { this.modoEdicion=!!item; this.formCliente = item ? JSON.parse(JSON.stringify(item)) : { razon_social:'', doc_identidad:'', email:'', datos_adicionales:{} }; if(!this.formCliente.datos_adicionales) this.formCliente.datos_adicionales={}; this.modalCli.show(); },
            guardarCliente() { this.cargando=true; const f = this.modoEdicion ? 'actualizarCliente' : 'guardarNuevoCliente'; google.script.run.withSuccessHandler(()=>{this.cargando=false; this.modalCli.hide(); this.cargarDatosIniciales();})[f](this.formCliente); },
            eliminarCliente(item) { if(!confirm("驴Borrar?")) return; this.cargando=true; google.script.run.withSuccessHandler(r => { this.cargando=false; if(r.error) alert(r.error); else this.cargarDatosIniciales(); }).eliminarCliente(item.id_cliente); },

            abrirModalProveedor(item) { this.modoEdicion=!!item; this.formProveedor = item ? JSON.parse(JSON.stringify(item)) : { razon_social:'', doc_identidad:'', datos_adicionales:{} }; if(!this.formProveedor.datos_adicionales) this.formProveedor.datos_adicionales={}; this.modalProv.show(); },
            guardarProveedor() { this.cargando=true; const f = this.modoEdicion ? 'actualizarProveedor' : 'guardarNuevoProveedor'; google.script.run.withSuccessHandler(()=>{this.cargando=false; this.modalProv.hide(); this.cargarDatosIniciales();}).withUserObject(this)[f](this.formProveedor); },
            eliminarProveedor(item) { if(!confirm("驴Borrar?")) return; this.cargando=true; google.script.run.withSuccessHandler(r => { this.cargando=false; if(r.success) this.cargarDatosIniciales(); else alert(r.error); }).eliminarProveedor(item.id_proveedor); },

            manejarArchivo(e) { const f = e.target.files[0]; if(!f) return; this.archivoParaSubir = f; const r = new FileReader(); r.onload = (e) => { this.imagenPreview = e.target.result; }; r.readAsDataURL(f); },
            abrirModalProducto(item) {
                this.modoEdicion = !!item;
                this.archivoParaSubir = null;
                this.imagenPreview = null;
                
                if (item) {
                    // MODO EDICIN: Copiamos el item
                    this.formProducto = JSON.parse(JSON.stringify(item));
                    
                    // CORRECCIN IMPORTANTE: Si es un producto viejo sin datos de IVA, poner defaults
                    if (this.formProducto.impuesto_iva === undefined) this.formProducto.impuesto_iva = 10;
                    if (!this.formProducto.metodo_iva) this.formProducto.metodo_iva = 'INCLUIDO';
                    
                    // Cargar previsualizaci贸n de imagen si existe
                    if (this.formProducto.url_imagen) this.imagenPreview = this.formProducto.url_imagen;
                } else {
                    // MODO NUEVO
                    this.formProducto = { 
                        nombre: '', sku: '', precio_venta_base: 0, 
                        impuesto_iva: 10, metodo_iva: 'INCLUIDO', // Defaults
                        datos_adicionales: {} 
                    };
                }

                // Asegurar que datos_adicionales exista
                if (!this.formProducto.datos_adicionales) this.formProducto.datos_adicionales = {};
                
                this.modalProd.show();
            },
            async procesarGuardadoProducto() {
                // Validaci贸n b谩sica HTML5 (por si el navegador no la atrapa)
                if (!this.formProducto.nombre || !this.formProducto.sku || !this.formProducto.precio_venta_base) {
                    return alert("Por favor completa los campos obligatorios.");
                }

                this.cargando = true;

                // Subida de imagen (si aplica)
                if (this.archivoParaSubir) {
                    try {
                        this.formProducto.url_imagen = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = e => {
                                google.script.run
                                    .withSuccessHandler(url => resolve(url))
                                    .withFailureHandler(err => reject(err))
                                    .subirImagenDrive(e.target.result.split(',')[1], this.archivoParaSubir.name, this.archivoParaSubir.type);
                            };
                            reader.onerror = error => reject(error);
                            reader.readAsDataURL(this.archivoParaSubir);
                        });
                    } catch (e) {
                        this.cargando = false;
                        return alert("Error subiendo imagen: " + e);
                    }
                }

                const funcionBackend = this.modoEdicion ? 'actualizarProducto' : 'guardarNuevoProducto';

                //  1. TRUCO DE MAGIA: Convertimos el objeto Vue a un objeto puro de Javascript
                // Esto elimina los "Proxies" que bloquean a Google Script
                const productoLimpio = JSON.parse(JSON.stringify(this.formProducto));

                console.log("Enviando al servidor:", productoLimpio); // M铆ralo en la consola para asegurar

                google.script.run
                    .withSuccessHandler((res) => {
                        this.cargando = false;
                        if (res && res.error) {
                            alert("Error del sistema: " + res.error);
                        } else {
                            this.modalProd.hide();
                            this.cargarDatosIniciales();
                            alert(" Producto guardado correctamente");
                        }
                    })
                    .withFailureHandler(error => {
                        this.cargando = false;
                        alert(" Error CRTICO: " + error);
                    })
                    [funcionBackend](productoLimpio); // <--- Enviamos la copia limpia
            },
            eliminarProducto(item) { if(!confirm("驴Borrar?")) return; this.cargando=true; google.script.run.withSuccessHandler(r => { this.cargando=false; if(r.success) this.cargarDatosIniciales(); else alert(r.error); }).eliminarProducto(item.id_producto); },

            // TRANSACCIONES
            alSeleccionarProductoVenta() { 
                const p = this.productos.find(x => x.id_producto == this.lineaVenta.id_producto); 
                if(p) {
                    // CLCULO DE PRECIO AUTOMTICO
                    let precioFinal = Number(p.precio_venta_base);
                    
                    // Si el producto es "IVA EXCLUIDO", le sumamos el impuesto para cobrarle al cliente
                    if (p.metodo_iva === 'EXCLUIDO') {
                        precioFinal = precioFinal * (1 + (Number(p.impuesto_iva) / 100));
                    }
                    
                    this.lineaVenta.precio = precioFinal; // Precio unitario final a cobrar
                } 
            },

            agregarAlCarritoVenta() { 
                const p = this.productos.find(x => x.id_producto == this.lineaVenta.id_producto); 
                if(!p || this.lineaVenta.cantidad > p.stock_actual) return alert("Stock insuficiente"); 
                
                this.carritoVenta.push({
                    ...this.lineaVenta,
                    precio_final: this.lineaVenta.precio, // Precio cobrado
                    tasa_iva: p.impuesto_iva || 10,       // Guardamos la tasa para calcular totales luego
                    nombre_prod: p.nombre                 // til para ticket
                });
                
                this.lineaVenta={id_producto:'', cantidad:1, precio:0}; 
            },
            quitarDelCarritoVenta(i) { this.carritoVenta.splice(i,1); },
            limpiarCarritoVenta() { this.carritoVenta=[]; this.formVenta={id_cliente:'', fecha: new Date().toISOString().slice(0,10), nro_factura: ''}; },

            guardarVentaFinal() {
                if(!this.formVenta.id_cliente) return alert("Selecciona Cliente");
                if(this.carritoVenta.length === 0) return alert("Carrito vac铆o");
                
                this.cargando = true;
                const total = this.carritoVenta.reduce((acc, item) => acc + (item.cantidad * item.precio), 0);
                const paquete = { 
                    id_cliente: this.formVenta.id_cliente, 
                    id_deposito: this.formVenta.id_deposito, 
                    fecha: this.formVenta.fecha, 
                    nro_factura: this.formVenta.nro_factura, 
                    condicion: this.formVenta.condicion,     
                    total: total, 
                    items: this.carritoVenta 
                };
                
                google.script.run.withSuccessHandler((res) => { 
                    this.cargando = false; 
                    
                    // L贸gica para abrir PDF
                    if(res.pdf_url) {
                        if(confirm(" Venta registrada.\n驴Deseas abrir la factura PDF ahora?")) {
                            window.open(res.pdf_url, '_blank');
                        }
                    } else {
                        alert("Venta registrada.");
                    }

                    this.carritoVenta = []; 
                    this.cargarDatosIniciales(); 
                })
                .withFailureHandler(err => { 
                    this.cargando = false; 
                    alert("Error: " + err); 
                })
                .guardarVenta(paquete);
            },
            verDetalleVenta(h) {
                console.log(" Buscando venta:", h.id_venta);
                this.itemsDetalle = []; // Limpiar lista
                this.modalDetalle.show();
                
                google.script.run
                    .withSuccessHandler(r => {
                        console.log(" Datos recibidos:", r);
                        if (!r || r.length === 0) {
                            // Mensaje visual si no hay datos
                            this.itemsDetalle = []; // Dejamos vac铆o para que el v-if del HTML muestre "No hay items"
                        } else {
                            this.itemsDetalle = r;
                        }
                    })
                    .withFailureHandler(e => {
                        alert("Error al cargar detalle: " + e);
                        this.itemsDetalle = [];
                    })
                    .obtenerDetalleVenta(h.id_venta);
            },
            cargarHistorialVentas() { this.subVistaVentas='historial'; this.cargando=true; google.script.run.withSuccessHandler(r=>{this.historialVentas=r||[]; this.cargando=false;}).obtenerHistorialVentas(); },
            anularVenta(h) { if(!confirm("驴Anular?")) return; this.cargando=true; google.script.run.withSuccessHandler(()=>{this.cargando=false; alert("Anulada"); this.cargarHistorialVentas(); this.cargarDatosIniciales();}).anularVenta(h.id_venta); },
            agregarAlCarrito() { this.carritoCompra.push({...this.lineaTemp}); this.lineaTemp={id_producto:'', cantidad:'', costo:''}; },
            quitarDelCarrito(i) { this.carritoCompra.splice(i,1); },
            limpiarCarrito() { this.carritoCompra=[]; this.formCompra={id_proveedor:'', fecha: new Date().toISOString().slice(0,10), comprobante: ''}; },

            guardarCompraFinal() { 
                if(!this.formCompra.id_proveedor || this.carritoCompra.length===0) return alert("Datos incompletos");
                this.cargando=true; 
                const total = this.carritoCompra.reduce((acc, i) => acc + (i.cantidad * i.costo), 0); 
                const pkg = { ...this.formCompra, total, items: this.carritoCompra }; 
                
                google.script.run.withSuccessHandler((res)=>{
                    this.cargando=false; 
                    
                    // L贸gica PDF
                    if(res.pdf_url) {
                        if(confirm(" Compra registrada.\n驴Ver Orden de Compra PDF?")) {
                            window.open(res.pdf_url, '_blank');
                        }
                    } else {
                        alert("Compra registrada.");
                    }

                    this.limpiarCarrito(); 
                    this.cargarDatosIniciales();
                })
                .withFailureHandler(e=>{
                    this.cargando=false; 
                    alert(e);
                })
                .guardarCompraCompleta(pkg); 
            },
            verDetalleCompra(h) {
                console.log(" Buscando compra:", h.id_compra);
                this.itemsDetalle = []; 
                this.modalDetalle.show(); 
                
                google.script.run
                    .withSuccessHandler(r => {
                        console.log(" Datos recibidos:", r);
                        this.itemsDetalle = r || [];
                    })
                    .withFailureHandler(e => {
                        alert("Error al cargar detalle: " + e);
                    })
                    .obtenerDetalleCompra(h.id_compra);
            },
            cargarHistorial() { this.subVistaCompras='historial'; this.cargando=true; google.script.run.withSuccessHandler(r=>{this.historialCompras=r||[]; this.cargando=false;}).obtenerHistorialCompras(); },
            anularCompra(h) { if(!confirm("驴Anular?")) return; this.cargando=true; google.script.run.withSuccessHandler(()=>{this.cargando=false; alert("Anulada"); this.cargarHistorial(); this.cargarDatosIniciales();}).anularCompra(h.id_compra); }
        }
      }).mount('#app');
    </script>
</body>
</html>