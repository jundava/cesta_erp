<!DOCTYPE html>
<html lang="es">
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Cesta App</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
      /* =========================================
         üé® PALETA DE COLORES CESTA
         Colores extra√≠dos del Logo oficial
      ========================================= */
      :root {
          /* Naranja Terracota (Del logo) */
          --color-primary: #E06920; 
          
          /* Un tono m√°s oscuro para efectos Hover */
          --color-primary-hover: #BF5210;
          
          --bg-light-tone: #f8f9fa;
          --text-dark: #333333;
      }

      body { 
          background-color: var(--bg-light-tone); 
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
      }

      /* CLASES DE UTILIDAD PERSONALIZADAS (Reemplazan a las de Bootstrap est√°ndar) */
      .bg-brand { background-color: var(--color-primary) !important; }
      .text-brand { color: var(--color-primary) !important; }
      .border-brand { border-color: var(--color-primary) !important; }
      
      /* Botones S√≥lidos */
      .btn-brand {
          background-color: var(--color-primary);
          border-color: var(--color-primary);
          color: white;
      }
      .btn-brand:hover {
          background-color: var(--color-primary-hover);
          border-color: var(--color-primary-hover);
          color: white;
      }
      
      /* Botones Bordeados */
      .btn-outline-brand {
          color: var(--color-primary);
          border-color: var(--color-primary);
      }
      .btn-outline-brand:hover {
          background-color: var(--color-primary);
          color: white;
      }

      /* Enlaces Activos del Men√∫ */
      .nav-link-desktop.active {
          background-color: var(--color-primary) !important;
          color: white !important;
          box-shadow: 0 4px 6px rgba(224, 105, 32, 0.2); /* Sombra naranja suave */
      }
      .nav-link-desktop:hover { color: var(--color-primary); }
      
      .nav-item-mobile.active { color: var(--color-primary); }

      /* LOGO */
      .logo-img {
          height: 40px; /* Tama√±o del logo en la barra */
          width: auto;
          object-fit: contain;
          border-radius: 4px;
          background: white; /* Fondo blanco para resaltar el logo transparente */
          padding: 2px;
      }

      /* ESTILOS BASE (Mantenidos) */
      .sidebar { min-height: 100vh; background-color: #ffffff; border-right: 1px solid #dee2e6; }
      .nav-link-desktop { color: #333; cursor: pointer; padding: 12px 15px; border-radius: 8px; margin-bottom: 5px; transition: all 0.2s; display: block; text-decoration: none; }
      .nav-link-desktop:hover { background-color: #fff4e6; /* Fondo naranja muy suave al pasar mouse */ color: var(--color-primary); }
      
      .bottom-nav { background-color: white; border-top: 1px solid #dee2e6; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
      .nav-item-mobile { flex: 1; text-align: center; padding: 8px 0; color: #adb5bd; cursor: pointer; text-decoration: none; font-size: 0.7rem; font-weight: 500; transition: color 0.2s; }
      .nav-item-mobile i { display: block; font-size: 1.4rem; margin-bottom: 2px; line-height: 1; }
      .nav-item-mobile.active i { transform: scale(1.1); transition: transform 0.2s; }

      @media (max-width: 767.98px) { .main-content { padding-bottom: 90px !important; } }

      .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction: column; }
      
      .img-producto-card { 
          height: 180px; 
          width: 100%; 
          background-color: #ffffff; 
          display: flex; 
          align-items: center; 
          justify-content: center; 
          border-bottom: 1px solid #f0f0f0; 
          position: relative; 
      }
      .img-producto-card img { width: 100%; height: 100%; object-fit: contain; padding: 15px; }
      
      .card { transition: transform 0.2s; border: none; }
      .card:hover { transform: translateY(-3px); }
      
      .img-preview-modal { max-height: 200px; object-fit: contain; border: 2px dashed #dee2e6; padding: 10px; width: 100%; border-radius: 8px; background: #fff; }
    </style>
</head>
<body>
    <div id="app">
      
      <div v-if="cargando" class="loading-overlay">
        <div class="spinner-border text-brand mb-2" role="status" style="width: 3rem; height: 3rem;"></div>
        <div class="text-muted fw-bold">Cargando...</div>
      </div>

      <nav class="navbar navbar-dark bg-brand shadow sticky-top z-3">
        <div class="container-fluid d-flex justify-content-between align-items-center">
          <a class="navbar-brand fw-bold d-flex align-items-center gap-2" href="#">
            <img src="https://drive.google.com/thumbnail?id=15DzlDGz-7Wr1Z0kLAHqBuKSX6QIyvuBf&sz=w700" 
                 alt="CESTA Logo" 
                 class="logo-img">
            <span>CESTA Control de Stock </span>
          </a>

          <div class="d-flex align-items-center text-white">
            <div class="d-none d-sm-block text-end me-2 line-height-1">
              <small class="d-block opacity-75">Hola,</small>
              <span class="fw-bold">Admin</span>
            </div>
            <div class="bg-white text-brand rounded-circle d-flex align-items-center justify-content-center fw-bold shadow-sm" style="width: 35px; height: 35px;">
              A
            </div>
          </div>
        </div>
      </nav>

      <div class="container-fluid">
        <div class="row">
            
            <div class="col-md-2 sidebar p-3 d-none d-md-block shadow-sm z-2">
                <small class="text-muted text-uppercase fw-bold ps-3 mb-2 d-block" style="font-size: 0.75rem; letter-spacing: 1px;">Men√∫</small>
                <ul class="nav flex-column gap-1">
                    <li class="nav-item">
                        <a class="nav-link-desktop" :class="{active: vistaActual === 'productos'}" @click="cambiarVista('productos')">
                            <i class="bi bi-box-seam me-2"></i> Inventario
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link-desktop" :class="{active: vistaActual === 'proveedores'}" @click="cambiarVista('proveedores')">
                            <i class="bi bi-truck me-2"></i> Proveedores
                        </a>
                    </li>
                    <li class="nav-item mt-3 border-top pt-2">
                         <a class="nav-link-desktop text-danger" href="#"><i class="bi bi-box-arrow-left me-2"></i> Salir</a>
                    </li>
                </ul>
            </div>

            <div class="col-md-10 p-4 bg-light min-vh-100 main-content">
                
                <div v-if="vistaActual === 'productos'">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                        <div>
                            <h3 class="fw-bold mb-0 text-dark">Inventario</h3>
                            <small class="text-muted">{{ productos.length }} productos activos</small>
                        </div>
                        <button class="btn btn-brand shadow-sm w-100 w-md-auto" @click="abrirModalProducto(null)">
                            <i class="bi bi-plus-lg me-1"></i> Nuevo Producto
                        </button>
                    </div>

                    <div class="row g-3">
                        <div class="col-12 col-sm-6 col-lg-3" v-for="item in productos" :key="item.id_producto"> 
                            <div class="card h-100 shadow-sm overflow-hidden">
                                <div class="img-producto-card">
                                    <img v-if="item.url_imagen" :src="item.url_imagen" alt="Producto">
                                    <i v-else class="bi bi-camera-fill fs-1 text-muted opacity-25"></i>
                                    <span class="position-absolute top-0 end-0 m-2 badge bg-brand bg-opacity-75 rounded-pill small">
                                        {{ obtenerNombreCategoria(item.id_categoria) }}
                                    </span>
                                </div>
                                <div class="card-body d-flex flex-column">
                                    <div class="mb-2">
                                        <h6 class="card-title fw-bold text-truncate mb-0" :title="item.nombre">{{ item.nombre }}</h6>
                                        <small class="text-muted" style="font-size: 0.8rem;">SKU: {{ item.sku }}</small>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-end mt-auto">
                                        <div>
                                             <div class="text-brand fw-bold fs-4 line-height-1">${{ item.precio_venta_base }}</div>
                                             <small class="text-muted" style="font-size: 0.75rem;">x {{ item.unidad_medida }}</small>
                                        </div>
                                    </div>
                                    <div v-if="tieneDatosValidos(item)" class="mt-3">
                                        <a class="text-decoration-none small text-brand fw-bold d-flex align-items-center gap-1" 
                                           data-bs-toggle="collapse" :href="'#collapse' + item.id_producto">
                                            <i class="bi bi-info-circle"></i> Ver detalles
                                        </a>
                                        <div class="collapse mt-2" :id="'collapse' + item.id_producto">
                                            <div class="bg-light p-2 rounded small border">
                                                <div v-for="(val, key) in item.datos_adicionales">
                                                    <div v-if="val && val.toString().trim() !== ''" class="mb-1">
                                                        <span class="fw-bold text-dark">{{ obtenerEtiquetaCampo(key) }}:</span> 
                                                        <span class="text-secondary">{{ val }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2 mt-3 pt-3 border-top">
                                        <button class="btn btn-sm btn-outline-brand flex-grow-1" @click="abrirModalProducto(item)"><i class="bi bi-pencil"></i> Editar</button>
                                        <button class="btn btn-sm btn-outline-danger" @click="eliminarProducto(item)"><i class="bi bi-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="vistaActual === 'proveedores'">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                        <h3 class="fw-bold">Proveedores</h3>
                        <button class="btn btn-brand shadow-sm w-100 w-md-auto" @click="abrirModalProveedor(null)">
                            <i class="bi bi-person-plus-fill me-1"></i> Nuevo Proveedor
                        </button>
                    </div>
                     <div class="card shadow-sm border-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" style="min-width: 600px;">
                                <thead class="table-light">
                                    <tr><th class="ps-3">Empresa</th><th>Documento</th><th>Contacto</th><th>Info Extra</th><th class="text-end pe-3">Acciones</th></tr>
                                </thead>
                                <tbody>
                                    <tr v-for="prov in proveedores" :key="prov.id_proveedor">
                                        <td class="ps-3 fw-bold text-brand">{{ prov.razon_social }}</td>
                                        <td><span class="badge bg-light text-dark border">{{ prov.doc_identidad }}</span></td>
                                        <td>{{ prov.contacto }}</td>
                                        <td class="small text-muted">
                                            <div v-for="(val, key) in prov.datos_adicionales"><span v-if="val" class="d-block">‚Ä¢ <strong>{{ key }}:</strong> {{ val }}</span></div>
                                        </td>
                                        <td class="text-end pe-3">
                                            <button class="btn btn-sm btn-light text-brand border me-1" @click="abrirModalProveedor(prov)"><i class="bi bi-pencil"></i></button>
                                            <button class="btn btn-sm btn-light text-danger border" @click="eliminarProveedor(prov)"><i class="bi bi-trash"></i></button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div v-if="proveedores.length === 0" class="p-5 text-center text-muted">No hay proveedores registrados.</div>
                        </div>
                    </div>
                </div>
                
                <div v-if="vistaActual === 'perfil'">
                     <div class="alert alert-info">Configuraci√≥n de usuario.</div>
                </div>

            </div>
        </div>
      </div>
      
      <nav class="fixed-bottom bottom-nav d-md-none z-3">
          <div class="d-flex justify-content-around">
              <a class="nav-item-mobile" :class="{active: vistaActual === 'productos'}" @click="cambiarVista('productos')">
                  <i class="bi bi-box-seam"></i>
                  <span>Inventario</span>
              </a>
              <a class="nav-item-mobile" :class="{active: vistaActual === 'proveedores'}" @click="cambiarVista('proveedores')">
                  <i class="bi bi-truck"></i>
                  <span>Proveedores</span>
              </a>
              <a class="nav-item-mobile" :class="{active: vistaActual === 'perfil'}" @click="cambiarVista('perfil')">
                  <i class="bi bi-person-circle"></i>
                  <span>Perfil</span>
              </a>
          </div>
      </nav>

      <div class="modal fade" id="modalProducto" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header bg-brand text-white">
              <h5 class="modal-title">{{ modoEdicion ? 'Editar' : 'Nuevo' }} Producto</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <form @submit.prevent="procesarGuardadoProducto">
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body">
                            <h6 class="card-title fw-bold text-muted small text-uppercase mb-3">Imagen</h6>
                            <div class="row align-items-center">
                                <div class="col-md-4 text-center mb-3 mb-md-0">
                                    <div class="border rounded bg-white p-2 d-flex align-items-center justify-content-center" style="height: 150px;">
                                        <img v-if="imagenPreview" :src="imagenPreview" class="img-fluid" style="max-height: 100%; object-fit: contain;">
                                        <div v-else class="text-center text-muted"><i class="bi bi-image fs-1"></i><br><small>Sin imagen</small></div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label fw-bold">Subir archivo</label>
                                    <input type="file" class="form-control" accept="image/*" @change="manejarArchivo">
                                    <div class="form-text small mt-2">Se guardar√° en Drive "Cesta_Imagenes"</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body">
                            <h6 class="card-title fw-bold text-muted small text-uppercase mb-3">B√°sicos</h6>
                            <div class="row g-3">
                                <div class="col-12"><label class="form-label">Nombre <span class="text-danger">*</span></label><input type="text" class="form-control" v-model="formProducto.nombre" required></div>
                                <div class="col-6 col-md-4"><label class="form-label">SKU <span class="text-danger">*</span></label><input type="text" class="form-control" v-model="formProducto.sku" required></div>
                                <div class="col-6 col-md-4"><label class="form-label">Precio <span class="text-danger">*</span></label><div class="input-group"><span class="input-group-text bg-white">$</span><input type="number" class="form-control fw-bold text-brand" v-model="formProducto.precio_venta_base" required></div></div>
                                <div class="col-12 col-md-4"><label class="form-label">Stock M√≠n.</label><input type="number" class="form-control" v-model="formProducto.stock_minimo"></div>
                            </div>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body">
                            <h6 class="card-title fw-bold text-muted small text-uppercase mb-3">Clasificaci√≥n</h6>
                            <div class="row g-3">
                                <div class="col-md-6"><label class="form-label">Categor√≠a</label><select class="form-select" v-model="formProducto.id_categoria" required><option v-for="c in listaCategorias" :value="c.id_categoria">{{c.nombre}}</option></select></div>
                                <div class="col-md-6"><label class="form-label">Unidad</label><select class="form-select" v-model="formProducto.unidad_medida" required><option v-for="u in listaUnidades" :value="u.nombre">{{u.nombre}}</option></select></div>
                            </div>
                        </div>
                    </div>

                    <div v-if="camposExtraProducto.length > 0" class="card border-0 shadow-sm mb-3">
                        <div class="card-body">
                            <h6 class="card-title fw-bold text-muted small text-uppercase mb-3">Campos Extra</h6>
                            <div class="row g-3">
                                <div class="col-md-6" v-for="campo in camposExtraProducto" :key="campo.id_campo">
                                    <label class="form-label small fw-bold mb-1">{{ campo.etiqueta_visible }} <span v-if="esObligatorio(campo.es_obligatorio)" class="text-danger">*</span></label>
                                    <select v-if="campo.tipo_dato === 'select'" class="form-select" v-model="formProducto.datos_adicionales[campo.key_interno]" :required="esObligatorio(campo.es_obligatorio)">
                                        <option value="">...</option><option v-for="op in campo.opciones_lista.split(',')" :value="op.trim()">{{ op.trim() }}</option>
                                    </select>
                                    <input v-else :type="campo.tipo_dato" class="form-control" v-model="formProducto.datos_adicionales[campo.key_interno]" :required="esObligatorio(campo.es_obligatorio)">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end pt-2"><button type="button" class="btn btn-secondary me-md-2" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-brand fw-bold px-4">Guardar</button></div>
                </form>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal fade" id="modalProveedor" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-brand text-white">
              <h5 class="modal-title">{{ modoEdicion ? 'Editar' : 'Nuevo' }} Proveedor</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <form @submit.prevent="guardarProveedor">
                    <div class="card border-0 shadow-sm mb-3"><div class="card-body">
                        <div class="mb-3"><label class="form-label fw-bold">Raz√≥n Social <span class="text-danger">*</span></label><input type="text" class="form-control" v-model="formProveedor.razon_social" required></div>
                        <div class="row mb-3">
                            <div class="col-6"><label class="form-label fw-bold">Documento</label><input type="text" class="form-control" v-model="formProveedor.doc_identidad" required></div>
                            <div class="col-6"><label class="form-label fw-bold">Contacto</label><input type="text" class="form-control" v-model="formProveedor.contacto"></div>
                        </div>
                    </div></div>
                    <div v-if="camposExtraProveedor.length > 0" class="card border-0 shadow-sm mb-3"><div class="card-body">
                        <div class="row g-2"><div class="col-12" v-for="campo in camposExtraProveedor" :key="campo.id_campo">
                            <label class="form-label small mb-1">{{ campo.etiqueta_visible }} <span v-if="esObligatorio(campo.es_obligatorio)" class="text-danger">*</span></label>
                            <select v-if="campo.tipo_dato === 'select'" class="form-select form-select-sm" v-model="formProveedor.datos_adicionales[campo.key_interno]" :required="esObligatorio(campo.es_obligatorio)"><option value="">...</option><option v-for="op in campo.opciones_lista.split(',')" :value="op.trim()">{{ op.trim() }}</option></select>
                            <input v-else :type="campo.tipo_dato" class="form-control form-control-sm" v-model="formProveedor.datos_adicionales[campo.key_interno]" :required="esObligatorio(campo.es_obligatorio)">
                        </div></div>
                    </div></div>
                    <div class="d-grid gap-2"><button type="submit" class="btn btn-brand fw-bold">Guardar</button></div>
                </form>
            </div>
          </div>
        </div>
      </div>

    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const { createApp } = Vue;
      createApp({
        data() {
          return {
            cargando: false, vistaActual: 'productos', modoEdicion: false,
            productos: [], proveedores: [], listaCategorias: [], listaUnidades: [], listaConfigCampos: [],
            modalProd: null, modalProv: null, archivoParaSubir: null, imagenPreview: null,
            formProducto: { nombre: '', sku: '', precio_venta_base: 0, id_categoria: '', unidad_medida: '', stock_minimo: 5, impuesto_iva: 10, maneja_stock: true, datos_adicionales: {}, url_imagen: '' },
            formProveedor: { razon_social: '', doc_identidad: '', contacto: '', datos_adicionales: {} }
          }
        },
        computed: {
            camposExtraProducto() { return this.listaConfigCampos.filter(c => c.entidad_objetivo && c.entidad_objetivo.toLowerCase() === 'producto'); },
            camposExtraProveedor() { return this.listaConfigCampos.filter(c => c.entidad_objetivo && c.entidad_objetivo.toLowerCase() === 'proveedor'); }
        },
        mounted() {
            this.modalProd = new bootstrap.Modal(document.getElementById('modalProducto'));
            this.modalProv = new bootstrap.Modal(document.getElementById('modalProveedor'));
            this.cargarDatosIniciales();
        },
        methods: {
            cambiarVista(vista) { this.vistaActual = vista; window.scrollTo(0,0); },
            cargarDatosIniciales() {
                this.cargando = true;
                Promise.all([this.pedirDatos('PRODUCTOS'), this.pedirDatos('PROVEEDORES'), this.pedirDatos('CATEGORIAS'), this.pedirDatos('UNIDADES'), this.pedirDatos('CONFIG_CAMPOS')])
                .then(res => { this.productos = res[0]; this.proveedores = res[1]; this.listaCategorias = res[2]; this.listaUnidades = res[3]; this.listaConfigCampos = res[4]; this.cargando = false; });
            },
            pedirDatos(hoja) { return new Promise((resolve, reject) => { google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getData(hoja); }); },
            esObligatorio(val) { return val === true || val === 'TRUE'; },
            obtenerNombreCategoria(id) { const c = this.listaCategorias.find(x => x.id_categoria == id); return c ? c.nombre : '...'; },
            obtenerEtiquetaCampo(key) { const c = this.listaConfigCampos.find(x => x.key_interno === key); return c ? c.etiqueta_visible : key; },
            tieneDatosValidos(item) { if (!item.datos_adicionales) return false; return Object.values(item.datos_adicionales).some(val => val && val.toString().trim() !== ''); },
            manejarArchivo(event) { const archivo = event.target.files[0]; if (!archivo) return; this.archivoParaSubir = archivo; const reader = new FileReader(); reader.onload = (e) => { this.imagenPreview = e.target.result; }; reader.readAsDataURL(archivo); },
            abrirModalProducto(item) {
                this.modoEdicion = !!item; this.archivoParaSubir = null; this.imagenPreview = null;
                const fileInput = document.querySelector('input[type="file"]'); if(fileInput) fileInput.value = '';
                if (item) { this.formProducto = JSON.parse(JSON.stringify(item)); if (!this.formProducto.datos_adicionales) this.formProducto.datos_adicionales = {}; if (this.formProducto.url_imagen) this.imagenPreview = this.formProducto.url_imagen; } 
                else { this.formProducto = { nombre: '', sku: '', precio_venta_base: 0, id_categoria: '', unidad_medida: '', stock_minimo: 5, impuesto_iva: 10, maneja_stock: true, datos_adicionales: {}, url_imagen: '' }; }
                this.modalProd.show();
            },
            async procesarGuardadoProducto() {
                this.cargando = true;
                try {
                    if (this.archivoParaSubir) { const urlDrive = await this.subirArchivoPromise(this.archivoParaSubir); this.formProducto.url_imagen = urlDrive; }
                    const datos = JSON.parse(JSON.stringify(this.formProducto)); const funcion = this.modoEdicion ? 'actualizarProducto' : 'guardarNuevoProducto';
                    google.script.run.withSuccessHandler(() => { this.cargando = false; this.modalProd.hide(); this.cargarDatosIniciales(); }).withFailureHandler(err => { this.cargando = false; alert("Error: " + err); })[funcion](datos);
                } catch (error) { this.cargando = false; alert("Error: " + error); }
            },
            subirArchivoPromise(archivo) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = function(e) { const rawBase64 = e.target.result.split(',')[1]; google.script.run.withSuccessHandler(url => resolve(url)).withFailureHandler(err => reject(err)).subirImagenDrive(rawBase64, archivo.name, archivo.type); }; reader.readAsDataURL(archivo); }); },
            eliminarProducto(item) { if(!confirm('¬øEliminar?')) return; this.cargando = true; google.script.run.withSuccessHandler(res => { this.cargando = false; res.success ? this.cargarDatosIniciales() : alert(res.error); }).eliminarProducto(item.id_producto); },
            abrirModalProveedor(item) { this.modoEdicion = !!item; if (item) { this.formProveedor = JSON.parse(JSON.stringify(item)); if (!this.formProveedor.datos_adicionales) this.formProveedor.datos_adicionales = {}; } else { this.formProveedor = { razon_social: '', doc_identidad: '', contacto: '', datos_adicionales: {} }; } this.modalProv.show(); },
            guardarProveedor() { this.cargando = true; const datos = JSON.parse(JSON.stringify(this.formProveedor)); const funcion = this.modoEdicion ? 'actualizarProveedor' : 'guardarNuevoProveedor'; google.script.run.withSuccessHandler(() => { this.cargando = false; this.modalProv.hide(); this.cargarDatosIniciales(); }).withFailureHandler(alert).withUserObject(this)[funcion](datos); },
            eliminarProveedor(item) { if(!confirm('¬øEliminar proveedor?')) return; this.cargando = true; google.script.run.withSuccessHandler(res => { this.cargando = false; res.success ? this.cargarDatosIniciales() : alert(res.error); }).eliminarProveedor(item.id_proveedor); }
        }
      }).mount('#app');
    </script>
</body>
</html>